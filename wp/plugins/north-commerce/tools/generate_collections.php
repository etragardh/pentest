<?php
/**
 * A PHP file for generating entity classes based on our schema.
 * This should be run anytime after changing the Schema.
 */

set_exception_handler( function( $ex ) {
	echo $ex;
	exit();
} );

use NorthCommerce\CodeGenerator;

require_once __DIR__ . '/wp_load.php';
require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-base.php';
require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-direct.php';

define( 'NC_COLLECTIONS_DIR', __DIR__ . '/../includes/db/collections' );

$fileSystemDirect = new WP_Filesystem_Direct(false);
$fileSystemDirect->rmdir(NC_COLLECTIONS_DIR, true);
$fileSystemDirect->mkdir(NC_COLLECTIONS_DIR);

$agent = North_Commerce_Db_Agent::instance();
$schema = $agent->schema();

$generator = new CodeGenerator();

foreach ( $schema->getTables() as $t_name => $t_info ) {

	$class_name = $agent->tableToClassName( $t_name );
	$cols_slug = $t_info['cols']['slug'] ?? null;
	$values = nc_g( $t_info, 'values', [] );

	if ( $cols_slug && $values ) {

		echo "Generating: $class_name\n";

		$create = [
			[
				'template' => 'db_collection',
				'class_name' => $class_name,
				'dir' => "includes/db/collections"
			],
			[
				'template' => 'db_collection_test',
				'class_name' => "{$class_name}Test",
				'dir' => "tests/includes/db/collections"
			]
		];

		foreach ( $create as $target ) {
			$generator->build( $target['template'], "{$target['dir']}/{$target['class_name']}.php", [
				'class_name' => $class_name,
				'table_name' => $t_name,
				'table_info' => $t_info
			] );
		}

	}

}
