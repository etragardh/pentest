<?php
/*
 * A PHP file for generating schema SQL
 */
require_once(__DIR__ . '/wp_load.php');
(php_sapi_name() == 'cli') || die("Must be run from the command line\n");
parse_str(implode('&', array_slice($argv, 1)), $args);
($prefix = nc_g($args, 'prefix')) || die("Must set db prefix\n");

$agent = North_Commerce_Db_Agent::instance();
$schema = $agent->schema();
$generator = $agent->generator();

foreach($schema->getTables() as $table_name => $table) {
	echo "-- Table: {$table_name}\n";
	$create_sql = $generator->createTableSql($prefix, $table_name, $table['cols']);
	echo $create_sql . "\n\n";
}

foreach($schema->getTables() as $table_name => $table) {
	$statements = $generator->finalizeTableSql($prefix, $table_name, $table['cols']);
	if($statements) {
		echo "-- Finalize: $table_name\n";
		echo implode("", $statements);
		echo "\n";
	}
}


foreach($schema->getTables() as $table_name => $table) {
	if(($values = nc_g($table, 'values'))) {
		echo "-- Data: $table_name\n";
		foreach($values as $row) {
			$insert_sql = $generator->insertRowSql($prefix, $table_name, $row);
			echo $insert_sql . "\n";
		}
	}
	echo "\n";
}
