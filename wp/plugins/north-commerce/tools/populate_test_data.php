<?php
/**
 * A PHP file for populating the database with test data
 *
 * @version 0.1.13
 */

use NorthCommerce\Db\Collections\CouponDiscountTypes;
use NorthCommerce\Db\Collections\ProductStatuses;
use NorthCommerce\Testing\EntityFactory;

require_once(__DIR__ . '/wp_load.php');
(php_sapi_name() == 'cli') || die("Must be run from the command line\n");
parse_str(implode('&', array_slice($argv, 1)), $args);


is_numeric($num_users = nc_g($args, 'num_users')) || die("Must set num_users (0 is OK)\n");
is_numeric($num_products = nc_g($args, 'num_products')) || die("Must set num_products (0 is OK)\n");
is_numeric($num_coupons = nc_g($args, 'num_coupons')) || die("Must set num_coupons (0 is OK)\n");



$ef = EntityFactory::instance();

$admin = $ef->anyWpAdmin();
wp_set_current_user($admin->ID);

for ( $i = 0; $i < $num_users; $i++ ) {
	$c = $ef->newCustomer();
	$wp_user = get_user_by('ID', $c['wp_user_id']);
	$password = get_user_meta($wp_user->ID, NORTH_COMMERCE_APP_PASSWORD_META, true);
	echo $wp_user->user_login . ":$password\n";
	for ( $j = 0; $j < 10; $j++ ) {
		$ef->newOrder( [ 'customer' => $c ] );
	}
}

$creator = $ef->newWpUser();

echo "Generating products\n";

for($i = 0; $i < $num_products; $i++) {
	$variants = $i % 2 == 0 ? 'auto' : false;
	echo esc_html( 'Generating product', 'north-commerce' ) . " {$i}\n";
	$c = $ef->newProduct([
		'created_by_wp_user_id' => $creator->ID,
		'variants' => $variants,
		'published' => date('Y-m-d H:i:00'),
		'product_status_id' => ProductStatuses::published()->id
	]);
	echo esc_html( 'Finished generating product', 'north-commerce' ) . " {$i}\n";
}

$coupon_types = [
	CouponDiscountTypes::fixed(),
	CouponDiscountTypes::percent(),
	CouponDiscountTypes::freeShipping(),
];

for($i = 0; $i < $num_coupons; $i++) {
	$ef->newCoupon([
		'coupon_discount_type' => $coupon_types[$i % count($coupon_types)]
	]);
}
