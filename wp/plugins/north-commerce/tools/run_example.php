<?php
/*
 * A PHP file for running an example. An example is a PHP file
 * that contains parameters to execute and display the values for
 */

use NorthCommerce\Testing\EntityFactory;

require_once(__DIR__ . '/wp_load.php');
(php_sapi_name() == 'cli') || die("Must be run from the command line\n");
(count($argv) > 1) || die("php -f {$argv[0]} <Example File>.php [parameter=value] ...\n");
$example_file = $argv[1];
(file_exists($example_file)) || die("Example File not found: [$example_file]\n");


$ef = new EntityFactory();
$ea = North_Commerce_Db_Entity_Access::instance();

parse_str(implode('&', array_slice($argv, 2)), $env);
require_once($example_file);

(isset($example)) || die("\$example is not defined in $example_file\n");
is_callable($example) || die("\$example is not a function that can be called.\n");

$inputs = isset($inputs) ? $inputs : [];
foreach($inputs as $input) {
	is_string(nc_g($env, $input)) || die("Input $input not defined on command line\n");
}

$args = array_merge([$ea],
					array_map(function($input) use($env) {
						return $env[$input];
					}, $inputs));

add_filter('nc_db_agent_prepare_sql', function($sql) {
	trace_sql($sql);
	return $sql;
});

start_sql_trace();
wp_set_current_user($ef->anyWpAdmin()->ID);

$results = call_user_func_array($example, $args);
echo json_encode($results, JSON_PRETTY_PRINT);

function trace_sql($sql) {
	if(file_exists("sql.trace")) {
		file_put_contents("sql.trace", "$sql\n", FILE_APPEND);
	}
}

function start_sql_trace() {
	$fd = fopen("sql.trace", "w");
	fclose($fd);
}
