<?php

defined( 'ABSPATH' ) || exit;

/**
 * Products list template
 *
 *
 * @package north-commerce/admin/templates/product
 * @link    https://northcommerce.com/
 * @since   0.1.0
 * @version 0.1.24
 */

$product_model = new \NorthCommerce\Models\ProductModel();

$current_page = sanitize_text_field( $_POST['paged'] ?? 1 );
$posts_per_page = sanitize_text_field( $_POST['posts_per_page'] ?? 10 );

$criteria['deleted'] = null;
$options = [
    'limit' => $posts_per_page,
    'offset' => $posts_per_page * ( $current_page - 1 ),
    'order_by' => 'created DESC',
    'expand' => [
        'product_type',
        'product_status',
        'product_images',
        'payment_detail',
        'payment_detail.payment_frequency'
    ]
];

$products_list = $product_model->list_all( $criteria, $options );
$products_total = $product_model->count();

$pagination_text = function () use ( $products_total, $options ) {
    if ( ! $products_total ) {
        return esc_html__( '0-0 of 0', 'north-commerce' );
    }
    $first = $options['offset'] + 1;
    $last = $products_total < $options['limit'] ? $products_total : $options['limit'];
    return $first . '-' . $last  . ' of ' . $products_total;
};

?>
<div class="north-tab-wrapper">
    <?php $this->plugin_tabs(); ?>
</div>
<?php do_action( 'north_commerce_notices' ); ?>
<div id="wpmdb-main">
    <div class="content-tab">
        <div class="settings-tab__head">
            <div class="head__wrapper">
                <h2><?php esc_html_e( 'Products', 'north-commerce' ); ?></h2>
                <p><?php esc_html_e( 'You can manage and customize your products.', 'north-commerce' ); ?></p>
            </div>
            <a
                href="<?php echo admin_url( 'admin.php?page=north-commerce-products&amp;action=add' ); ?>"
                class="btn submit-btn activate product-add">
                <?php esc_html_e( 'Add product', 'north-commerce' ); ?>
            </a>
        </div>
        <div class="settings-tab__body products">
            <div class="products__status">

                <a href="javascript:void(0);" class="status__filter status__filter-product active" data-status-filter="">
                    <?php esc_html_e( 'All', 'north-commerce' ); ?>
                    <span>
                        <?php echo esc_html( '(' . $products_total . ')' ); ?>
                    </span>
                </a>
                <?php

                foreach ( $product_model->list_statuses() as $status ) {
                    $status_counter = $product_model->count_by_status_name( $status['name'] );
                    ?>
                    <a
                        href="javascript:void(0);"
                        class="status__filter status__filter-product"
                        data-status-filter="<?php echo esc_attr( $status['slug'] ); ?>"
                        >
                        <?php echo esc_html( $status['name'] ); ?>
                        <span>
                            <?php echo esc_attr( '(' . $status_counter . ')' ); ?>
                        </span>
                    </a>
                    <?php
                }

                ?>
            </div>
            <div class="board products__board">
                <div class="board__header">
                    <form class="board__form board__form-products">
                        <a href="javascript:void(0);" class="filters__toggle">
                            <span><?php esc_html_e( 'Show filters', 'north-commerce' ); ?></span>
                        </a>
                        <div class="filters__body">
                            <div class="filter__item">
                                <label for="product-data-sort">
                                    <?php esc_html_e( 'Sort by', 'north-commerce' ); ?>
                                </label>
                                <select
                                    name="product-data-sort"
                                    class="north-single-select select2-hidden-accessible"
                                    data-dropdown-css-class="rounded"
                                    data-minimum-results-for-search="Infinity"
                                    id="product-data-sort"
                                    >
                                    <option value="DESC" checked>
                                        <?php esc_html_e( 'Newest to oldest', 'north-commerce' ); ?>
                                    </option>
                                    <option value="ASC">
                                        <?php esc_html_e( 'Oldest to newest', 'north-commerce' ); ?>
                                    </option>
                                </select>
                            </div>
                            <div class="filter__item">
                                <label for="product-price-sort">
                                    <?php esc_html_e( 'Price', 'north-commerce' ); ?>
                                </label>
                                <select
                                    name="product-price-sort"
                                    class="north-single-select select2-hidden-accessible"
                                    data-dropdown-css-class="rounded"
                                    data-minimum-results-for-search="Infinity"
                                    id="product-price-sort"
                                    >
                                    <option value="">
                                        <?php esc_html_e( 'None', 'north-commerce' ); ?>
                                    </option>
                                    <option value="ASC" checked>
                                        <?php esc_html_e( 'Lowest to highest', 'north-commerce' ); ?>
                                    </option>
                                    <option value="DESC">
                                        <?php esc_html_e( 'Highest to lowest', 'north-commerce' ); ?>
                                    </option>
                                </select>
                            </div>
                            <div class="filter__item">
                                <label for="product-inventory-sort">Inventory</label>
                                <select name="product-inventory-sort" class="north-single-select select2-hidden-accessible" data-dropdown-css-class="rounded" data-minimum-results-for-search="Infinity" id="product-inventory-sort">
                                    <option value="">None</option>
                                    <option value="Out" checked>Out of stock</option>
                                </select>
                            </div>
                            <div class="filter__item">
                                <label for="product-type-sort">Type</label>
                                <select name="product-type-sort" class="north-single-select select2-hidden-accessible" data-dropdown-css-class="rounded" data-minimum-results-for-search="Infinity" id="product-type-sort">
                                    <option value="">All</option>
                                    <option value="One Time" checked>One-time product</option>
                                    <option value="Subscription" checked>Subscription</option>
                                    <option value="Payment Plan" checked>Payment plan</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-wrapper">
                            <input type="submit" value="">
                            <input
                                name="product-name"
                                type="text"
                                placeholder="<?php esc_attr_e( 'Search by product name', 'north-commerce' ); ?>"
                                >
                        </div>
                    </form>
                    <div class="board__actions">
                        <div class="action__result">
                            <span>
                                <?php echo esc_html( $pagination_text() ); ?>
                            </span>
                        </div>
                        <div class="action__buttons">
                            <a class="btn btn-prev product-prev" href="javascript:void(0);"></a>
                            <a class="btn btn-next product-next" href="javascript:void(0);"></a>
                        </div>
                    </div>
                </div>
                <div class="board__result">
                    <div class="result__labels">
                        <div class="result-col-1">
                            <div class="result__select">
                                <label for="all"></label>
                                <input type="checkbox" name="all-product" id="all-product" />
                            </div>
                        </div>
                            <div class="bump">
                                <div class="bump__count-selecting">
                                    <p><?php esc_html_e( 'All selected', 'north-commerce' ); ?></p>
                                </div>
                                <div class="bump__action">
                                    <a href="#" class="action__trash product-bump-trash">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 7C5.447 7 5 7 5 7V20C5 21.104 5.896 22 7 22H17C18.104 22 19 21.104 19 20V7C19 7 18.553 7 18 7H6ZM10 19H8V10H10V19ZM16 19H14V10H16V19ZM16.618 4L15 2H9L7.382 4H3V6H8H16H21V4H16.618Z" fill="#747E94"></path>
                                        </svg>
                                        <div class="action__hint"><p><?php esc_html_e( 'Move to Trash', 'north-commerce' ); ?></p></div>
                                    </a>
                                    <a href="#" class="action__archive product-bump-archive">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18.0865 4.40817L15.589 1.91067C15.5118 1.83314 15.4199 1.77165 15.3188 1.72974C15.2177 1.68784 15.1093 1.66635 14.9998 1.6665H4.99984C4.89039 1.66635 4.78198 1.68784 4.68087 1.72974C4.57975 1.77165 4.48793 1.83314 4.41067 1.91067L1.91317 4.40817C1.83491 4.48536 1.77279 4.57735 1.73045 4.67879C1.6881 4.78023 1.66636 4.88908 1.6665 4.999V15.8332C1.6665 16.2752 1.8421 16.6991 2.15466 17.0117C2.46722 17.3242 2.89114 17.4998 3.33317 17.4998H16.6665C17.1085 17.4998 17.5325 17.3242 17.845 17.0117C18.1576 16.6991 18.3332 16.2752 18.3332 15.8332V4.999C18.3333 4.88908 18.3116 4.78023 18.2692 4.67879C18.2269 4.57735 18.1648 4.48536 18.0865 4.40817ZM5.34484 3.33317H14.6548L15.4882 4.1665H4.51151L5.34484 3.33317ZM14.1665 10.8332V11.6665H5.83317V8.33317H7.49984V9.99984H12.4998V8.33317H14.1665V10.8332Z" fill="#747E94"></path>
                                        </svg>
                                        <div class="action__hint"><p><?php esc_html_e( 'Archive', 'north-commerce' ); ?></p></div>
                                    </a>
                                    <a href="#" class="action__publish product-bump-publish">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18.0884 4.40984L15.5893 1.91067C15.512 1.83314 15.4202 1.77165 15.3191 1.72974C15.2179 1.68784 15.1095 1.66635 15.0001 1.6665H5.00008C4.89063 1.66635 4.78223 1.68784 4.68111 1.72974C4.58 1.77165 4.48817 1.83314 4.41092 1.91067L1.91175 4.40984C1.83389 4.48707 1.77214 4.57899 1.73008 4.68027C1.68803 4.78155 1.6665 4.89017 1.66675 4.99984V15.8332C1.66675 16.7523 2.41425 17.4998 3.33342 17.4998H16.6667C17.5859 17.4998 18.3334 16.7523 18.3334 15.8332V4.99984C18.3337 4.89017 18.3121 4.78155 18.2701 4.68027C18.228 4.57899 18.1663 4.48707 18.0884 4.40984ZM5.34508 3.33317H14.6551L15.4884 4.1665H4.51175L5.34508 3.33317ZM11.6668 11.6665V14.1665H8.33342V11.6665H5.83342L10.0001 7.49984L14.1668 11.6665H11.6668Z" fill="#747E94"></path>
                                        </svg>
                                        <div class="action__hint"><p><?php esc_html_e( 'Publish', 'north-commerce' ); ?></p></div>
                                    </a>
                                </div>
                            </div>

                        <div class="result-col-5"><?php esc_html_e( 'Product', 'north-commerce' ); ?></div>
                        <div class="result-col-2"><?php esc_html_e( 'Price', 'north-commerce' ); ?></div>
                        <div class="result-col-2"><?php esc_html_e( 'Inventory', 'north-commerce' ); ?></div>
                        <div class="result-col-3"><?php esc_html_e( 'Type', 'north-commerce' ); ?></div>
                        <div class="result-col-2"><?php esc_html_e( 'Status', 'north-commerce' ); ?></div>
                    </div>

                    <div
                        class="result__products"
                        data-current-page="<?php echo esc_attr( $current_page ); ?>"
                        data-max-page="<?php echo esc_attr( $products_total ); ?>"
                        >
                        <?php

                        foreach ( $products_list as $product ) {
                            $this->template( 'product-item', 'product', compact( 'product' ) );
                        }

                        ?>
                    </div>

                    <div class="board__overlay">
                        <div class="loader-spinner"></div>
                    </div>
                </div>
                <div class="board__footer">
                    <div class="board__actions">
                        <div class="action__result">
                            <span><?php echo esc_html( $pagination_text() ); ?></span>
                        </div>
                        <div class="action__buttons">
                            <a class="btn btn-prev product-prev" href="javascript:void(0);"></a>
                            <a class="btn btn-next product-next" href="javascript:void(0);"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
