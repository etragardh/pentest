<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\CouponCustomerEligibilities as CustomerEligibilities;
use NorthCommerce\Models\CustomerModel;

/**
 * Customers modal window
 *
 *
 * @package north-commerce/admin/templates/coupon/single
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.21
 * @version 0.1.21
 */


$customer_class = new CustomerModel();

$customer_new_eligibility = CustomerEligibilities::newCustomer()->slug;
// CustomerEligibilities::customerEmails()->slug;
$customer_ids_eligibility = CustomerEligibilities::northCommerceCustomerIds()->slug;
$customer_tags_eligibility = CustomerEligibilities::northCommerceCustomerTags()->slug;
$wp_users_eligibility = CustomerEligibilities::wordpressUsers()->slug;
$wp_roles_eligibility = CustomerEligibilities::wordpressRoles()->slug;

$render_customer_new_item = function ( $new_customer_checked_value ) use ( $customer_new_eligibility ) {
	?>
	<div
		class="list__item customer-new hide"
		data-level="<?php echo esc_attr( $customer_new_eligibility ); ?>"
	>
		<div class="item__wrapper">
			<div class="customer__checkbox">
				<input
					type="checkbox"
					class="north-checkbox__handler"
					name="applied_customer_new[]"
					id="customer-new"
					value="customer-new"
					<?php checked( $new_customer_checked_value[0]['customer_new'] ?? null ); ?>
				>
				<label class="north-checkbox" for="customer-new">
				</label>
			</div>

			<label class="name customer__name" for="customer-new">
				<?php esc_html_e( 'New Customer', 'north-commerce' ); ?>
			</label>
		</div>
	</div>
	<?php
};

$render_customer_id_items = function ( $nc_id_checked_values ) use ( $customer_class, $customer_ids_eligibility ) {
	$options = [
		'columns' => [
			'id',
			'customer_number',
			'first_name',
			'last_name',
			'email',
		],
		'expand' => '',
	];
	$customers_list = $customer_class->list_all( true, $options );
	foreach ( $customers_list as $customer ) {
		$id_attr = 'customer-' . $customer['id'];
		?>
		<div
			class="list__item customer-id"
			data-level="<?php echo esc_attr( $customer_ids_eligibility ); ?>"
		>
			<div class="item__wrapper">
				<div class="customer__checkbox">
					<input
						type="checkbox"
						class="north-checkbox__handler"
						name="applied_customer_ids[]"
						id="<?php echo esc_attr( $id_attr ); ?>"
						value="<?php echo esc_attr( $customer['id'] ); ?>"
						<?php checked( boolval( $nc_id_checked_values[ $customer['id'] ] ?? null ) ); ?>
					>
					<label
						class="north-checkbox"
						for="<?php echo esc_attr( $id_attr ); ?>"
					>
					</label>
				</div>

				<label
					class="name customer__name"
					for="<?php echo esc_attr( $id_attr ); ?>"
				>
					<?php
					echo esc_html(
						$customer['first_name']
						. ' '
						.  $customer['last_name']
					);
					?>
				</label>

				<label
					class="email customer__email"
					for="<?php echo esc_attr( $id_attr ); ?>"
				>
					<?php echo esc_html( $customer['email'] ); ?>
				</label>
			</div>
		</div>
		<?php
	}
};

$render_customer_tag_items = function ( $nc_tag_checked_values ) use ( $customer_class, $customer_tags_eligibility ) {
	$tags_list = $customer_class->list_tags();
	foreach ( $tags_list as $tag ) {
		$id_attr = 'customer-tag-' . $tag['id'];
		?>
		<div
			class="list__item customer-tag hide"
			data-level="<?php echo esc_attr( $customer_tags_eligibility ); ?>"
			>
			<div class="item__wrapper">
				<div class="customer__checkbox">
					<input
						type="checkbox"
						class="north-checkbox__handler"
						name="applied_customer_tags[]"
						id="<?php echo esc_attr( $id_attr ); ?>"
						value="<?php echo esc_attr( $tag['id'] ); ?>"
						<?php checked( boolval( $nc_tag_checked_values[ $tag['id'] ] ?? null ) ); ?>
					>
					<label
						class="north-checkbox"
						for="<?php echo esc_attr( $id_attr ); ?>"
					>
					</label>
				</div>

				<label
					class="name tag__name"
					for="<?php echo esc_attr( $id_attr ); ?>"
				>
					<?php
					echo esc_html( $tag['name'] );
					?>
				</label>
			</div>
		</div>
		<?php
	}
};

$render_wp_users = function ( $wp_user_checked_values ) use ( $wp_users_eligibility ) {
	foreach ( get_users() as $wp_user ) {
		$wp_user_id = $wp_user->ID ?? '';
		$user_id_attr = $wp_user_id ? 'wp-user-' . $wp_user_id : '';
		?>
		<div
			class="list__item wp-user hide"
			data-level="<?php echo esc_attr( $wp_users_eligibility ); ?>"
		>
			<div class="item__wrapper">
				<div class="customer__checkbox">
					<input
						type="checkbox"
						class="north-checkbox__handler"
						name="applied_customer_wp_users[]"
						id="<?php echo esc_attr( $user_id_attr ); ?>"
						value="<?php echo esc_attr( $wp_user_id ); ?>"
						<?php checked( boolval( $wp_user_checked_values[ $wp_user_id ] ?? null ) ); ?>
					>
					<label
						class="north-checkbox"
						for="<?php echo esc_attr( $user_id_attr ); ?>"
					>
					</label>
				</div>

				<label
					class="wp-user__id"
					for="<?php echo esc_attr( $user_id_attr ); ?>"
				>
					<?php
					echo esc_html( $wp_user_id );
					?>
				</label>

				<label
					class="name wp-user__name"
					for="<?php echo esc_attr( $user_id_attr ); ?>"
				>
					<?php
					echo esc_html( $wp_user->get( 'user_nicename' ) );
					?>
				</label>

				<label
					class="email wp-user__email"
					for="<?php echo esc_attr( $user_id_attr ); ?>"
				>
					<?php
					echo esc_html( $wp_user->get( 'user_email' ) );
					?>
				</label>
			</div>
		</div>
		<?php
	}
};

$render_wp_role_items = function ( $wp_role_checked_values ) use ( $wp_roles_eligibility ) {
	foreach ( wp_roles()->role_names as $role_slug => $role_name ) {
		?>
		<div
			class="list__item wp-role hide"
			data-level="<?php echo esc_attr( $wp_roles_eligibility ); ?>"
		>
			<div class="item__wrapper">
				<div class="customer__checkbox">
					<input
						type="checkbox"
						class="north-checkbox__handler"
						name="applied_customer_wp_roles[]"
						id="<?php echo esc_attr( 'wp-role-' . $role_slug ); ?>"
						value="<?php echo esc_attr( $role_slug ); ?>"
						<?php checked( boolval( $wp_role_checked_values[ $role_slug ] ?? null ) ); ?>
					>
					<label
						class="north-checkbox"
						for="<?php echo esc_attr( 'wp-role-' . $role_slug ); ?>"
					>
					</label>
				</div>

				<label
					class="name wp-role__name"
					for="<?php echo esc_attr( 'wp-role-' . $role_slug ); ?>"
				>
					<?php
					echo esc_html( $role_name );
					?>
				</label>
			</div>
		</div>
		<?php
	}
};

?>
<div class="nc-custom-popup" id="customers-modal">
	<form class="popup-new-customers admin-popup nc-custom-popup__window">
		<div class="admin-popup__header">
			<div class="admin-popup__left-side">
				<h3 class="integration-popup-name">
					<?php esc_html_e( 'Add customers', 'north-commerce' ); ?>
				</h3>
				<div class="loader"></div>
			</div>
			<a href="javascript:void(0);" data-nc-custom-popup-close class="admin-popup__close"></a>
		</div>

		<div class="admin-popup__body">

			<div class="admin-popup__notice"></div>

			<div class="admin-popup__content">

				<select
					class="north-single-select customers-eligibilities"
					data-minimum-results-for-search="Infinity"
					>
					<?php
					foreach ( $coupon_model->list_customers_eligibilities() as $eligibility ) {
						?>
						<option
							value="<?php echo esc_attr( $eligibility['slug'] ); ?>"
							<?php selected( $customer_ids_eligibility === $eligibility['slug'] ); ?>
						>
							<?php echo esc_html( $eligibility['name'] ); ?>
						</option>
						<?php
					}
					?>
				</select>

				<div class="search-input-wrapper">
					<input
						type="text"
						name="customer-filter-name"
						class="search-input customer-filter-name"
						id="customer-filter-name"
						placeholder="<?php esc_attr_e( 'Search by name or email', 'north-commerce' ); ?>"
					>
					<label for="customer-filter-name" class="search-icon">
					</label>
				</div>

				<div class="empty-list hide">
					<?php esc_html_e( 'No results for: ', 'north-commerce' ); ?>
					<span class="search-query"></span>
				</div>

				<div class="popup-list popup-customers-list">
					<?php
					$render_customer_new_item(
						$applied_customers[ $customer_new_eligibility ] ?? null
					);

					$render_customer_id_items(
						$applied_customers[ $customer_ids_eligibility ] ?? null
					);

					$render_customer_tag_items(
						$applied_customers[ $customer_tags_eligibility ] ?? null
					);

					$render_wp_users(
						$applied_customers[ $wp_users_eligibility ] ?? null
					);

					$render_wp_role_items(
						$applied_customers[ $wp_roles_eligibility ] ?? null
					);
					?>
					<div class="loader-wrap">
						<div class="loader"></div>
					</div>
				</div>

				<div class="admin-popup__actions">
					<a href="javascript:void(0);" data-nc-custom-popup-close class="btn btn--cancel admin-popup-cancel">
						<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
					</a>
					<input
						type="submit"
						class="btn btn--submit admin-popup-submit disabled"
						value="<?php esc_attr_e( 'Update customers list', 'north-commerce' ); ?>"
					>
				</div>
			</div>
		</div>
	</form>
</div>
