<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\ProductModel;
use North_Commerce_Settings as Settings;

/**
 * Products modal window
 *
 *
 * @package north-commerce/admin/templates/coupon/single
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.21
 * @version 0.1.21
 */

$products_model = new ProductModel();
$products_list = $products_model->list();

?>
<div class="nc-custom-popup" id="products-modal">
	<form class="popup-new-products admin-popup nc-custom-popup__window">
		<div class="admin-popup__header">
			<div class="admin-popup__left-side">
				<h3 class="integration-popup-name">
					<?php esc_html_e( 'Add products', 'north-commerce' ); ?>
				</h3>
				<div class="loader"></div>
			</div>
			<a
				href="javascript:void(0);"
				class="admin-popup__close"
				data-nc-custom-popup-close
			></a>
		</div>

		<div class="admin-popup__body">
			<div class="admin-popup__notice"></div>
			<div class="admin-popup__content">
				<div class="search-input-wrapper">
					<input
						type="text"
						name="product-variant-filter-name"
						class="search-input product-variant-filter-name"
						id="product-variant-filter-name"
						placeholder="<?php esc_attr_e( 'Search by Product name or Variation name', 'north-commerce' ); ?>"
					>
					<label for="product-variant-filter-name" class="search-icon">
					</label>
				</div>

				<div class="empty-list hide">
					<?php esc_html_e( 'No results for: ', 'north-commerce' ); ?>
					<span class="search-query"></span>
				</div>

				<div class="popup-list popup-products-list">
					<?php
					foreach ( $products_list as $product ) {
						$product_id = $product['id'];
						$product_has_variants = count( $product['product_variants'] ) > 1; // more than single `solo`

						?>
						<div
							class="list__product <?php echo esc_attr( 'product-' . $product_id ); ?>"
							data-level="product"
							data-id="<?php echo esc_attr( $product_id ); ?>"
						>
							<div class="product__wrapper">
								<div class="product__checkbox">
									<input
										type="checkbox"
										name="applied_products[]"
										class="north-checkbox__handler"
										id="<?php echo esc_attr( 'product_' . $product_id ); ?>"
										value="<?php echo esc_attr( $product_id ); ?>"
									>
									<label for="<?php echo esc_attr( 'product_' . $product_id ) ?>" class="north-checkbox">
									</label>
								</div>

								<label
									for="<?php echo esc_attr( 'product_' . $product_id ); ?>"
									class="product__img"
								>
									<?php
									$product_image = $product['product_images'][0]['image_url'] ?? NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';
									?>
									<img
										src="<?php echo esc_url( $product_image ); ?>"
										alt="<?php echo esc_attr( $product['name'] ); ?>"
									>
								</label>

								<label for="<?php echo esc_attr( 'product_' . $product_id ); ?>" class="product__name">
									<?php echo esc_html( $product['name'] ); ?>
								</label>

								<div class="product__quantity">
									<?php
									if ( $product['quantity'] ) {
										?>
										<span class="quantity__value">
											<?php echo esc_html( $product['quantity'] ); ?>
										</span>
										<?php
										esc_html_e( ' in stock', 'north-commerce' );
									}
									?>
								</div>

								<div class="product__price">
									<?php echo Settings::formatted_price( $product['base_price'] ); ?>
								</div>

								<label
									for="<?php echo esc_attr( 'product-' . $product_id . '-variation-expander' ); ?>"
									class="product__handler<?php echo ! $product_has_variants ? ' hide' : ''; ?>"
								>
									<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
										<path d="M12.0002 15.713L18.0102 9.70299L16.5972 8.28799L12.0002 12.888L7.40423 8.28799L5.99023 9.70199L12.0002 15.713Z">
									</svg>
								</label>
							</div>

							<input
								type="checkbox"
								id="<?php echo esc_attr( 'product-' . $product_id . '-variation-expander' ); ?>"
								class="product__expander"
							>

							<div class="product__variants-list<?php echo ! $product_has_variants ? ' hide' : ''; ?>">
								<?php

								foreach ( $product['product_variants'] as $variant ) {
									if ( 'solo' === $variant['product_variant_type']['slug'] ) {
										continue;
									}

									$variant_attr_id = 'product-' . $product_id . '_variant-' . $variant['id'];
									?>
									<div
										class="product__variant <?php echo esc_attr( $variant_attr_id ); ?>"
										data-level="variant"
									>
										<div class="variant__wrapper">
											<div class="variant__checkbox">
												<input
													type="checkbox"
													name="applied_variants[]"
													id="<?php echo esc_attr( $variant_attr_id ); ?>"
													class="variant__handler north-checkbox__handler"
													value="<?php echo esc_attr( $variant['id'] ); ?>"
													<?php checked( isset( $related_variants[ intval( $variant['id'] ) ] ) ); ?>
												>
												<label for="<?php echo esc_attr( $variant_attr_id ); ?>" class="north-checkbox">
												</label>
											</div>
											<label for="<?php echo esc_attr( $variant_attr_id ); ?>" class="variant__label">
												<?php echo esc_html( $variant['slug'] ); ?>
											</label>
										</div>
									</div>
									<?php
								}

								?>
							</div>
						</div>
						<?php

					}
					?>
					<div class="loader-wrap">
						<div class="loader"></div>
					</div>
				</div>
				<div class="admin-popup__actions">
					<a href="javascript:void(0);" data-nc-custom-popup-close class="btn btn--cancel admin-popup-cancel">
						<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
					</a>
					<input
						type="submit"
						class="btn btn--submit admin-popup-submit disabled"
						value="<?php esc_attr_e( 'Update specific products', 'north-commerce' ); ?>"
					>
				</div>
			</div>
		</div>
	</form>
</div>
