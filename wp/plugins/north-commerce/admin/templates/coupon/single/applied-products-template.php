<?php

defined( 'ABSPATH' ) || exit;

use North_Commerce_Settings as Settings;

/**
 * Applied Products section
 *
 *
 * @package north-commerce/admin/templates/coupon/single
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.21
 * @version 0.1.21
 */


?>
<h3>
    <?php esc_html_e( 'Applied Products', 'north-commerce' ); ?>
</h3>

<label class="radio-container">
    <?php esc_html_e( 'All products', 'north-commerce' ); ?>
    <input
        type="radio"
        name="coupon_products"
        id="coupon_products_any"
        value="products_any"
        <?php checked( $coupon_any_product ); ?>
    >
    <span class="checkmark"></span>
</label>

<label class="radio-container">
    <?php esc_html_e( 'Specific products', 'north-commerce' ); ?>
    <input
        type="radio"
        name="coupon_products"
        id="coupon_products_specific"
        value="products_specific"
        <?php checked( ! $coupon_any_product ); ?>
    >
    <span class="checkmark"></span>
</label>
<?php
$class_active = ! $coupon_any_product ? ' active' : '';

?>
<div class="applied-list applied-products-list<?php echo esc_attr( $class_active ); ?>">
    <button
        type="button"
        class="add-button applied-list__button"
        data-nc-custom-popup="#products-modal"
    >
	    <span class="add-button__icon"></span>
		<span class="add-button__label">
		    <?php esc_html_e( 'Add products', 'north-commerce' ); ?>
	    </span>
	</button>
    <div class="selected-list list-products">
        <?php

        $get_variants_counter = function ( $variants_list ) {
            $variants_count = count( $variants_list );
            if ( $variants_count > 2 ) {
                return $variants_count;
            }
            foreach ( $variants_list as $variant ) {
                if ( 'solo' === $variant['product_variant_type']['slug'] ) {
                    return $variants_count - 1; // exluding `solo`
                }
            }
            return $variants_count;
        };

        $applied_products = [];
        foreach ( $applied_product_variants as $map_record ) {
            $product_id = $map_record['product_variant']['product']['id'];
            $variant_id = $map_record['product_variant_id'];

            $applied_products[ $product_id ][ $variant_id ] = $map_record['product_variant'];
        }

        foreach ( $applied_products as $product_id => &$product_variants ) {
            $variant = reset( $product_variants );
            $product = $variant['product'];

            $data_selected_variants = '[' . implode( ', ', array_keys( $product_variants ) ) . ']';

            ?>
            <div
                class="product__wrapper"
                data-id="<? echo esc_attr( $product['id'] ); ?>"
                data-selected-variants="<?php echo esc_attr( $data_selected_variants ); ?>"
            >
                <?php
                $product_image = $product['product_images'][0]['image_url'] ?? NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';
                ?>
                <img
                    src="<?php echo esc_url( $product_image ); ?>"
                    class="product__img"
                    >

                <div class="product__info">
                    <div class="info__name">
                        <?php echo esc_html( $product['name'] ); ?>
                    </div>

                    <div class="info__variants">
                        <?php
                        $selected_variants_counter = $get_variants_counter( $product_variants );
                        $total_variants_counter = $get_variants_counter( $product['product_variants'] );
                        printf(
                            '<span class="%1$s">%2$s</span> of <span class="%3$s">%4$s</span> %5$s',
                            'selected-variants',
                            $selected_variants_counter,
                            'total-product-variants',
                            $total_variants_counter,
                            _n( 'variant', 'variants', $selected_variants_counter, 'north-commerce' )
                        );
                        ?>
                    </div>
                </div>

                <div class="product__quantity">
                    <?php
                    if ( $product['quantity'] ) {
                        ?>
                        <span class="quantity__value">
                            <?php echo esc_html( $product['quantity'] ); ?>
                        </span>
                        <?php
                        esc_html_e( ' in stock', 'north-commerce' );
                    }
                    ?>
                </div>

                <div class="product__price">
                    <?php echo Settings::formatted_price( $product['base_price'] ); ?>
                </div>

                <a
                    href="javascript:void(0);"
                    class="product__delete list__item-delete"
                ></a>

            </div>
            <?php
        }

        ?>
        <div class="loader-wrap">
			<div class="loader"></div>
		</div>
    </div>
</div>

<script type="text/template" id="nc-tmpl-product-item">
    <div class="product__wrapper" data-selected-variants>
        <img src="" class="product__img">
        <div class="product__info">
            <div class="info__name"></div>
            <div class="info__variants">
                <span class="selected-variants"></span>
                <?php echo esc_html_x( ' of ', 'nc-tmpl-product-item', 'north-commerce' ); ?>
                <span class="total-product-variants"></span>
                <span
                    class="variant_noun"
                    data-single="<?php esc_html_e( 'variant', 'north-commerce' ); ?>"
                    data-plural="<?php esc_html_e( 'variants', 'north-commerce' ); ?>"
                ></span>
            </div>
        </div>
        <div class="product__quantity">
            <span class="quantity__value"></span>
            <?php echo esc_html_x( ' in stock', 'north-commerce' ); ?>
        </div>
        <div class="product__price"></div>
        <a href="javascript:void(0);" class="product__delete list__item-delete"></a>
    </div>
</script>
