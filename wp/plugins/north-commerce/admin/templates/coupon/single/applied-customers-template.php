<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\CouponCustomerEligibilities as CustomerEligibilities;

/**
 * Applied Customers section
 *
 *
 * @package north-commerce/admin/templates/coupon/single
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.21
 * @version 0.1.21
 */


?>
<h3>
    <?php esc_html_e( 'Applied Customers', 'north-commerce' ); ?>
</h3>

<label class="radio-container">
    <?php esc_html_e( 'Everyone', 'north-commerce' ); ?>
    <input
        type="radio"
        name="coupon_customers"
        id="coupon_customers_any"
        value="customers_any"
        <?php checked( $coupon_any_customer ); ?>
    >
    <span class="checkmark"></span>
</label>

<label class="radio-container">
    <?php esc_html_e( 'Specific customers', 'north-commerce' ); ?>
    <input
        type="radio"
        name="coupon_customers"
        id="coupon_customers_specific"
        value="customers_specific"
        <?php checked( ! $coupon_any_customer ); ?>
    >
    <span class="checkmark"></span>
</label>
<?php

$class_active = ! $coupon_any_customer ? ' active' : '';

$customer_new_eligibility = CustomerEligibilities::newCustomer()->slug;
// CustomerEligibilities::customerEmails()->slug;
$customer_ids_eligibility = CustomerEligibilities::northCommerceCustomerIds()->slug;
$customer_tags_eligibility = CustomerEligibilities::northCommerceCustomerTags()->slug;
$customer_wp_users_eligibility = CustomerEligibilities::wordpressUsers()->slug;;
$customer_wp_roles_eligibility = CustomerEligibilities::wordpressRoles()->slug;

$render_new_customer_item = function () {
    ?>
    <div
        class="item__wrapper"
        data-customer-new
    >
        <div class="item__eligibility">
            <b><?php esc_html_e( 'New customer', 'north-commerce' ); ?></b>
        </div>
        <a href="javascript:void(0);" class="list__item-delete">
        </a>
    </div>
    <?php
};

$render_customer_id_item = function ( $customer ) {
    $full_name = isset( $customer['first_name'], $customer['last_name'] )
        ? $customer['first_name'] . ' ' . $customer['last_name']
        : '';

    ?>
    <div
        class="item__wrapper"
        data-customer-id="<?php echo esc_attr( $customer['id'] ?? '' ); ?>"
    >
        <div class="item__eligibility">
            <b><?php esc_html_e( 'NC customer:', 'north-commerce' ); ?></b>
        </div>
        <div class="name customer__name">
            <?php echo esc_html( $full_name ); ?>
        </div>
        <div class="email customer__email">
            <?php echo esc_html( $customer['email'] ?? '' ); ?>
        </div>
        <a href="javascript:void(0);" class="list__item-delete"></a>
    </div>
    <?php
};

$render_customer_tag_item = function ( $tag ) {
    ?>
    <div
        class="item__wrapper"
        data-customer-tag-id="<?php echo esc_attr( $tag['id'] ?? '' ); ?>"
    >
        <div class="item__eligibility">
            <b><?php esc_html_e( 'NC customer tag:', 'north-commerce' ); ?></b>
        </div>
        <div class="name tag__name">
            <?php echo esc_html( $tag['name'] ?? '' ); ?>
        </div>
        <a href="javascript:void(0);" class="list__item-delete"></a>
    </div>
    <?php
};

$render_customer_wp_user_item = function ( $wp_user_id ) {
    $wp_user = get_user_by( 'id', $wp_user_id );

    ?>
    <div
        class="item__wrapper wp-user"
        data-wp-user-id="<?php echo esc_attr( $wp_user->ID ?? '' ); ?>"
    >
        <div class="item__eligibility">
            <b><?php esc_html_e( 'WP User:', 'north-commerce' ); ?></b>
        </div>
        <div class="name wp-user__name">
            <?php echo esc_html( $wp_user->user_nicename ?? '' ); ?>
        </div>
        <div class="email wp-user__email">
            <?php echo esc_html( $wp_user->user_email ?? '' ); ?>
        </div>
        <a href="javascript:void(0);" class="list__item-delete">
        </a>
    </div>
    <?php
};

$render_customer_wp_role_item = function ( $wp_role_slug ) {
    if ( $wp_role_slug ) {
        $role_name = wp_roles()->role_names[ $wp_role_slug ] ?? '';
    }
    ?>
    <div
        class="item__wrapper"
        data-wp-role="<?php echo esc_attr( $wp_role_slug ?? '' ); ?>"
    >
        <div class="item__eligibility">
            <b><?php esc_html_e( 'WP Role:', 'north-commerce' ); ?></b>
        </div>
        <div class="name wp-role__name">
            <?php echo esc_html( $role_name ?? '' ); ?>
        </div>
        <a href="javascript:void(0);" class="list__item-delete">
        </a>
    </div>
    <?php
};

?>
<div class="applied-list applied-customers-list<?php echo esc_attr( $class_active ); ?>">
    <button
        type="button"
        class="add-button applied-list__button"
        data-nc-custom-popup="#customers-modal"
    >
	    <span class="add-button__icon"></span>
		<span class="add-button__label">
		    <?php esc_html_e( 'Add customers', 'north-commerce' ); ?>
	    </span>
	</button>
    <div class="selected-list list-customers">
        <?php

        foreach ( $applied_customers as $eligibility_slug => $eligibility_value ) {
            if ( $customer_new_eligibility === $eligibility_slug ) {
                $render_new_customer_item();
                continue;
            }

            if ( $customer_ids_eligibility === $eligibility_slug ) {
                foreach ( $eligibility_value as $record ) {
                    $render_customer_id_item( $record ['customer'] );
                }
                continue;
            }

            if ( $customer_tags_eligibility === $eligibility_slug ) {
                foreach ( $eligibility_value as $record ) {
                    $render_customer_tag_item( $record ['customer_tag'] );
                }
                continue;
            }

            if ( $customer_wp_users_eligibility === $eligibility_slug ) {
                foreach ( $eligibility_value as $record ) {
                    $render_customer_wp_user_item( $record['wp_user_id'] );
                }
                continue;
            }

            if ( $customer_wp_roles_eligibility === $eligibility_slug ) {
                foreach ( $eligibility_value as $record ) {
                    $render_customer_wp_role_item( $record['wp_role'] );
                }
                continue;
            }
        }

        ?>
        <div class="loader-wrap">
			<div class="loader"></div>
		</div>
    </div>
</div>

<script type="text/template" id="nc-tmpl-customer-item-new">
    <?php $render_new_customer_item(); ?>
</script>

<script type="text/template" id="nc-tmpl-customer-item-id">
    <?php $render_customer_id_item( null ); ?>
</script>

<script type="text/template" id="nc-tmpl-customer-item-tag">
    <?php $render_customer_tag_item( null ); ?>
</script>

<script type="text/template" id="nc-tmpl-customer-wp-user">
    <?php $render_customer_wp_user_item( null ); ?>
</script>

<script type="text/template" id="nc-tmpl-customer-wp-role">
    <?php $render_customer_wp_role_item( null ); ?>
</script>