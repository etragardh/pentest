<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\{
	CouponDiscountTypes as DiscountTypes,
	CouponRequirements as Requirements,
	CouponModes as Modes
};
use NorthCommerce\Models\CouponModel;

/**
 * Coupon Single template.
 *
 * @package north-commerce/admin/templates
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.19
 * @version 0.1.21
 */


$coupon_model = new CouponModel();

if (
	isset( $_GET['action'], $_GET['id'] )
	&& 'edit' === $_GET['action']
) {
	$coupon_id = sanitize_text_field( $_GET['id'] );
    $coupon = $coupon_model->get_by_id( $coupon_id );

	if ( empty( $coupon['id'] ) ) {
		// Redirect to Coupons List
		?>
		<script>
			window.location.href = '<?php echo admin_url( 'admin.php?page=north-commerce-coupons' ); ?>'
		</script>
		<?php
		exit;
	}
}


$coupon_id = $coupon['id'] ?? null;

$parts_dir = 'coupon/single';

?>
<div class="coupon single">

	<div class="header">
		<div class="header__wrapper">
			<a href="<?php echo admin_url( 'admin.php?page=north-commerce-coupons' ); ?>" class="btn btn-back"></a>
			<h2>
				<?php
				$heading = $coupon['name'] ?? esc_html( 'Create Coupon', 'north-commerce' );
				echo esc_html( $heading );
				?>
			</h2>
		</div>
	</div>

	<div class="content">
		<form id="coupon-form" class="form" method="POST" enctype="multipart/form-data">
			<?php
			wp_nonce_field( 'coupon_form', 'form_nonce', false );
			if ( $coupon_id ) {
				?>
				<input type="hidden" name="coupon_id" value="<?php echo esc_attr( $coupon_id ); ?>">
				<?php
			}
			?>
			<div class="form-wrapper">
				<div id="coupon-name" class="settings-card coupon__name">
					<?php
					$coupon_name = $coupon['name'] ?? '';
					$this->template( 'name-template', $parts_dir, compact( 'coupon_name' ) );
					?>
				</div>

				<div id="coupon-usage" class="settings-card coupon__usage">
					<?php
					$coupon_usage_counter = $coupon['usage_counter'] ?? '';
					$coupon_usage_limit = $coupon['usage_limit'] ?? '';
					$this->template( 'usage-template', $parts_dir, compact(
						'coupon_usage_counter',
						'coupon_usage_limit',
					) );
					?>
				</div>

				<div id="coupon-mode" class="settings-card coupon__mode">
					<?php
					$modes_list = $coupon_model->list_modes();
					$coupon_mode = $coupon['coupon_mode'] ?? (array) Modes::manual();
					$this->template( 'mode-template', $parts_dir, compact(
						'modes_list',
						'coupon_mode',
					) );
					?>
				</div>

				<div id="coupon-discount-type" class="settings-card coupon__discount_type">
					<?php
					$discount_types_list = $coupon_model->list_discount_types();
					$coupon_discount_type = $coupon['coupon_discount_type'] ?? (array) DiscountTypes::fixed();
					$coupon_discount_amount = $coupon['discount_amount'] ?? '';
					$this->template( 'discount-type-template', $parts_dir, compact(
						'discount_types_list',
						'coupon_discount_type',
						'coupon_discount_amount',
					) );
					?>
				</div>

				<div id="coupon-requirement" class="settings-card coupon__requirement">
					<?php
					$requirements_list = $coupon_model->list_requirements();
					$coupon_requirement = $coupon['coupon_requirement'] ?? (array) Requirements::none();
					$coupon_requirement_amount = $coupon['requirement_amount'] ?? '';
					$this->template( 'requirement-template', $parts_dir, compact(
						'requirements_list',
						'coupon_requirement',
						'coupon_requirement_amount',
					) );
					?>
				</div>

				<div id="coupon-products" class="settings-card coupon__products">
					<?php
					$coupon_any_product = (bool) ( $coupon['any_product'] ?? true );
					$applied_product_variants = $coupon_model->list_applied_product_variants_by_id( $coupon_id );
					$this->template( 'applied-products-template', $parts_dir, compact(
						'coupon_any_product',
						'applied_product_variants',
					) );
					?>
				</div>

				<div id="coupon-countries" class="settings-card coupon__countries">
					<?php
					$coupon_any_country = (bool) ( $coupon['any_country'] ?? true );
					$applied_countries = $coupon_model->list_applied_countries_by_id( $coupon_id );
					$this->template( 'applied-countries-template', $parts_dir, compact(
						'coupon_any_country',
						'applied_countries',
					) );
					?>
				</div>

				<div id="coupon-customers" class="settings-card coupon__customers">
					<?php
					$coupon_any_customer = (bool) ( $coupon['any_customer'] ?? true );
					$applied_customers = $coupon_model->list_applied_customers_by_id( $coupon_id );
					$this->template( 'applied-customers-template', $parts_dir, compact(
						'coupon_any_customer',
						'applied_customers',
					) );
					?>
				</div>

				<div id="coupon-dates" class="settings-card coupon__dates">
					<?php
					$sql_time_start = $coupon['time_start'] ?? null;
					$sql_time_end = $coupon['time_end'] ?? null;
					$this->template( 'active-dates-template', $parts_dir, compact(
						'sql_time_start',
						'sql_time_end',
					) );
					?>
				</div>

			</div>

			<div id="errors" class="form-errors"></div>

			<div id="form-actions" class="form__actions">
				<?php

				if (
					isset( $coupon['id'] )
					&& empty( $coupon['deleted'] )
				) {
					?>
					<a
						href="javascript:void(0);"
						class="btn action action-delete"
						data-coupon-id="<?php echo esc_attr( $coupon['id'] ); ?>"
					>
						<?php echo esc_html__( 'Disable Coupon', 'north-commerce' ); ?>
					</a>
					<?php
				} else {
					?>
					<a
						href="<?php echo admin_url( 'admin.php?page=north-commerce-coupons' ); ?>"
						class="btn action action-cancel"
					>
						<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
					</a>
					<?php
				}

				$action_value = __( 'Save Coupon', 'north-commerce' );
				if ( isset( $coupon['id'] ) ) {
					$action_value = ! empty( $coupon['deleted'] )
						? __( 'Re-publish Coupon', 'north-commerce' )
						: __( 'Update Coupon', 'north-commerce' );
				}
				?>
				<input
					type="submit"
					class="btn action action-save"
					data-action="<?php echo isset( $coupon['id'] ) ? 'update' : 'create'; ?>"
					value="<?php echo esc_attr( $action_value ); ?>"
				>

			</div>
		</form>

		<div id="sidebar" class="sidebar">
			<div class="theiaStickySidebar">
                <ul class="settings-card sidebar__nav">
					<?php
					$sections_list = [
						'coupon-name' => __( 'Code', 'north-commerce' ),
						'coupon-usage' => __( 'Usage', 'north-commerce' ),
						'coupon-mode' => __( 'Mode', 'north-commerce' ),
						'coupon-discount-type' => __( 'Discount Type', 'north-commerce' ),
						'coupon-requirement' => __( 'Requirement', 'north-commerce' ),
						'coupon-products' => __( 'Products', 'north-commerce' ),
						'coupon-countries' => __( 'Countries', 'north-commerce' ),
						'coupon-customers' => __( 'Customers', 'north-commerce' ),
						'coupon-dates' => __( 'Active Dates', 'north-commerce' ),
						'form-actions' => __( 'Coupon Actions', 'north-commerce' ),
					];

					foreach ( $sections_list as $section_id => $section_name ) {
						?>
						<li>
							<a class="nc-smooth-scroll-nav" href="<?php echo esc_attr( '#' . $section_id ); ?>">
								<?php echo esc_html( $section_name ); ?>
							</a>
						</li>
						<?php
					}
					?>
                </ul>
			</div>
		</div>
	</div>

</div>
<?php


// Popup Forms
$this->template( 'popup-products-template', $parts_dir, compact( 'applied_product_variants' ) );
$this->template( 'popup-countries-template', $parts_dir, compact( 'applied_countries' ) );
$this->template( 'popup-customers-template', $parts_dir, compact(
	'applied_customers',
	'coupon_model',
) );
