<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\CouponModel;

/**
 * Coupons list template.
 *
 *
 * @package north-commerce/admin/templates/coupon
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.19
 * @version 0.1.21
 */


$parts_dir = 'coupon/list';

$coupon_model = new CouponModel();

$current_page = sanitize_text_field( $_POST['paged'] ?? 1 );
$coupons_per_page = sanitize_text_field( $_POST['posts_per_page'] ?? 10 );

$pagination = [
    'current_page' => intval( $current_page ),
    'coupons_per_page' => intval( $coupons_per_page ),
];

$options = [
    'limit' => $pagination['coupons_per_page'],
    'offset' => $pagination['coupons_per_page'] * ( $pagination['current_page'] - 1 ),
    'order_by' => 'created DESC',
];
$coupons_list = $coupon_model->list( $criteria = true, $options );
$coupons_total = $coupon_model->count();

$pagination['max_page'] = ceil( $coupons_total / $coupons_per_page );
$pagination['text'] = $coupons_total
        ? ( $options['offset'] + 1 ) . '-' . ( $options['limit'] < $coupons_total ? $options['limit'] : $coupons_total )  . ' of ' . $coupons_total
        : esc_html__( '0-0 of 0', 'north-commerce' );


?>
<div class="north-settings">

    <div class="north-tab-wrapper">
        <?php $this->plugin_tabs(); ?>
    </div>

    <?php do_action( 'north_commerce_notices' ); ?>

    <div id="wpmdb-main">
        <div class="settings-tab__head">
            <div class="tab__head-wrapper">
                <h2>
                    <?php esc_html_e( 'Coupons', 'north-commerce' ); ?>
                </h2>
                <p>
                    <?php esc_html_e( 'You can manage and customize your coupons.', 'north-commerce' ); ?>
                </p>
            </div>
            <a
                href="<?php echo esc_url( get_site_url() . '/wp-admin/admin.php?page=north-commerce-coupons&amp;action=add' ); ?>"
                class="btn submit-btn activate coupon-add"
                >
                <?php esc_html_e( 'Add coupon', 'north-commerce' ); ?>
            </a>
        </div>
        <div class="settings-tab__body coupons list">
            <div class="coupons__statuses">
                <?php
                $this->template( 'statuses', $parts_dir, compact(
                    'coupons_total',
                    'coupon_model',
                ) );
                ?>
            </div>
            <div class="board coupons__board">
                <div class="board__header">
                    <?php
                    $this->template( 'filters-form', $parts_dir );

                    $pagination_args = compact(
                        'pagination',
                    );
                    $this->template( 'pagination', $parts_dir, $pagination_args );

                    ?>
                </div>
                <div class="board__result">
                    <?php
                    $this->template( 'heading-row', $parts_dir );

                    if ( ! $coupons_total ) {
                        $this->template( 'list-empty', $parts_dir );
                    } else {
                        ?>
                        <div
                            class="result__coupons"
                            data-current-page="<?php echo esc_attr( $pagination['current_page'] ); ?>"
                            data-max-page="<?php echo esc_attr( $pagination['max_page'] ); ?>"
                            >
                            <?php
                            foreach ( $coupons_list as $coupon ) {
                                $this->template( 'coupon-item', $parts_dir, compact( 'coupon' ) );
                            }
                            ?>
                        </div>
                        <?php
                    }

                    ?>
                    <div class="board__overlay">
                        <div class="loader-spinner"></div>
                    </div>
                </div>
                <div class="board__footer">
                    <?php
                    $this->template( 'pagination', $parts_dir, $pagination_args );
                    ?>
                </div>
            </div>
        </div>

    </div>

</div>
