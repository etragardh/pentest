<?php
/**
 * @package    north-commerce/admin/templates/overview
 * @link       https://northcommerce.com/
 * @since      0.1.2
 * @version    0.1.4
 */
use NorthCommerce\Db\Collections\PaymentStatuses;

$product_model = new \NorthCommerce\Models\ProductModel();
$order_model = new \NorthCommerce\Models\OrderModel();
$orders = new \NorthCommerce\Models\OverviewModel();
$overview_info = $overview_info ?? null;
$startDate = $startDate ?? null;
$endDate = $endDate ?? null;
$filterType = $filterType ?? 'Today';

/*
Today
Yesterday
Week - Monday - Sunday
Month - 1st of the month to currentDate
*/


$criteria = "payment_status.id:eq:". PaymentStatuses::paid()->id;
switch ($filterType) {
	case 'Range':
		$startDate = (new DateTime($startDate))->setTime(0, 0, 0)->format('Y-m-d H:i:s');
		$endDate = (new DateTime($endDate))->setTime(23, 59, 59)->format('Y-m-d H:i:s');
		$criteria = "payment_status.id:eq:1,created:gte:$startDate,created:lte:$endDate";
		break;
	case 'Today':
		$criteria .= ",created:gte:".$startDate;
		break;
	case 'Yesterday':
		$yesterday = date('Y-m-d', strtotime(date('Y', strtotime($startDate)) . '-' . date('m', strtotime($startDate)) . '-' . date('d', strtotime($startDate)) - 1));
		$criteria .= ",created:gte:".$yesterday;
		$criteria .= ",created:lt:".$startDate;
		break;
	case 'Week':
		$day = date('w', strtotime($startDate));
		$weekStart = date('Y-m-d', strtotime('-'.$day.' days'));
		$weekEnd = date('Y-m-d', strtotime('+'.(6-$day).' days'));
		$criteria .= ",created:gte:".$weekStart;
		$criteria .= ",created:lte:".$weekEnd;
		break;
	case 'Month':
		$day = date('m', strtotime($startDate));
		$monthStart = date('Y-m-01', strtotime($startDate)); // Directly setting day part to 01
		$monthEnd = date('Y-m-t', strtotime($startDate)); // Using t to get the last day of the month
		$criteria .= ",created:gte:".$monthStart;
		$criteria .= ",created:lte:".$monthEnd;
		break;
}

$all_orders = $orders->getOrders($criteria, []);
$total_price = North_Commerce_Settings::formatted_price( ! empty( $total_sales ) ? $total_sales : 0 );
$order_total = count($all_orders);
$orders = ! empty( $overview_info) ? $overview_info->get_total_orders() : 0;
$products = ! empty( $overview_info ) ? $overview_info->get_top_products() : array();
$coupons = ! empty( $overview_info ) ? $overview_info->get_top_coupons() : array();
$subscriptions = ! empty( $overview_info ) ? $overview_info->get_total_subscriptions() : 0;
$returned_customers_rate = ! empty( $overview_info ) ? $overview_info->get_returned_customer_rate() : 0;

?>
<div class="overview-cards">
	<?php echo $this->template('total_sales', 'overview/overview_components', [ 'orders' => $all_orders]); ?>
	<?php echo $this->template('total_orders', 'overview/overview_components', [ 'order_count' => $order_total]); ?>
	<?php echo $this->template('average_order', 'overview/overview_components', [ 'order_count' => $order_total, 'orders' => $all_orders]); ?>
	<?php echo $this->template('returning_customer', 'overview/overview_components'); ?>
</div>

<div class="overview-cards">
	<?php echo $this->template('top_products', 'overview/overview_components'); ?>
	<?php echo $this->template('top_coupons', 'overview/overview_components'); ?>
	
    
    <div class="overview-card-group">
		<?php echo $this->template('total_subscriptions', 'overview/overview_components'); ?>
		<?php echo $this->template('store_sessions', 'overview/overview_components'); ?>
    </div>
</div>