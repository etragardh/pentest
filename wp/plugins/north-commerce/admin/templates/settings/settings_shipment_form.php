<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\ShippingProfileModel;

/**
 * @package north-commerce/admin/templates/settings
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.2
 * @version 0.1.24
 */


$profile_model = new ShippingProfileModel();

$regional_profile = $profile_model->get_regional_profile_by_id( $_GET['id'] );
$uncovered_countries = $profile_model->list_uncovered_countries( $regional_profile );

$shipping_tab_url = admin_url( 'admin.php?page=north-commerce-settings&tab=shipment' );
$subtemplates_dir = 'shipment';

?>
<div class="north-plugin north-settings shipment">
	<div class="shipping-profile">
		<form class="shipping-profile__container shipping-form">
			<input
				type="hidden"
				id="shipping_profile_data"
				value="<?php echo htmlspecialchars( json_encode( $regional_profile ), ENT_QUOTES, 'UTF-8' ); ?>"
			>
            <input type="hidden" name="redirect_url" value="<?php echo $shipping_tab_url; ?>">
            <input type="hidden" name="shipping_profile_id" value="<?php echo esc_attr( $regional_profile['id'] ) ?>">
            <input type="hidden" name="all_variants_included" value="<?php echo esc_attr( $regional_profile['all_variants_included'] ) ?>">

            <div class="shipping-profile__header">
                <a
					href="<?php echo esc_url( $shipping_tab_url ); ?>"
					class="btn btn--back"
				>
                    <svg width="20" height="10" viewBox="0 0 20 10" fill="none">
                        <path fill="#00073F" d="M3.83 4L6.41 1.41L5 0L0 5L5 10L6.41 8.59L3.83 6H20V4H3.83Z"/>
                    </svg>
                </a>
                <h1 class="shipping-profile__title">
                    <?php echo esc_html( $regional_profile['name'] . __( ' shipping profile', 'north-commerce' ) ); ?>
                </h1>
            </div>
			<?php

	        $this->template( 'shipment-product-list', $subtemplates_dir, [
				'profile' => $regional_profile,
	        ] );

			?>
            <div class="profile-card">
                <div class="profile-card__header">
                    <div class="profile-card__title">
						<?php esc_html_e( 'Shipping from', 'north-commerce' ); ?>
					</div>
                </div>
				<?php

				$profile_address_line = $regional_profile['shipping_address']['preformatted_line'] ?? '';

				?>
				<span class="address profile-card__address<?php echo ! $profile_address_line ? ' empty' : ''; ?>">
					<span class="address__icon"></span>
					<span class="address__title">
						<?php
						echo esc_html( $profile_address_line ) ?: esc_html__( 'Add a "Ship From" Address.', 'north-commerce' );
						?>
					</span>
					<span class="address__country">
						<?php echo esc_html( $regional_profile['shipping_address']['country']['name'] ?? '' ); ?>
					</span>
				</span>

				<div class="shipping-zones">
					<div class="shipping-zones__header">
						<div class="profile-card__title">
							<?php esc_html_e( 'Shipping to', 'north-commerce' ); ?>
						</div>
						<button type="button" class="add-button create_shipping_zone__handler">
							<span class="add-button__icon"></span>
							<span class="add-button__label">
								<?php esc_html_e( 'Create shipping zone', 'north-commerce' ); ?>
							</span>
						</button>
					</div>

					<div class="shipping-zone-list">
						<?php
                        $this->template( 'shipment-zone-item', $subtemplates_dir ); // zone item template

                        foreach ( $regional_profile['shipping_zones'] as $zone ) {
	                        $this->template( 'shipment-zone-item', $subtemplates_dir, compact(
		                        'zone',
							) );
                        }
						?>
					</div>

					<div class="shipping-zone-list__empty has-no-data<?php echo $regional_profile['shipping_zones'] ? ' hide' : '' ?>">
						<p class="title">
							<?php esc_html_e( 'No zones or rates', 'north-commerce' ); ?>
						</p>
						<p class="description">
							<?php esc_html_e( 'Add zones to create rates for places you want to ship to.', 'north-commerce' ); ?>
						</p>
					</div>
				</div>

				<hr class="full-width">

				<div class="not-covered">
					<input type="checkbox" id="not-covered-checkbox" class="not-covered__checkbox-input">

					<?php $this->template( 'planet', 'icons' ); ?>

					<span class="not-covered__title">
						<?php esc_html_e( 'Not covered by your shipping zones', 'north-commerce' ); ?>
					</span>

					<label class="not-covered__info" for="not-covered-checkbox">
						<span class="not-covered__info__label">
							<?php
							printf(
								'<span class="%1$s">%2$s</span> countries',
								'not-covered__info__label__number',
								count( $uncovered_countries )
							);
							?>
						</span>
						<span class="not-covered__info__expander_icon">
							<svg width="12" height="8" viewBox="0 0 12 8" fill="none">
								<path fill="#747E94" d="M5.99955 7.09419L11.0079 2.08584L9.83039 0.906677L5.99955 4.74002L2.16954 0.906677L0.991211 2.08501L5.99955 7.09419Z"/>
							</svg>
						</span>
					</label>

					<div
						class="not-covered__countries"
						data-list="<?php echo htmlspecialchars( json_encode( $uncovered_countries ), ENT_QUOTES, 'UTF-8' ); ?>"
					>
						<?php echo implode( ', ', $uncovered_countries ); ?>
					</div>
				</div>
			</div>

			<div class="actions">
				<div>
					<?php
					if ( ! $regional_profile['is_default'] ) {
						?>
						<label class="btn btn--delete delete_profile_popup">
							<?php esc_html_e( 'Delete profile', 'north-commerce' ); ?>
						</label>
						<?php
					}
					?>
				</div>

				<div class="actions__group">
					<div class="loader shipping-profile-wait"></div>
					<a
						href="<?php echo $shipping_tab_url; ?>"
						class="btn btn--cancel cancel-changes"
					>
						<?php esc_html_e( 'Discard', 'north-commerce' ); ?>
					</a>
					<input
						type="submit"
						class="btn btn--submit"
						value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
					>
				</div>
			</div>
		</form>
    </div>
	<?php

	// Popups

	if ( ! $regional_profile['is_default'] ) {
		$this->template( 'popup-shippinng-profile-delete', "$subtemplates_dir/popups", [
			'options' => [
				'identifier' => [
					'input_name' => 'shipping_profile_id',
					'input_value' => $regional_profile['id'],
					'form_class' => 'shipping-profile-delete-popup'
				],
				'title' => __( 'Are you sure you want to delete this profile?', 'north-commerce' ),
				'description' => __( 'This profile will be deleted immediately. You can’t undo this action.', 'north-commerce' ),
				'submit' => __( 'Delete profile', 'north-commerce' ),
			]
		] );
	}

	$this->template( 'popup-shippinng-profile-delete', "$subtemplates_dir/popups", [
		'options' => [
			'identifier' => [
				'input_name' => 'redirect_url',
				'input_value' => $shipping_tab_url,
				'form_class' => 'shipping-profile-cancel-changes-popup'
			],
			'title' => __( 'Are you sure you want to cancel the changes that you have done?', 'north-commerce' ),
			'description' => __( 'This new changes will disappear immediately. You can’t undo this action.', 'north-commerce' ),
			'discard' => __( 'Cancel changes', 'north-commerce' ),
			'submit' => __( 'Update', 'north-commerce' ),
		]
	] );

	$this->template( 'popup-shipping-zone-manager', "$subtemplates_dir/popups");
	$this->template( 'popup-shipping-zone-rate-manager', "$subtemplates_dir/popups" );

	$this->template( 'popup-shipping-profile-products-manager', "$subtemplates_dir/popups", [
		'shipping_profile' => $regional_profile,
	] );

	?>
</div>
