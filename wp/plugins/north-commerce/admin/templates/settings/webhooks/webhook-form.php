<?php

function groupEventsByFirstDotSegment($events)
{
    $groupedEvents = [];

    foreach ($events as $event) {
        $eventKey = $event->key();
        $eventGroup = explode('.', $eventKey)[0];

        if (!isset($groupedEvents[$eventGroup])) {
            $groupedEvents[$eventGroup] = [];
        }

        $groupedEvents[$eventGroup][] = $event;
    }

    return $groupedEvents;
}

global $wpdb;
$webhookId = $_REQUEST['webhookId'] ?? null;
$errors = [];

if (isset($_POST['save_webhook'])) {

    if (!filter_var($_POST['url'], FILTER_VALIDATE_URL)) {
        $errors['url'] = 'Invalid data, please enter a valid URL.';
        $eventsFromUserInput = $_POST['events'] ?? [];
    }

    if (!$errors) {

        $webhooksController = new North_Commerce_Webhooks();

        // Removed service and uid fields
        $data = [
            'url' => $_POST['url'],
            'events' => $_POST['events'] ?? []
        ];

        if ($webhookId) {
            $webhooksController->update_webhook($webhookId, $data);
        } else {
            $webhook = $webhooksController->create_webhook($data);
            // todo - more efficient way of returning this to code below
            $webhookId = $webhook['id'];
        }
    }
}

if (isset($_GET['delete_webhook'])) {
    if (isset($_GET['delete_webhook'])) {
        $wpdb->delete("{$wpdb->prefix}nc_webhooks", ['id' => $_GET['delete_webhook']]);
        $wpdb->delete("{$wpdb->prefix}nc_webhook_events", ['webhook_id' => $_GET['delete_webhook']]);
    }
}

$events = \NorthCommerce\Db\Events\EventManager::allEvents();
$webhook = $webhookId ? $wpdb->get_row("SELECT * FROM {$wpdb->prefix}nc_webhooks WHERE id = $webhookId") : null;
$eventsData = $webhook ? $wpdb->get_results("SELECT * FROM {$wpdb->prefix}nc_webhook_events WHERE webhook_id = $webhookId") : [];
$triggers = isset($eventsFromUserInput) ? $eventsFromUserInput : array_map(function ($eventData) {
    return $eventData->event;
}, $eventsData);
$groupedEvents = groupEventsByFirstDotSegment($events);
?>

<h3><?php
    if ($webhookId) {
        esc_html_e('Edit your webhook', 'north-commerce');
    } else {
        esc_html_e('Add your webhook', 'north-commerce');
    } ?></h3>
<p class="title-info loader-message">
    <?php esc_html_e('Enter your endpoint and select the events which should trigger the call to this endpoint.', 'north-commerce'); ?>
</p>


<form id="webhook-form" class="content__form form" method="POST" enctype="multipart/form-data">
    <input type="hidden" id="webhookId" name="webhookId" value="<?php echo isset($webhookId) ? $webhookId : ''; ?>" />
    
    <?php if($webhook && $webhook->service !== 'north-commerce'): ?>
        <p style='color: red'>Only webhooks created via this administration area can be edited.</p>
    <?php endif; ?>



    <div class="webhook-inputs">
        <div class="webhook-url">
            <label for="url">Webhook URL:</label>
            <!-- Display error message for invalid URL -->
            <?php if (isset($errors['url'])) : ?>
                <p class="error-message"><?php echo $errors['url']; ?></p>
            <?php endif; ?>
            <input type="text" id="url" name="url" value="<?php echo isset($_POST['url']) ? $_POST['url'] : (isset($webhook->url) ? $webhook->url : ''); ?>" required <?php echo ($webhook && $webhook->service !== 'north-commerce') ? 'readonly' : ''; ?> />
        </div>
    </div>

    <div class="webhook-events">
        <?php foreach ($groupedEvents as $group => $groupedEventNames) { ?>
            <div class="webhook-group">
                <div class="webhook-group__title">
                    <h4><?php echo ucfirst($group); ?> (<?php echo count($groupedEventNames); ?> events)</h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                        <path d="M6.776 12.553 9.224 8 6.776 3.447C6.082 2.658 7 1.778 7.894 2.447l3.338 4.553a1 1 0 0 1 0 1.106l-3.338 4.553c-.895.668-1.812-.211-1.118-1z" />
                    </svg>
                </div>
                <div class="webhook-events-list" style="<?php echo (count(array_intersect($groupedEventNames, $triggers)) > 0) ? 'display: flex;' : '' ?>">
                    <?php foreach ($groupedEventNames as $event) { ?>
                        <div class="webhook-event">
                            <div class="webhook-event__input">
                                <input type="checkbox" id="<?php echo $event->key() ?>" name="events[]" value="<?php echo $event->key() ?>" <?php echo in_array($event->key(), $triggers) ? 'checked' : '' ?> <?php echo ($webhook && $webhook->service !== 'north-commerce') ? 'disabled' : ''; ?> />
                            </div>
                            <div class="webhook-event__description">
                                <label for="<?php echo $event->key() ?>">
                                    <?php echo $event->name() ?>
                                    <small style="color: lightgray; font-size: 0.8em; font-style: italic;"><?php echo $event->key() ?></small>

                                </label>
                                <div><?php echo $event->description() ?></div>
                            </div>
                        </div>
                    <?php } ?>
                </div>
            </div>
        <?php } ?>
    </div>

    <div class="wrapper">
        <a href="<?php echo get_site_url() . '/wp-admin/admin.php?page=north-commerce-settings&amp;tab=webhooks' ?>" class="btn action action-archive">
            <?php esc_html_e('Cancel', 'north-commerce'); ?>
        </a>

        <input type="submit" name="save_webhook" class="btn action action-save" data-webhook-form-type="<?php echo isset($webhook->id) ? 'update' : 'create'; ?>" value="<?php esc_html_e('Save webhook', 'north-commerce'); ?>">

        <?php if ($webhookId) : ?>
            <a href="?delete_webhook=<?php echo $webhookId ?>" class="btn action action-delete" onclick="return confirm('Are you sure?')">
                <?php esc_html_e('Delete webhook', 'north-commerce'); ?>
            </a>
        <?php endif; ?>
    </div>
</form>