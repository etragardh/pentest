<?php

/**
 * A PHP file for rendering the api docs in our settings area
 */


// Place this in your plugin's main file
use North_Commerce_Settings as Settings;

if (isset($_POST['update_settings'])) {
    Settings::set_scheduler_status(isset($_POST['email_scheduler_status']), 'email');
    Settings::set_scheduler_status(isset($_POST['sms_scheduler_status']), 'sms');
    Settings::set_scheduler_status(isset($_POST['webhook_scheduler_status']), 'webhook');
    Settings::set_scheduler_status(isset($_POST['coupon_scheduler_status']), 'coupon');
}

$email_scheduler_status = Settings::get_scheduler_status('email') ? 'enabled' : 'disabled';
$sms_scheduler_status = Settings::get_scheduler_status('sms') ? 'enabled' : 'disabled';
$webhook_scheduler_status = Settings::get_scheduler_status('webhook') ? 'enabled' : 'disabled';
$coupon_scheduler_status = Settings::get_scheduler_status('coupon') ? 'enabled' : 'disabled';

?>
<div class="wrap north-settings">
    <div class="north-tab-wrapper">
        <?php $this->plugin_tabs(); ?>
    </div>

    <?php do_action('north_commerce_notices'); ?>

    <div id="wpmdb-main">

        <div id="settings-tab" class="settings-tab content-tab">
            <div class="settings-tab__head">
                <div class="head__wrapper">
                    <h2>
                        <?php esc_html_e( 'Settings', 'north-commerce' ); ?>
                    </h2>
                    <p>
                        <?php esc_html_e( 'You can manage and customize your events.', 'north-commerce' ); ?>
                    </p>
                </div>
            </div>
            <div class="settings-tab__body settings">
                <sidebar class="settings__sidebar settings-card">
                    <?= $this->template('nav', 'settings/components'); ?>
                </sidebar>
                <div class="settings__content">

                    <form method="POST" id="event-log-settings">

                        <section class="sync event-log-section">

                            <div class="settings-card">
                                <h3>
                                    <?php esc_html_e('Event Schedule', 'north-commerce'); ?>
                                </h3>
                                <p class="title-info loader-message">
                                    <?php esc_html_e('Which internal North Commerce operations do you want to offload to the scheduler? This will prevent operations from blocking page loads at the expense of immediate feedback.', 'north-commerce'); ?>
                                </p>

                                <?php
                                    $disable_email_schedule = defined('DISABLE_EMAIL_SCHEDULE') ? DISABLE_EMAIL_SCHEDULE : false;

                                    if($disable_email_schedule) {
                                        $email_scheduler_status = "disabled";
                                    }
                                ?>

                                <!-- Email scheduler status field -->
                                <div class="setting-field">
                                    <div class="setting-field__left">
                                        <label for="email_scheduler_status">
                                            <?php esc_html_e('Email', 'north-commerce'); ?>
                                            <?php
                                                if($disable_email_schedule) {
                                                    esc_html_e('(Email scheduler is currently unavailable)', 'north-commerce');
                                                }
                                            ?>
                                        </label>
                                        <p class="title-info">
                                        </p>
                                    </div>
                                    <div class="setting-field__right">
                                        <div class="north-switch">
                                            <input type="checkbox" id="email_scheduler_status" class="switch-condition-mode" name="email_scheduler_status" tabindex="0" value="enabled" <?php checked('enabled' === $email_scheduler_status); ?> <?= $disable_email_schedule ? "disabled" : "" ?>>
                                            <label for="condition_status">
                                                <span></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- SMS scheduler status field -->
                                <div class="setting-field">
                                    <div class="setting-field__left">
                                        <label for="sms_scheduler_status">
                                            <?php esc_html_e('SMS', 'north-commerce'); ?>
                                        </label>
                                        <p class="title-info">
                                        </p>
                                    </div>
                                    <div class="setting-field__right">
                                        <div class="north-switch">
                                            <input type="checkbox" id="sms_scheduler_status" class="switch-condition-mode" name="sms_scheduler_status" tabindex="0" value="enabled" <?php checked('enabled' === $sms_scheduler_status); ?>>
                                            <label for="condition_status">
                                                <span></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Webhook scheduler status field -->
                                <div class="setting-field">
                                    <div class="setting-field__left">
                                        <label for="webhook_scheduler_status">
                                            <?php esc_html_e('Webhooks', 'north-commerce'); ?>
                                        </label>
                                        <p class="title-info">
                                        </p>
                                    </div>
                                    <div class="setting-field__right">
                                        <div class="north-switch">
                                            <input type="checkbox" id="webhook_scheduler_status" class="switch-condition-mode" name="webhook_scheduler_status" tabindex="0" value="enabled" <?php checked('enabled' === $webhook_scheduler_status); ?>>
                                            <label for="condition_status">
                                                <span></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Coupon scheduler status field -->
                                <div class="setting-field">
                                    <div class="setting-field__left">
                                        <label for="coupon_scheduler_status">
                                            <?php esc_html_e('Coupons', 'north-commerce'); ?>
                                        </label>
                                        <p class="title-info">

                                        </p>
                                    </div>
                                    <div class="setting-field__right">
                                        <div class="north-switch">
                                            <input type="checkbox" id="coupon_scheduler_status" class="switch-condition-mode" name="coupon_scheduler_status" tabindex="0" value="enabled" <?php checked('enabled' === $coupon_scheduler_status); ?>>
                                            <label for="condition_status">
                                                <span></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="settings-card">
                                <?php
                                global $wpdb;

                                $statuses = ['pending', 'in-progress', 'complete', 'failed'];

                                ?>
                                <div class="tabs">
                                    <?php

                                    $scheduler_class = new North_Commerce_Event_Log;

                                    foreach ($statuses as $status) {
                                        $scheduler_class->print_status_tab($status, 1, 10);
                                    }

                                    ?>
                                </div>

                                <?php
                                // Popup dialog
                                // Future plans - generalise this to become a reusable component sitewide
                                ?>
                                <div id="eventLogDialog" class="event-log-dialog">
                                    <div id="dialog-content">
                                        <span id="dialog-close-button">&times;</span>
                                        <h2 id="dialog-title"></h2>
                                        <div id="dialog-body"></div>
                                    </div>
                                </div>
                            </div>

                        </section>

                        <div class="general-actions">
                            <a href="#" class="btn submit-btn cancel" name="general-cancel">
                                <?php esc_html_e('Cancel', 'north-commerce'); ?>
                            </a>
                            <input
                                type="submit"
                                class="btn submit-btn activate"
                                name="update_settings"
                                value="<?php esc_attr_e('Save settings', 'north-commerce'); ?>"
                            >
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>