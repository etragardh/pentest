<?php

$licence_key = get_option('north_commerce_licence_key') ?: '';

if (isset($_POST['disconnect_licence'])) { // phpcs:ignore WordPress.Security.NonceVerification.Missing
   $deactivate_response = $this->deactivate_product();
}

if (isset($_POST['connect_licence'])) { // phpcs:ignore WordPress.Security.NonceVerification.Missing
   if (!empty($_POST['north_commerce_licence_key'])) { // phpcs:ignore WordPress.Security.NonceVerification.Missing
      $activate_response = $this->activate_product(sanitize_text_field($_POST['north_commerce_licence_key']));
      $licence_key = $activate_response['key'];
   }
}

?>
<div class="wrap north-settings">
   <div class="north-tab-wrapper">
      <?php $this->plugin_tabs(); ?>
   </div>
   <?php do_action('north_commerce_notices'); ?>
   <div id="wpmdb-main">
      <div id="settings-tab" class="settings-tab content-tab">
         <div class="settings-tab__head">
            <div class="head__wrapper">
               <h2>
                  <?php esc_html_e( 'Settings', 'north-commerce' ); ?>
               </h2>
               <p>
                  <?php esc_html_e( 'You can manage and customize your licenses.', 'north-commerce' ); ?>
               </p>
            </div>
         </div>
         <div class="settings-tab__body settings">
            <sidebar class="settings__sidebar settings-card">
               <?= $this->template('nav', 'settings/components'); ?>
            </sidebar>
            <div class="settings__content">
               <section class="license">
                  <div class="settings-card">
                     <?php

                     if (isset($activate_response)) {
                     ?>
                        <div class="<?php echo $activate_response['status'] === true ? 'north-success' : 'north-error'; ?>" style="display: block;"><?php echo $activate_response['message']; ?></div>
                     <?php
                     }

                     if (isset($deactivate_response)) {
                     ?>
                        <div class="<?php echo $deactivate_response['status'] === true ? 'north-success' : 'north-error'; ?>" style="display: block;"><?php echo $deactivate_response['message']; ?></div>
                     <?php
                     }

                     ?>
                     <form id="product_edit" method="POST">
                        <h3>Plugin license</h3>
                        <?php
                        if (North_Commerce_Admin::is_plugin_activated()) {
                        ?>
                           <p class="title-info">You have already activated the product.</p>
                           <label for="north_commerce_licence_key">Your license key</label>
                           <input type="password" name="north_commerce_licence_key" id="north_commerce_licence_key" value="<?php echo esc_html($licence_key); ?>" readonly>
                           <div class="submit-wrapper">
                              <input type="submit" class="btn submit-btn disconnect" name="disconnect_licence" value="Deactivate license">
                              <div class="loader" style="display: none;"></div>
                           </div>
                        <?php
                        } else {
                        ?>
                           <p class="title-info">Enter your license to receive live payments (<a href="https://northcommerce.com/pricing">No license</a>?).</p>
                           <label for="north_commerce_licence_key">Your license key</label>
                           <input type="password" name="north_commerce_licence_key" id="north_commerce_licence_key" value="<?php echo esc_html($licence_key); ?>">
                           <div class="submit-wrapper">
                              <input type="submit" class="btn submit-btn activate" name="connect_licence" value="Activate license">
                              <div class="loader" style="display: none;"></div>
                           </div>
                        <?php
                        }
                        ?>
                     </form>
                  </div>
                  <div class="settings-card">
                     <h3>Updates</h3>
                     <p class="title-info">Youâ€™re using the latest version.</p>
                     <div class="version">
                        <p class="version__title">
                           Current Version
                        </p>
                        <p class="version__number">
                           <?php echo NORTH_COMMERCE_VERSION; ?>
                        </p>
                     </div>
                     <div class="version">
                        <p class="version__title">
                           DB Schema Version
                        </p>
                        <p class="version__number">
                           <?= North_Commerce_Db_Agent::instance()->schema()->installedVersion() ?>
                        </p>
                     </div>
                  </div>
               </section>
            </div>
         </div>
      </div>
   </div>
</div>