<?php

defined('ABSPATH') || exit;

use NorthCommerce\Models\ShippingProfileModel;

/**
 * Shipping and delivery tab
 *
 * @package north-commerce/admin/templates/settings
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.2
 * @version 0.1.24
 */

$profile_model = new ShippingProfileModel();

$default_profile = $profile_model->get_regional_default();
$custom_regional_profiles = $profile_model->list_regional_custom();

$settings_page_url = admin_url( 'admin.php?page=north-commerce-settings' );
$shipment_tab_url = $settings_page_url . '&tab=shipment';
$subtemplates_dir = 'shipment';

$render_warehouse_address = function () use ( $default_profile ) {
	if ( ! $default_profile['shipping_address'] ) {
		?>
		<button type="button" class="add-button add-new-address-button">
			<span class="add-button__icon"></span>
			<span class="add-button__label">
				<?php esc_html_e( 'Add new ship from address', 'north-commerce' ); ?>
			</span>
		</button>
		<?php

		return;
	}

	?>
	<span class="store-address-section address">
		<span class="address__icon"></span>
		<span class="address__title">
			<?php
			echo esc_html( $default_profile['shipping_address']['preformatted_line'] );
			?>
		</span>
		<span class="address__country">
			<?php
			echo esc_html( $default_profile['shipping_address']['country']['name'] );
			?>
		</span>
	</span>
	<?php
};

?>
<div class="wrap north-settings">
	<div class="north-tab-wrapper">
		<?php $this->plugin_tabs(); ?>
	</div>
	<?php do_action('north_commerce_notices'); ?>
	<div id="wpmdb-main">
		<div id="settings-tab" class="settings-tab content-tab">
			<div class="settings-tab__head">
				<div class="head__wrapper">
					<h2>
						<?php esc_html_e( 'Settings', 'north-commerce' ); ?>
					</h2>
					<p>
						<?php esc_html_e( 'You can manage and customize your shipping profiles.', 'north-commerce' ); ?>
					</p>
				</div>
			</div>

			<div class="settings-tab__body settings">
				<sidebar class="settings__sidebar settings-card">
					<?php $this->template( 'nav', 'settings/components' ); ?>
				</sidebar>
				<div class="settings__content">
					<section class="shipment">
						<div class="settings-card">
							<div class="settings-card__header">
								<h3>
									<?php esc_html_e( 'Shipping Profiles', 'north-commerce' ); ?>
								</h3>
								<p class="title-info title-info--zero-mg">
									<?php esc_html_e( 'Choose where you ship and how much you charge for shipping at checkout.', 'north-commerce' ); ?>
								</p>
							</div>

							<div
								class="single-shipping-profile"
								data-id="<?php echo esc_attr( $default_profile['id'] ); ?>"
							>
								<?php
								$this->template( 'template-address-dropdown', $subtemplates_dir, [
									'shipping_profile' => $default_profile,
								] );

								?>
								<div class="single-shipping-profile__header">
									<p class="single-shipping-profile__title">
										<?php
										echo esc_html( $default_profile['name'] );
										echo esc_html__( ' shipping rates', 'north-commerce' );
										?>
									</p>
									<p class="single-shipping-profile__info">
										<?php esc_html_e( 'All products that are not in other profiles.', 'north-commerce' ); ?>
									</p>
									<a
										href="<?php echo esc_url( $shipment_tab_url . '&id=' .  $default_profile['id'] ); ?>"
										class="btn submit-btn manage"
									>
										<?php esc_html_e( 'Manage', 'north-commerce' ); ?>
									</a>
								</div>
								<?php

								$this->template( 'template-regional-rates', $subtemplates_dir, [
									'profile' => $default_profile,
								] );

								?>
							</div>
						</div>

						<div class="settings-card">
							<div class="card-header">
								<div class="card-header__header">
									<p class="card-header__title">
										<?php esc_html_e( 'Custom shipping rates', 'north-commerce' ); ?>
									</p>
									<p class="card-header__info">
										<?php esc_html_e( 'Create a shipping profile to add custom rates for groups of products.', 'north-commerce' ); ?>
									</p>
								</div>
							</div>
							<?php

							if ( $custom_regional_profiles ) {
								?>
								<hr>
								<div class="custom-shipping-profiles">
									<?php
									foreach ( $custom_regional_profiles as $profile ) {
										?>
										<div
											class="single-shipping-profile single-shipping-profile--custom"
											data-id="<?php echo esc_attr( $profile['id'] ); ?>"
										>
											<?php
											$this->template( 'template-address-dropdown', $subtemplates_dir, [
												'shipping_profile' => $profile,
											] );

											?>
											<div class="single-shipping-profile__header">
												<p class="single-shipping-profile__title">
													<?php echo esc_html( $profile['name'] ); ?>
												</p>
												<p class="single-shipping-profile__info">
													<?php
													printf(
														esc_html__( '%s products', 'north-commerce' ),
														$profile_model->count_related_products( $profile['id'] )
													);
													?>
												</p>
												<a
													href="<?php echo esc_url( $shipment_tab_url . '&id=' . $profile['id'] ); ?>"
													class="btn submit-btn manage"
												>
													<?php esc_html_e( 'Manage', 'north-commerce' ); ?>
												</a>
											</div>
											<?php

											$this->template( 'template-regional-rates', $subtemplates_dir, compact(
												'profile',
											) );

											?>
										</div>
										<?php
									}
									?>
								</div>
								<?php
							}

							?>
							<a
								href="<?php echo esc_url( $shipment_tab_url . '&new' ); ?>"
								class="add-button"
							>
								<span class="add-button__icon"></span>
								<span class="add-button__label">
									<?php esc_html_e( 'Create new profile', 'north-commerce' ); ?>
								</span>
							</a>
						</div>

						<div class="settings-card">
							<div class="card-header">
								<div class="card-header__left">
									<p class="card-header__title">
										<?php esc_html_e( 'Local Delivery', 'north-commerce' ); ?>
									</p>
									<p class="card-header__info">
										<?php esc_html_e( 'Deliver orders directly to local customers.', 'north-commerce' ); ?>
									</p>
								</div>
								<div class="card-header--right">
									<!-- TODO: When we add more delivery zone options add id's here -->
									<a
										href="<?php echo esc_url( $shipment_tab_url . '&local-delivery=' . $default_profile['id'] ); ?>"
										class="btn submit-btn manage"
									>
										<?php esc_html_e( 'Manage Local Delivery', 'north-commerce' ); ?>
									</a>
								</div>

							</div>
							<?php

							$render_warehouse_address();

							?>
						</div>
						<div class="settings-card">
							<div class="card-header">
								<div class="card-header--left">
									<p class="card-header__title">
										<?php esc_html_e( 'Local Pickup', 'north-commerce' ); ?>
									</p>
									<p class="card-header__info">
										<?php esc_html_e( 'Allow local customers to pick up their orders.', 'north-commerce' ); ?>
									</p>
								</div>
								<div class="card-header--right">
									<!-- TODO: When we add more delivery zone options add id's here -->
								<a
									href="<?php echo esc_url( $shipment_tab_url . '&local-pickup=' . $default_profile['id'] );  ?>"
									class="btn submit-btn manage"
								>
									<?php esc_html_e( 'Manage Local Pickup', 'north-commerce' ); ?>
								</a>
								</div>
							</div>
							<?php

							$render_warehouse_address();

							?>
						</div>
					</section>
				</div>
			</div>
		</div>
	</div>
</div>
<?php

// Render popup forms
$this->template( 'popup-shipment-address-manager', "$subtemplates_dir/popups" );
$this->template( 'popup-shippinng-profile-delete', "$subtemplates_dir/popups",  [
	'options' => [
		'identifier' => [
			'input_name' => 'address_id',
			'input_value' => '',
			'form_class' => 'shipping-address-delete-popup'
		],
		'heading' => __( 'Delete Shipping Address', 'north-commerce' ),
		'title' => __( 'Are you sure you want to delete this address?', 'north-commerce' ),
		'description' => __( 'This address will be deleted immediately. You canâ€™t undo this action.', 'north-commerce' ),
	]
] );
