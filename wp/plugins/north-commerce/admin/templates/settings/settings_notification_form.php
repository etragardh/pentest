<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\NotificationModel;
use North_Commerce_Notification_Template_Variables as Template_Variables;

/**
 * Notification form template.
 *
 *
 * @package north-commerce/admin
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.0
 * @version 0.1.19
 */

$notification_slug = sanitize_text_field( $_GET['notification'] ?? '' );

$notification_model = new NotificationModel();
$notification = $notification_model->get_by_slug( $notification_slug );

$template_variables = new Template_Variables;
$notification_relation = $template_variables->get_notification_relation( $notification );
$notification_variables = $template_variables->get_notification_variables( $notification );

?>
<div class="north-settings">
    <form class="single-notification notification-form" data-notification-id="<?php echo $notification['slug']; ?>">
        <div class="notification-form__header">
            <div class="notification-form__wrapper">
                <a href="<?php echo esc_url( 'admin.php?page=north-commerce-settings&tab=notifications' ); ?>" class="btn btn-prev"></a>
                <h2><?php echo $notification['title']; ?></h2>
            </div>
            <div class="notification-form__wrapper">
                <a
                    class="btn notification-form__action notification-form__action-test"
                    href="javascript:void(0);"
                    title="<?php esc_attr_e( 'Test', 'north-commerce' ); ?>"
                    >
                </a>
                <a
                    class="btn notification-form__action notification-form__action-preview"
                    href="javascript:void(0);"
                    title="<?php esc_attr_e( 'Preview', 'north-commerce' ); ?>"
                    >
                </a>
                <input type="submit" class="btn action action-save" value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>">
            </div>
        </div>
        <div class="notification-form__body">
            <div class="card notification-form__content">
                <div class="notification-form__form form-notification">
                    <div class="form-notification__toggle-block">
                        <a class="form-notification__toggle active" data-notification-type="email" href="javascript:void(0);"><?php esc_html_e( 'Email', 'north-commerce' ); ?></a>
                        <a class="form-notification__toggle" data-notification-type="sms" href="javascript:void(0);"><?php esc_html_e( 'SMS', 'north-commerce' ); ?></a>
                    </div>
                    <div class="form-notification__content active" data-notification-type="email">
                        <div class="toggle-line">
                            <div class="toggle-line__name">
                                <?php esc_html_e( 'Email notification enabled', 'north-commerce' ); ?>
                            </div>
                            <div class="toggle-line__toggle">
                                <div class="switch">
                                    <input
                                        type="checkbox"
                                        class="notification-email"
                                        name="notification-email"
                                        data-notification-id="<?php echo $notification['slug'] ?>"
                                        <?php checked( $notification['email_enabled'] ); ?>
                                        >
                                    <label class="switch-service-label" for="notification-email">
                                        <span class="switch-dot"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-notification__fields-block">
                            <div class="form-notification__field notification-field">
                                <label for="notification-email-subject" class="notification-field__name">
                                    <?php esc_html_e( 'Email subject', 'north-commerce' ); ?>
                                </label>
                                <input
                                    type="text"
                                    name="notification-email-subject"
                                    class="notification-field__input"
                                    value="<?php echo esc_attr( $notification['email_subject'] ); ?>"
                                    >
                            </div>

                            <div class="form-notification__field notification-field">
                                <label for="notification-recipients-list" class="notification-field__name">
                                    <?php esc_html_e( 'Additional recipients (comma seperated list)', 'north-commerce' ); ?>
                                </label>
                                <input
                                    type="text"
                                    name="notification-recipients-list"
                                    class="notification-field__input"
                                    value="<?php echo esc_attr( $notification['recipients_list'] ); ?>"
                                >
                            </div>

                            <div class="form-notification__field notification-field">
                                <label for="notification-email-body" class="notification-field__name">
                                    <?php esc_html_e( 'Email body (HTML)', 'north-commerce' ); ?>
                                </label>
                                <textarea type="text" name="notification-email-body" class="notification-field__input"><?php
                                    echo $notification['email_body'];
                                ?></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-notification__content" data-notification-type="sms">
                        <div class="toggle-line">
                            <div class="toggle-line__name"><?php esc_html_e( 'SMS notification enabled', 'north-commerce' ); ?></div>
                                <div class="toggle-line__toggle">
                                    <div class="switch">
                                    <input
                                        type="checkbox"
                                        class="notification-sms"
                                        name="notification-sms"
                                        <?php checked( $notification['sms_enabled'] ); ?>
                                        >
                                    <label class="switch-service-label" for="notification-sms">
                                        <span class="switch-dot"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-notification__fields-block">
                            <div class="form-notification__field notification-field">
                                <label for="notification-sms-content" class="notification-field__name">
                                    <?php esc_html_e( 'Content', 'north-commerce' ); ?>
                                </label>
                                <textarea type="text" name="notification-sms-content" class="notification-field__input"><?php
                                    echo esc_html( stripcslashes( $notification['sms_body'] ) );
                                ?></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card notification-form__sidebar">
                <h3>
                    <?php esc_html_e( 'Template variables', 'north-commerce' ); ?>
                </h3>
                <p>
                    <?php esc_html_e( 'You can use liquid variables to output an accent colour and logo image in your templates. The available variables are:', 'north-commerce' ); ?>
                </p>
                <?php
                if ( $notification_variables ) {
                    ?>
                    <ul class="notification-form__variables" data-notification-relation="<?php echo $notification_relation; ?>">
                        <?php
                        $count = 0;
                        foreach ( $notification_variables as $key => $value ) {
                            if ( ++$count >= 5 && count( $notification_variables ) > $count ) {
                                ?><li><?php echo 'etc'; ?></li><?php
                                break;
                            } else {
                                ?><li><?php echo esc_html( $value['label'] ); ?></li><?php
                            }
                        }
                        ?>
                    </ul>
                    <label for="notification-variable"><?php esc_html_e( 'Add variable', 'north-commerce' ); ?></label>
                    <select
                        class="north-single-select"
                        data-minimum-results-for-search="Infinity"
                        name="notification-variable"
                        id="notification-variable"
                        >
                        <?php
                        foreach ( $notification_variables as $var_name => $var_data ) {
                            if ( ! empty( $var_data['hidden'] ) ) {
                                continue;
                            }

                            ?><option value="<?php echo esc_attr( $var_name ); ?>"><?php echo esc_html( $var_data['label'] ); ?></option><?php
                        }
                        ?>
                    </select>
                    <?php
                }
                ?>

                <a class="notification-form__readmore" href="javascript:void(0);">
                    <?php esc_html_e( 'Read more about using variables', 'north-commerce' ); ?>
                </a>
            </div>
        </div>
    </form>

    <form class="admin-popup notification-preview-popup">
        <div class="admin-popup__header">
            <div class="admin-popup__left-side">
                <h3 class="integration-popup-name"><?php esc_html_e( 'Preview', 'north-commerce' ); ?></h3>
                <div class="loader" style="display: none;"></div>
            </div>
            <a
                href="javascript:void(0);"
                class="admin-popup__close"
                data-fancybox-close
            ></a>
        </div>
        <div class="admin-popup__body">
            <div class="admin-popup__notice"></div>
            <div class="admin-popup__content"></div>
        </div>
    </form>

    <form class="admin-popup notification-test-send" data-form-type="email">
        <div class="admin-popup__header">
            <div class="admin-popup__left-side">
                <h3 class="integration-popup-name"><?php esc_html_e( 'Send Notification', 'north-commerce' ); ?></h3>
                <div class="loader" style="display: none;"></div>
            </div>
            <a
                href="javascript:void(0);"
                class="admin-popup__close order-popup-close"
                data-fancybox-close
            ></a>
        </div>
        <div class="admin-popup__body">
            <div class="admin-popup__content notification-send">
                <div class="admin-popup-field notification-send__email">
                    <label for="test_email"><?php esc_html_e( 'Email', 'north-commerce' ); ?></label>
                    <input type="email" name="test_email" class="test_email">
                </div>
                <div class="admin-popup-field notification-send__sms">
                    <label for="test_phone"><?php esc_html_e( 'Phone', 'north-commerce' ); ?></label>
                    <input type="tel" name="test_phone" class="test_phone">
                </div>
            </div>
            <div class="admin-popup__notice">
                <div class="north-success"><?php esc_html_e( 'Notification sent successfully!', 'north-commerce' ); ?></div>
            </div>
            <div class="admin-popup__actions">
                <a
                    href="javascript:void(0);"
                    data-fancybox-close=""
                    class="admin-popup-cancel admin-popup__close order-popup-close"
                >
                    <span><?php esc_html_e( 'Cancel', 'north-commerce' ); ?></span>
                </a>
                <input
                    class="admin-popup-submit"
                    type="submit"
                    value="Send"
                >
            </div>
        </div>
    </form>

    <form class="admin-popup notification-about-variables">
        <div class="admin-popup__header">
            <div class="admin-popup__left-side">
                <h3 class="integration-popup-name"><?php esc_html_e( 'About variables', 'north-commerce' ); ?></h3>
            </div>
            <a
                href="javascript:void(0);"
                data-fancybox-close
                class="admin-popup__close order-popup-close"
            ></a>
        </div>
        <div class="admin-popup__body">
            <div class="admin-popup__notice"></div>
            <div class="admin-popup__content">
                <?php esc_html_e( 'Text about variables', 'north-commerce' ); ?>
            </div>
            <div class="admin-popup__actions">
                <a
                    href="javascript:void(0);"
                    data-fancybox-close
                    class="admin-popup__close order-popup-close admin-popup-submit"
                    style="text-decoration:none;"
                >OK</a>
            </div>
        </div>
    </form>

</div>
