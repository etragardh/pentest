<?php

defined( 'ABSPATH' ) || exit;

/**
 * @package north-commerce/admin/templates/shipment/popups
 * @author  North Plugins <hello@northcommerce.com=>
 * @link    https://northcommerce.com/
 * @since   0.1.0
 * @version 0.1.24
 */


$profile_model = new NorthCommerce\Models\ShippingProfileModel();

( new North_Commerce_Shipping_Profile() )->template( 'popup-shipping-product-duplicate-manager', 'shipment/popups' );

?>
<form class="popup-manage-shipping-profile-products admin-popup north-settings">
	<input type="hidden" name="shipping_zone_id">

	<div class="admin-popup__header">
		<div class="admin-popup__left-side">
			<h3 class="integration-popup-name">
				<?php esc_html_e( 'Manage Products for Profile', 'north-commerce' ); ?>
			</h3>
			<div class="loader"></div>
		</div>
		<a
			href="javascript:void(0);"
			class="admin-popup__close"
			data-fancybox-close
		></a>
	</div>

	<div class="admin-popup__body">
		<div class="admin-popup__notice"></div>

		<div class="admin-popup__content">
			<div class="popup-field-new search-input">
				<div class="popup-field-new__input-wrapper search-input">
					<input
						type="text"
						data-field-name="product_name_search"
						name="product_name_search"
						class="product_name_search popup-field-new__text-input"
						id="product_name_search"
						placeholder="<?php esc_attr_e( 'Search by product name', 'north-commerce' ); ?>"
						value=""
						>
					<label for="product_name_search" class="popup-field-new__input-wrapper__icon search-icon">
					</label>
				</div>
			</div>

			<div class="products-selectors-not-found hide">
				<?php esc_html_e( 'No results for', 'north-commerce' ); ?>
				<span class="products-selectors-not-found__search"></span>
			</div>

			<?php
			$shippable_products = $profile_model->list_shippable_products();
			$profile_related_products = isset( $shipping_profile['id'] )
				? $profile_model->list_related_products( $shipping_profile['id'] )
				: array();
			?>

			<div
				class="products-selectors"
				data-products="<?php echo htmlspecialchars( json_encode( $shippable_products ), ENT_QUOTES, 'UTF-8' ); ?>"
			>
				<?php

				foreach ( $shippable_products as $product ) {

					$product_has_variants = $product['product_variants']
						&& (
							count( $product['product_variants'] ) !== 1
							|| 'solo' !== reset( $product['product_variants'] )['product_variant_type']['slug']
						);

					$related_shipping_profiles = $related_profiles_html = array();
					if ( ! $product_has_variants ) {
						$related_profiles_data = $product['product_variants']
							? reset( $product['product_variants'] )['related_shipping_profiles']
							: [];

						foreach ( $related_profiles_data as $profile_id => $profile_name ) {
							$related_shipping_profiles[ intval( $profile_id ) ] = $profile_name;

							if (
								isset( $shipping_profile['id'] )
								&& $profile_id === intval( $shipping_profile['id'] )
							) {
								continue;
							}

							$related_profiles_html[] = sprintf(
								'<span data-id="%d">%s</span>',
								$profile_id,
								$profile_name
							);
						}
					}

					?>
					<div
						class="products-selectors__product parent-holder <?php echo esc_attr( 'product-' . $product['id'] ); ?>"
						data-level="product"
						data-shipping-profiles="<?php echo htmlspecialchars( json_encode( $related_shipping_profiles ), ENT_QUOTES, 'UTF-8' ); ?>"
						data-id="<?php echo esc_attr( $product['id'] ); ?>"
					>
						<div class="products-selectors__product__wrapper">
							<div class="products-selectors__product__checkbox">
								<input
									type="checkbox"
									name="products[]"
									class="products-selectors__checkbox north-checkbox__handler"
									id="<?php echo esc_attr( 'product_' . $product['id'] ); ?>"
									value="<?php echo esc_attr( $product['id'] ); ?>"
									<?php checked( isset( $profile_related_products[ intval( $product['id'] ) ] ) ); ?>
								>
								<label for="<?php echo esc_attr( 'product_' . $product['id'] ) ?>" class="north-checkbox">
								</label>
							</div>

							<label
								for="<?php echo esc_attr( 'product_' . $product['id'] ); ?>"
								class="products-selectors__product__img"
							>
								<img
									src="<?php echo esc_url( $product['product_images'][0] ); ?>"
									alt="<?php echo esc_attr( $product['name'] ); ?>"
								>
							</label>

							<label
								for="<?php echo esc_attr( 'product_' . $product['id'] ); ?>"
								class="products-selectors__product__label"
							>
								<?php echo esc_html( $product['name'] ); ?>
							</label>

							<div class="products-selectors__product__info">
								<?php

								if ( $related_profiles_html ) {
									printf(
										'In <span class="%1$s">%2$s</span>',
										'shipping-profiles',
										implode( ', ', $related_profiles_html )
									);
								}

								?>
							</div>

							<label
								for="<?php echo esc_attr( 'show_variation_dropdown_' . $product['id'] ); ?>"
								class="products-selectors__product__handler<?php echo ! $product_has_variants ? ' hide' : ''; ?>"
							>
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
									<path d="M12.0002 15.713L18.0102 9.70299L16.5972 8.28799L12.0002 12.888L7.40423 8.28799L5.99023 9.70199L12.0002 15.713Z">
								</svg>
							</label>
						</div>

						<input
							type="checkbox"
							id="<?php echo esc_attr( 'show_variation_dropdown_' . $product['id'] ); ?>"
							class="products-selectors__product__expander"
						>

						<div class="sub-items children-items<?php echo ! $product_has_variants ? ' hide' : ''; ?>">
							<?php
							if ( $product_has_variants ) {
								$related_variants = $profile_related_products[ intval( $product['id'] ) ]['product_variants'] ?? [];

								foreach ( $product['product_variants'] as $variant ) {
									if ( 'solo' === $variant['product_variant_type']['slug'] ) {
										continue;
									}

									$variant_attr_id = 'product-' . $product['id'] . '_variant-' . $variant['id'];

									$related_shipping_profile_ids = $related_profiles = array();
									foreach ( $variant['related_shipping_profiles'] as $profile_id => $profile_name ) {
										$related_shipping_profile_ids[ intval( $profile_id ) ] = $profile_name;

										$related_profiles[] = sprintf(
											'<span data-id="%d">%s</span>',
											$profile_id,
											$profile_name
										);
									}

									?>
									<div
										class="sub-item parent-holder <?php echo esc_attr( $variant_attr_id ); ?>"
										data-level="variant"
										data-shipping-profiles="<?php echo htmlspecialchars( json_encode( $related_shipping_profile_ids ), ENT_QUOTES, 'UTF-8' ); ?>"
										data-id="<?php echo esc_attr( $variant['id'] ); ?>"
									>
										<div class="sub-item__wrapper">
											<div class="sub-item__checkbox">
												<input
													type="checkbox"
													name="variants[]"
													id="<?php echo esc_attr( $variant_attr_id ); ?>"
													class="sub-item__checkbox__input products-selectors__checkbox north-checkbox__handler"
													value="<?php echo esc_attr( $variant['id'] ); ?>"
													<?php checked( isset( $related_variants[ intval( $variant['id'] ) ] ) ); ?>
												>
												<label for="<?php echo esc_attr( $variant_attr_id ); ?>" class="north-checkbox">
												</label>
											</div>

											<label for="<?php echo esc_attr( $variant_attr_id ); ?>" class="sub-item__label">
												<?php echo esc_html( $variant['slug'] ); ?>
											</label>

											<div class="sub-item__info">
												<?php
												if ( $related_profiles ) {
													printf(
														'In <span class="%1$s">%2$s</span>',
														'shipping-profiles',
														implode( ', ', $related_profiles )
													);
												}
												?>
											</div>
										</div>
									</div>
									<?php
								}
							}
							?>
						</div>
					</div>
					<?php
				}
				?>
			</div>

			<div class="admin-popup__actions">
				<a
					href="javascript:void(0);"]
					class="btn btn--cancel admin-popup-cancel"
					data-fancybox-close
				>
					<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
				</a>
				<input
					type="submit"
					class="btn btn--submit admin-popup-submit"
					value="<?php esc_attr_e( 'Update Products List', 'north-commerce' ); ?>"
					disabled
				>
			</div>
		</div>
	</div>
</form>
