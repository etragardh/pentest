<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\{
	ShippingProfileModel,
	CountryModel
};

/**
 * @package north-commerce/admin/templates/shipment/popups
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.1
 * @version 0.1.24
 */


use North_Commerce_Settings as Settings;
use North_Commerce_Easypost as Easypost;

$profile_model = new ShippingProfileModel();
$country_model = new CountryModel();
$profile_class = new North_Commerce_Shipping_Profile();
$easypost_class = new Easypost();

$addresses = $profile_model->list_addresses();


?>
<form class="shipping-zone-add-rate-popup admin-popup north-settings">
	<input type="hidden" name="zone_id">
	<input type="hidden" name="rate_id" value="">

	<div class="admin-popup__header">
		<div class="admin-popup__left-side">
			<h3 class="integration-popup-name">
				<?php esc_html_e( 'Add rate', 'north-commerce' ); ?>
			</h3>
			<div class="loader"></div>
		</div>
		<a
			href="javascript:void(0);"
			class="admin-popup__close"
			data-fancybox-close
		></a>
	</div>

	<div class="admin-popup__body">
		<div class="admin-popup__notice"></div>

		<div class="admin-popup__content">
			<div class="rates-types">
				<div class="rate-type">
					<label class="north-radio">
						<input
							type="radio"
							name="rate_calculation"
							value="internal"
						>
						<span class="north-radio__label">
							<?php esc_html_e( 'Set up your own rate', 'north-commerce' ); ?>
						</span>
					</label>
				</div>

				<div class="rate-type">
					<label class="north-radio">
						<input
							type="radio"
							name="rate_calculation"
							value="easypost"
							data-test-mode="<?php echo intval( $easypost_class->is_connected() && $easypost_class->is_test_mode() ); ?>"
						>
						<span class="north-radio__label">
							<?php
							esc_html_e( 'Use carrier to calculate rates', 'north-commerce' );

							if ( ! $easypost_class->is_connected() ) {
								?>
								<span class="rate-type__message">
									<?php esc_html_e( 'To use this feature you need to setup', 'north-commerce' ); ?>
									<a href="<?php echo admin_url( 'admin.php?page=north-commerce-integration' ); ?>" target="_blank">
										<?php esc_html_e( 'Easypost integration', 'north-commerce' ); ?>
									</a>
								</span>
								<?php
							}
							?>
						</span>
					</label>
				</div>
			</div>

			<div class="rates-types__configuration">
				<div class="rate-type-configuration internal">
					<div class="internal__group-fields">
						<div class="popup-field-new">
							<label class="popup-field-new__label" for="rate_name">
								<?php esc_html_e( 'Rate name', 'north-commerce' ); ?>
							</label>

							<div class="popup-field-new__input-wrapper">
								<input
									type="text"
									name="rate_name"
									id="rate_name"
									class="rate_name popup-field-new__text-input"
									value=""
								>
							</div>
						</div>
						<div class="popup-field-new full-width admin-popup-field_half">
							<label for="rate_price">
								<?php esc_html_e( 'Price', 'north-commerce' ); ?>
							</label>
							<div class="popup-field-new__input-wrapper price-input">
								<input
									type="number"
									name="rate_price"
									id="rate_price"
									class="rate_price popup-field-new__text-input"
									min="0"
									step="0.01"
									placeholder="0.00"
								>
								<span class="unit-icon currency-symbol">
									<?php echo Settings::get_currency_symbol(); ?>
								</span>
								<div class="free-icon">
									<div class="free-icon__wrapper">
										<?php esc_html_e( 'Free', 'north-commerce' ); ?>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="internal-rate__conditions">
						<div class="conditions__header">
							<div class="header__title">
								<?php esc_html_e( 'Conditions', 'north-commerce' ); ?>
							</div>
							<div class="header__info">
								<?php esc_html_e( 'Add conditions for this rate.', 'north-commerce' ); ?>
							</div>
							<div class="header__handler">
								<div class="north-switch">
									<input
										type="checkbox"
										name="rate_has_conditions"
										id="rate_has_conditions"
										class="switch-condition-mode"
										tabindex="0"
										value="enabled"
									>
									<label for="rate_has_conditions">
										<span></span>
									</label>
								</div>
							</div>
						</div>

						<div class="conditions__body hide">
							<div class="conditions__logic">
								<label class="north-radio">
									<input
										type="radio"
										name="rate_conditions_operator"
										value="all"
									>
									<span class="north-radio__label">
										<?php esc_html_e( 'All conditions are met', 'north-commerce' ); ?>
									</span>
								</label>
								<label class="north-radio">
									<input
										type="radio"
										name="rate_conditions_operator"
										value="any"
									>
									<span class="north-radio__label">
										<?php esc_html_e( 'Any conditions are met', 'north-commerce' ); ?>
									</span>
								</label>
							</div>

							<table class="conditions__items hide">
								<thead>
									<tr>
										<th>
											<?php esc_html_e( 'Type', 'north-commerce' ); ?>
										</th>
										<th>
											<?php esc_html_e( 'Condition', 'north-commerce' ); ?>
										</th>
										<th></th>
									</tr>
								</thead>
								<tbody>
									<?php
									$profile_class->template( 'shipment-rate-condition-item-template', 'shipment' );
									?>
								</tbody>
							</table>

							<div class="conditions__add-form">
								<div class="popup-field-new">
									<label class="popup-field-new__label" for="select-type">
										<?php esc_html_e( 'Based on', 'north-commerce' ); ?>
									</label>

									<div class="popup-field-new__input-wrapper">
										<select
											class="popup-field-new__input conditions__type"
											name="select-type"
											id="select-type"
											data-minimum-results-for-search="Infinity"
										>
											<?php
											$condition_bases = $profile_model->list_shipping_rate_condition_bases();
											foreach ( $condition_bases as $index => $base ) {
												echo '<option',
													' value="' . esc_attr( $base['slug'] ) . '"',
													selected( $index, 0, false ),
													'>',
													esc_html( $base['name'] ),
												'</option>';
											}
											?>
										</select>
									</div>
								</div>

								<div class="internal-rate-prompt-wrapper">
									<input type="hidden" data-condition-id value="">

									<div class="internal-rate__prompt active" data-prompt-type="weight">
										<div class="prompt__options">
											<div class="popup-field-new popup-field-new_half">
												<label class="popup-field-new__label">
													<?php esc_html_e( 'Minimum weight', 'north-commerce' ); ?>
												</label>
												<div class="popup-field-new__input-wrapper">
													<input
														type="number"
														name="minimum_weight"
														class="popup-field-new__text-input"
														id="minimum_weight"
														placeholder="0"
														value=""
													>
													<span class="unit-icon">
														<?php echo Settings::get_weight_unit(); ?>
													</span>
												</div>
											</div>

											<div class="popup-field-new admin-popup-field_half">
												<label class="popup-field-new__label">
													<?php esc_html_e( 'Maximum weight', 'north-commerce' ); ?>
												</label>
												<div class="popup-field-new__input-wrapper">
													<input
														type="number"
														name="maximum_weight"
														class="popup-field-new__text-input"
														placeholder="<?php esc_attr_e( 'No limit', 'north-commerce' ); ?>"
														value=""
													>
													<span class="unit-icon">
														<?php echo Settings::get_weight_unit(); ?>
													</span>
												</div>
											</div>
										</div>
										<?php

										$prompt_actions = function () {
											?>
											<div class="own-rate__prompt__actions">
												<input
													class="btn btn--cancel cancel-condition-update"
													type="button"
													value="<?php esc_attr_e( 'Discard', 'north-commerce' ); ?>"
												>
												<button
													class="btn btn--submit create-condition-submit"
													type="button"
													disabled
												>
													<span class="create-label">
														<?php esc_html_e( 'Save conditions', 'north-commerce' ); ?>
													</span>
													<span class="update-label">
														<?php esc_html_e( 'Update conditions', 'north-commerce' ); ?>
													</span>
												</button>
											</div>
											<?php
										};

										$prompt_actions();

										?>
									</div>

									<div class="internal-rate__prompt" data-prompt-type="price">
										<div class="prompt__options">
											<div class="popup-field-new popup-field-new_half">
												<label class="popup-field-new__label">
													<?php esc_html_e( 'Minimum price', 'north-commerce' ); ?>
												</label>
												<div class="popup-field-new__input-wrapper left-icon">
													<input
														type="number"
														name="minimum_price"
														class="popup-field-new__text-input"
														placeholder="0"
														value=""
													>
													<span class="unit-icon">
														<?php echo Settings::get_currency_symbol(); ?>
													</span>
												</div>
											</div>

											<div class="popup-field-new popup-field-new_half">
												<label class="popup-field-new__label">
													<?php esc_html_e( 'Maximum price', 'north-commerce' ); ?>
												</label>
												<div class="popup-field-new__input-wrapper left-icon">
													<input
														type="number"
														name="maximum_price"
														class="maximum_price popup-field-new__text-input"
														placeholder="<?php esc_attr_e( 'No limit', 'north-commerce' ); ?>"
														value=""
													>

													<span class="unit-icon">
														<?php echo Settings::get_currency_symbol(); ?>
													</span>
												</div>
											</div>
										</div>
										<?php

										$prompt_actions();

										?>
									</div>

									<div class="internal-rate__prompt" data-prompt-type="user-role">
										<div class="prompt__options">
											<div class="popup-field-new popup-field-new--multiple full-width">
												<label for="user_roles" class="popup-field-new__label">
													<?php esc_html_e( 'User roles', 'north-commerce' ); ?>
												</label>

												<div class="popup-field-new__input-wrapper">
													<select
														name="user_roles"
														class="popup-field-new__text-input multiple user_roles"
														id="user_roles"
													>
														<?php
														foreach ( nc_list_wp_roles() as $role_key => $role ) {
															echo '<option',
																' value="' . esc_attr( $role_key ) . '"',
																'>',
																esc_html( $role['name'] ),
															'</option>';
														}
														?>
													</select>
												</div>
											</div>
										</div>
										<?php

										$prompt_actions();

										?>
									</div><?php // internal-rate__prompt user-role ?>
								</div>
							</div>

							<div
								type="button"
								class="add-button conditions__action-add"
							>
								<span class="add-button__icon"></span>
								<span class="add-button__label">
									<?php esc_html_e( 'Add condition', 'north-commerce' ); ?>
								</span>
							</div>
						</div>
					</div>
				</div>

				<div class="rate-type-configuration easypost hide">
					<?php
					if ( $easypost_class->is_connected() ) {
						?>
						<div class="easypost__fields<?php echo ! $addresses ? ' hide' : ''; ?>">
							<div class="popup-field-new full-width">
								<label for="easy-post-carriers" class="popup-field-new__label">
									<?php esc_html_e( 'Select a carrier', 'north-commerce' ); ?>
								</label>
								<div class="popup-field-new__input-wrapper">
									<select
										name="easypost_carriers"
										id="easy-post-carriers"
										class="popup-field-new__text-input easypost-carriers-accounts"
										value=""
									>
									</select>
								</div>
							</div>

							<div class="easypost__services">
								<div class="services__title">
									<?php esc_html_e( 'Services', 'north-commerce' ); ?>
								</div>
								<div class="services__info">
									<?php esc_html_e( 'Rates are used on your customer’s address and the weight and dimensions of their order.', 'north-commerce' ); ?>
								</div>
								<div class="services__list services">
									<div class="service-item template">
										<input
											type="checkbox"
											id="easypost_service_"
											class="zone-selectors__checkbox north-checkbox__handler"
											name="easypost_services[]"
											value=""
										>
										<label for="easypost_service_" class="north-checkbox"></label>
										<label for="easypost_service_" class="service-item__label"></label>
									</div>
								</div>
							</div>

							<div class="easypost__services">
								<div class="services__title">
									<?php esc_html_e( 'Future services', 'north-commerce' ); ?>
								</div>
								<div class="services__list future-services">
									<div class="service-item">
										<input
											type="checkbox"
											id="easypost_future_services"
											class="north-checkbox__handler"
											name="future_services"
											value=""
										>
										<label for="easypost_future_services" class="north-checkbox">
											<span></span>
										</label>
										<label for="easypost_future_services" class="service-item__label">
											<?php esc_html_e( 'Automatically show new shipping services to customers when they become available', 'north-commerce' ); ?>
										</label>
									</div>
								</div>
							</div>
						</div>
						<?php
					}
					?>
				</div>

				<div class="rate__handling-fees">
					<input
						type="checkbox"
						name="rate_has_fees"
						class="rate_has_fees"
						id="rate_has_fees"
					>

					<label for="rate_has_fees" class="rate__handling-fees__add radio-status">
						<span class="icon"></span>
						<span class="add-label">
							<?php esc_html_e( 'Add handling fee', 'north-commerce' ); ?>
						</span>
						<span class="remove-label">
							<?php esc_html_e( 'Remove handling fee', 'north-commerce' ); ?>
						</span>
					</label>

					<div class="rate__handling-fees__config">
						<div class="popup-field-new full-width admin-popup-field_half">
							<label class="popup-field-new__label" for="rate_fee_flat">
								<?php esc_html_e( 'Flat amount', 'north-commerce' ); ?>
							</label>
							<div class="popup-field-new__input-wrapper left-icon">
								<input
									type="number"
									name="rate_fee_flat"
									min="0"
									step="0.01"
									class="popup-field-new__text-input rate_fee_flat"
									id="rate_fee_flat"
									placeholder="0"
									value=""
								>
								<span class="unit-icon"><?php echo Settings::get_currency_symbol(); ?></span>
							</div>
						</div>

						<div class="popup-field-new full-width admin-popup-field_half">
							<label class="popup-field-new__label" for="rate_fee_percent">
								<?php esc_html_e( 'Percentage', 'north-commerce' ); ?>
							</label>
							<div class="popup-field-new__input-wrapper">
								<input
									type="number"
									name="rate_fee_percent"
									min="0"
									step="0.01"
									class="popup-field-new__text-input rate_fee_percent"
									id="rate_fee_percent"
									placeholder="0"
									value=""
								>
								<span class="unit-icon">%</span>
							</div>
						</div>
					</div>
				</div>

				<div class="admin-popup__actions">
					<a
						href="javascript:void(0);"
						class="admin-popup-cancel"
						data-fancybox-close
					>
						<span><?php esc_html_e( 'Cancel', 'north-commerce' ); ?></span>
					</a>
					<input
						type="submit"
						class="admin-popup-submit create-rate-submit"
						value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
						disabled
					>
				</div>
			</div>
		</div>

		<div class="admin-popup__footer">
		</div>
	</div>
</form>
