<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\{
	ShippingRateConditionBases,
	ShippingZoneTypes
};
use NorthCommerce\Models\CountryModel;

/**
 * @package north-commerce/admin/templates/shipment
 * @author  North Commerce <hello@northplugins.com>
 * @since   0.1.1
 * @version 0.1.24
 */

$zone = $zone ?? null;
$is_template = ! $zone;

$zone_countries_arr = array();
$zone_options = new stdClass();
$zone_rates = array();

if ( $zone ) {
	$countries_list = ( new CountryModel() )->get_formated_list();
	$regions_countries_map = nc_get_regions_countries_map();

	$zone_options->id = $zone['id'];
	$zone_options->name = $zone['name'];

	$zone_options->regions = new stdClass();
	foreach ( $zone['shipping_countries'] as $country_code => $subunits ) {
		if ( ! isset( $countries_list[ $country_code ] ) ) {
			continue;
		}

		switch ( $zone['shipping_zone_type_id'] ) {
			case ShippingZoneTypes::regional()->id:
				$zone_countries_arr[] = $zone_countries_arr
					? ', ' . esc_html( $countries_list[ $country_code ] )
					: esc_html( $countries_list[ $country_code ] );
				break;

			case ShippingZoneTypes::local()->id:
				$zone_countries_arr[] = $countries_list[ $country_code ] . ': ' . implode( ', ', $subunits ) . '; ';
				break;

			default:
				throw new \Exception( 'Unknown Zone Type: ' . $zone['shipping_zone_type_id'] );
		}

		foreach ( $regions_countries_map as $region_code => list( 'countries' => $region_countries ) ) {
			if ( in_array( $country_code, $region_countries ) ) {
				if ( ! property_exists( $zone_options->regions, $region_code ) ) {
					$zone_options->regions->{$region_code} = new stdClass();
				}
				$zone_options->regions->{$region_code}->{$country_code} = $subunits;
				break;
			}
		}
	}

	if ( ! empty( $zone['shipping_rates_internal'] ) ) {
		foreach ( $zone['shipping_rates_internal'] as $rate ) {
			if ( empty( $zone_rates['internal'] ) ) {
				$zone_rates['internal'] = array();
			}

			$has_conditions = $rate['has_conditions'] && $rate['shipping_rate_conditions'];

			$zone_rates['internal'][] = (object) [
				'id' => $rate['id'],
				'name' => $rate['name'],
				'calculation' => 'internal',
				'hasFees' => floatval( $rate['fee_percent'] ) || floatval( $rate['fee_flat'] ),
				'feeFlat' => $rate['fee_flat'],
				'feePercent' => $rate['fee_percent'],
				'price' => $rate['price'],
				'hasConditions' => $has_conditions,
				'conditions' => array(),
			];

			if ( $has_conditions ) {
				$formatted_conditions = array();
				foreach ( $rate['shipping_rate_conditions'] as $key => $condition ) {
					$condition_options = [
						'id' => $condition['id'],
						'type' => $condition['shipping_rate_condition_base']['slug'],
					];

					if (
						ShippingRateConditionBases::weight()->slug === $condition_options['type']
						|| ShippingRateConditionBases::price()->slug === $condition_options['type']
					) {
						$condition_options['data'] = (object) [
							'min' => $condition['value_min'],
							'max' => $condition['value_max'],
						];
					}

					if ( 'user-role' === $condition_options['type'] ) {
						$condition_options['data']['userRoles'] = json_decode( $condition['value_roles'] );
					}

					$formatted_conditions[ $key ] = json_encode( $condition_options );
				}

				end( $zone_rates['internal'] )->conditionsOperator = $rate['conditions_operator'];
				end( $zone_rates['internal'] )->conditions = $formatted_conditions;
			}
		}
	}

	if ( ! empty( $zone['shipping_rates_easypost'] ) ) {
		foreach ( $zone['shipping_rates_easypost'] as $rate ) {
			if ( empty( $zone_rates['easypost'] ) ) {
				$zone_rates['easypost'] = array();
			}

			$zone_rates['easypost'][] = (object) [
				'id' => $rate['id'],
				'calculation' => 'easypost',
				'carrierID' => $rate['carrier_id'],
				'carrierLabel' => $rate['carrier_label'],
				'hasFees' => floatval( $rate['fee_percent'] ) || floatval( $rate['fee_flat'] ),
				'feeFlat' => $rate['fee_flat'],
				'feePercent' => $rate['fee_percent'],
				'services' => $rate['services'] ? json_decode( $rate['services'] ) : [],
				'futureServices' => (bool) $rate['future_services'],
			];
		}
	}
}

?>
<div
	class="shipping-zone-list__item zone-item<?php echo isset( $zone['id'] ) ? esc_attr( ' zone-item-' . $zone['id'] ) : '', $is_template ? ' template' : ''; ?>"
    data-id="<?php echo esc_attr( $zone['id'] ?? '' ); ?>"
    data-options="<?php echo htmlspecialchars( json_encode( $zone_options, true ), ENT_QUOTES, 'UTF-8' ); ?>"
>
	<div class="zone-item__header">
        <div class="header__left">
			<div class="zone-item__icon">
				<?php $this->template( 'planet', 'icons' ); ?>
			</div>

			<div class="zone-item__labels">
				<div class="zone-item__region">
					<?php echo esc_html( $zone['name'] ?? '' ); ?>
				</div>
				<div class="zone-item__countries">
					<?php echo implode( $zone_countries_arr ); ?>
				</div>
			</div>
		</div>

		<div class="header__right">
			<div class="zone-item__header__actions north-actions">
				<div class="north-actions__settings">
					<?php $this->template( 'more', 'icons' ); ?>
				</div>
				<div class="north-actions__show">
					<div class="north-actions__edit zone-item__header__actions__edit">
						<?php $this->template( 'edit', 'icons' ); ?>
					</div>
					<div class="north-actions__delete zone-item__header__actions__delete">
						<?php $this->template( 'trash', 'icons' ); ?>
					</div>
				</div>
			</div>
		</div>
	</div>
	<?php

	$internal_rates = $zone_rates['internal'] ?? [];

	?>
    <div
		class="rates-table internal<?php echo ( ! $internal_rates ? ' hide' : '' ); ?>"
        data-original-rates="<?php echo htmlspecialchars( json_encode( $internal_rates, true ), ENT_QUOTES, 'UTF-8' ); ?>"
	>
		<div class="rates-table__header">
            <div class="title">
				<?php esc_html_e( 'Rate Name', 'north-commerce' ); ?>
			</div>
            <div class="title">
				<?php esc_html_e( 'Condition', 'north-commerce' ); ?>
			</div>
            <div class="title">
				<?php esc_html_e( 'Handling fee', 'north-commerce' ); ?>
			</div>
            <div class="title">
				<?php esc_html_e( 'Price', 'north-commerce' ); ?>
			</div>
        </div>

        <div class="rates-table__body">
            <div
                class="rate-item template"
                data-options=""
			>
                <div class="rate-name"></div>
                <div class="rate-condition"></div>
                <div class="rate-has-fees"></div>
                <div class="rate-price"></div>

                <div class="north-actions">
                    <div class="north-actions__settings">
						<?php $this->template( 'more', 'icons' ); ?>
                    </div>
					<div class="north-actions__show">
						<div class="north-actions__edit edit-rate-item edit-own-rate">
							<?php $this->template( 'edit', 'icons' ); ?>
						</div>
                        <div class="north-actions__delete delete-rate">
							<?php $this->template( 'trash', 'icons' ); ?>
                        </div>
                    </div>
				</div>
            </div>
        </div>
    </div>
	<?php

	$easypost_rates = $zone_rates['easypost'] ?? [];

	?>
    <div
		class="rates-table easypost<?php echo ! count( $easypost_rates ) ? ' hide' : ''; ?>"
		data-original-rates="<?php echo htmlspecialchars( json_encode( $easypost_rates, true ), ENT_QUOTES, 'UTF-8' ); ?>"
	>
        <div class="rates-table__header">
            <div class="title">
				<?php esc_html_e( 'Carrier Name', 'north-commerce' ); ?>
			</div>
            <div class="title">
				<?php esc_html_e( 'Handling fee', 'north-commerce' ); ?>
			</div>
            <div class="title">
				<?php esc_html_e( 'Services', 'north-commerce' ); ?>
			</div>
        </div>

        <div class="rates-table__body">
            <div
				class="rate-item template"
				data-options=""
			>
                <div class="carrier-name"></div>
                <div class="rate-has-fees"></div>
                <div class="value">
                    <div class="one-item"></div>
                    <div class="multiple-items">
                        <div class="multiple-items__header">
                            <div class="multiple-items__header__label">
                            </div>
                            <div class="multiple-items__header__handler">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path fill="#008AFF" d="M7.99334 10.2833L12 6.27598L11.0573 5.33331L7.99067 8.39999L4.92867 5.33331L3.986 6.27598L7.99334 10.2833Z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="multiple-items__body">
                        </div>
                    </div>
                </div>
				<div class="placeholder">
				</div>
                <div class="north-actions">
                    <div class="north-actions__settings">
						<?php $this->template( 'more', 'icons' ); ?>
                    </div>
                    <div class="north-actions__show">
						<div class="north-actions__edit edit-rate-item edit-easypost-rate">
							<?php $this->template( 'edit', 'icons' ); ?>
						</div>
                        <div class="north-actions__delete delete-rate">
							<?php $this->template( 'trash', 'icons' ); ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<div class="zone-item__notice has-no-data<?php echo count( $zone_rates ) ? ' hide' : ''; ?>">
		<p class="title">
			<?php esc_html_e( 'No rates', 'north-commerce' ); ?>
		</p>
		<p class="description">
			<?php esc_html_e( 'Customers in this zone won`t be able to complete checkout.', 'north-commerce' ); ?>
		</p>
	</div>

	<div class="zone-item__actions">
		<button type="button" class="btn btn--cancel zone-item__add-rate">
			<?php esc_html_e( 'Add rate', 'north-commerce' ); ?>
		</button>
	</div>
	<?php

	if ( ! empty( $_GET['local-delivery'] ) ) {
		$this->template(
			'template-delivery-zone-instructions',
			'settings/local-delivery',
			compact( 'zone' )
		);
	}

	?>
</div>
