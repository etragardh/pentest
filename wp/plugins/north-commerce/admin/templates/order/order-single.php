<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Resources\Order\OrderSingleAdminResource;
use NorthCommerce\Db\Collections\{
    PaymentStatuses,
    ProductTypes
};
use NorthCommerce\Models\{
    OrderModel,
    CountryModel,
    CouponModel
};
use NorthCommerce\Db\Collections\ShippingDetailTypes;
use North_Commerce_Settings as Settings;

/**
 * Order Single template
 *
 *
 * @package north-commerce/admin/templates/order
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.0
 * @version 0.1.25
 */


$order_id = $_GET['id'];

$order_obj = new North_Commerce_Order( $order_id );
$order_model = new OrderModel();
$country_model = new CountryModel();
$counpon_model = new CouponModel();

$order = $order_model->get_by_id( $order_id );

$order_statuses = $order_model->list_statuses();
$adjacent_orders = $order_model->get_adjacent_orders_id( $order['order_number'] );

$order_currency = Settings::get_currency_symbol();

$product = $order['line_items'][0]['product_variant']['product'] ?? null;
$product_type_slug = $product['product_type']['slug'] ?? null;
$product_payment_detail = $product['payment_detail'] ?? null;
$payment_status_id = $order['payment_status']['id'];

$countries = $country_model->list_all();

$shipping_label = false;
$shipping_details = $order['shipping_details'][0] ?? null;
foreach ( $order['shipping_details'] ?? [] as $item ) {
    $shipping_details = $item;

    if ( $item['shipping_detail_type_id'] === ShippingDetailTypes::actual()->id ) {
        $shipping_label = true;
    }
    break;
}

$is_vat = North_Commerce_Settings::get_tax_is_vat();
$tax_type = '';

if($is_vat === 'disabled') {
    $tax_type = 'Tax';
} else {
    $tax_type = 'VAT';
}

do_action( 'north-commerce/order/single/before' );

?>
<div
    class="single-order"
    data-order-id="<?php echo esc_attr( $order['id'] ); ?>"
>
    <div class="order-notification"></div>
    <div class="nc-notifications"></div>
    <div class="order__header">
        <div class="order__wrapper">
            <a href="<?php echo admin_url( 'admin.php?page=north-commerce-orders' ); ?>" class="btn btn-prev"></a>

            <div class="order__short-info">
                <div class="order__data">
                    <h2>
                        <?php
                        echo apply_filters( 'north-commerce/order/single/title', esc_html( '#' . $order['order_number'] ) );
                        ?>
                    </h2>

                    <div class="order__wrapper">
                        <a
                            href="javascript:void(0);"
                            class="order__status order__selector order__status-<?php echo esc_attr( $order['order_status']['slug'] ); ?>"
                            data-order-status-nonce="<?php echo wp_create_nonce( 'wp_rest' ); ?>"
                        >
                            <span class="current_status">
                                <?php echo esc_html( $order['order_status']['name'] ); ?>
                            </span>
                        </a>

                        <div class="radio-select radio-select-rounded order__status-selector">
                            <?php
                            foreach ( $order_statuses as $status ) {
                                echo '<label class="radio-select__item status-type-' . esc_attr( $status['slug'] ) . '">',
                                    esc_html( $status['name'] ),
                                    '<input',
                                        ' type="radio"',
                                        ' name="order_status"',
                                        ' id="order_status_' . esc_attr( $status['slug'] ) . '"',
                                        ' value="' . esc_attr( $status['id'] ) . '"',
                                        checked( $order['order_status']['slug'] === $status['slug'], true, false ),
                                        '>',
                                    '<span class="radio-select__checkmark"></span>',
                                '</label>';
                            }
                            ?>
                        </div>
                    </div>

                    <div class="order__status order__status-<?php echo esc_attr( $order['payment_status']['slug'] ); ?>">
                        <span>
                            <?php echo esc_html( $order['payment_status']['name'] ); ?>
                        </span>
                    </div>
                </div>
                <p class="order__date">
                    <?php echo Settings::formatted_datetime( $order['created'] ); ?>
                </p>
            </div>
        </div>

        <div class="order__wrapper order__wrapper-actions">
            <a href="#" class="btn btn-refund" data-form-type="refunding"></a>
           <!-- TODO -->
            <!-- <a href="#" class="btn btn-refund"></a>
            <a href="#" class="btn btn-edit"></a> -->


            <a
                href="<?php echo admin_url( 'admin.php?page=north-commerce-orders&id=' . $adjacent_orders['prev_id'] ); ?>"
                class="btn btn-prev<?php echo ! $adjacent_orders['prev_id'] ? ' disabled' : ''; ?>"
            ></a>
            <a
                href="<?php echo admin_url( 'admin.php?page=north-commerce-orders&id=' . $adjacent_orders['next_id'] ); ?>"
                class="btn btn-next<?php echo ! $adjacent_orders['next_id'] ? ' disabled' : ''; ?>"
            ></a>
        </div>
    </div>
    <div class="order__body">
        <div class="order__content">
            <div class="card">
                <div class="card__header card__header-underline">
                    <div class="card__status order-status">
                        <span
                            class="status__mark <?php echo esc_attr( 'status-' . $order['order_status']['slug'] ); ?>"
                        ></span>
                        <h3 class="status__name">
                            <?php echo esc_html( $order['order_status']['name'] ); ?>
                        </h3>
                    </div>

                    <div class="card__action">
                        <a class="show-hidden" href="javascript:void(0);">
                            Show
                            <span class="status-hidden">more</span>
                            <span class="status-visibility">less</span>
                        </a>
                    </div>

                    <div class="card__hidden">
                        <div class="card__col-1">
                            <span>
                                <?php esc_html_e( 'Shipment point', 'north-commerce' ); ?>
                            </span>
                            <?php

                            $shipping_city = $order['shipping_address']['city'] ?? '';
                            $shipping_state = $order['shipping_address']['state'] ?? '';
                            $shipping_state = $shipping_city && $shipping_state ? ', ' . $shipping_state : $shipping_state;

                            ?>
                            <p>
                                <?php echo esc_html( $shipping_city . $shipping_state ); ?>
                            </p>
                        </div>

                        <div class="card__col-1">
                            <span>
                                <?php echo esc_html( $shipping_details['carrier'] ?? '' ); ?> Tracking #
                            </span>
                            <a
                                class="copy shipping-carrier-tracking-number"
                                href="<?php echo esc_html( $shipping_details['tracking_number'] ?? '#' ); ?>"
                                target="_blank"
                            >
                                <?php esc_html_e( 'Track Shipment', 'north-commerce' ); ?>
                            </a>
                        </div>

                        <div class="card__col-1">
                            <span>
                                <?php esc_html_e( 'Estimated delivery', 'north-commerce' ); ?>
                            </span>
                            <p class="shipping-carrier-estimated-delivery">
                                <?php echo esc_html( $shipping_details['estimated_delivery'] ?? '' ); ?>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card__body">
                    <?php

                    $order_single_admin_resource = new OrderSingleAdminResource($order);
                    foreach ( $order_single_admin_resource->get_line_items() as $line_item_resource ) {
	                    ?>
                        <div class="card__row details">
                            <div class="details__half">
                                <div class="details__img">
                                    <img src="<?php echo $line_item_resource['image']; ?>" alt="">
                                </div>

                                <div class="details__info">
                                    <p class="details__item">
					                    <?php echo esc_html( $line_item_resource['name'] ); ?>
                                    </p>
				                    <?php

				                    if ( $line_item_resource['variants'] ) {
					                    ?>
                                        <div class="variants__info">
						                    <?php
						                    foreach ( $line_item_resource['variants'] as $variant ) {
							                    ?>
                                                <p>
								                    <?php
								                    printf(
									                    '<strong>%s: </strong>%s',
									                    esc_html( wp_unslash( $variant['name'] ) ),
									                    esc_html( wp_unslash( $variant['value'] ) )
								                    );
								                    ?>
                                                </p>
							                    <?php
						                    }
						                    ?>
                                        </div>
					                    <?php
				                    }
				                    ?>
                                </div>
                            </div>
                            <div class="details__result">
                                <span>
                                    <?php echo esc_html( 'x' . $line_item_resource['quantity'] ); ?>
                                </span>
                                <span>
                                    <?php echo $line_item_resource['price_formatted']; ?>
                                </span>
                            </div>
                        </div>
	                    <?php
                    }

                    if ( ! empty( $bump_id ) ) {
                        ?>
                        <div class="card__row details">
                            <div class="details__half">
                                <?php
                                if ( 'Subscription' !== ( $bump_product_type ?? null ) ) {
                                    ?>
                                    <div class="details__img">
                                        <img
                                            src="<?php
                                                echo esc_url( ( $bump_product_image ?? null )
                                                    ?: plugin_dir_url( __FILE__ ) . '../../images/product-empty-img.png' );
                                            ?>"
                                            alt=""
                                        >
                                    </div>
                                    <?php
                                }
                                ?>
                                <div class="details__info ">
                                    <p class="details__item">Order Bump: <?php echo ( $bump_product_type ?? null ) ; ?> product</p>
                                    <p class="details__item details__item-black"><?php echo $bump_product_name ?? null; ?></p>
                                </div>
                            </div>
                            <div class="details__result">
                                <span>x<?php echo ( $bump_product_quantity ?? null ); ?></span>
                                <span><?php echo Settings::formatted_price( ( $bump_product_price ?? null ), false ); ?></span>
                            </div>
                        </div>
                        <?php
                    }
                    ?>
                </div>
            </div>

            <div class="card">
                <div class="card__header card__header-underline">
                    <div class="card__status">
                        <span
                            class="status__mark <?php echo esc_attr( 'status-' . $order['payment_status']['slug'] ); ?>"
                        ></span>
                        <h3>
                            <?php echo esc_html( $order['payment_status']['name'] ); ?>
                        </h3>
                    </div>
                    <?php

                    if (
                        ProductTypes::paymentPlan()->slug === $product_type_slug
                        || ( ! empty( $bump_id ) && ( $bump_product_type ?? null ) == 'Payment Plan' )
                    ) {
                        ?>
                        <div class="card__action">
                            <a class="show-hidden" href="javascript:void(0);">
                                <?php esc_html_e( 'Show', 'north-commerce' ); ?>
                                <span class="status-hidden"><?php esc_html_e( 'more', 'north-commerce' ); ?></span>
                                <span class="status-visibility"><?php esc_html_e( 'less', 'north-commerce' ); ?></span>
                            </a>
                        </div>
                        <?php

                        if ( ProductTypes::paymentPlan()->slug === $product_type_slug ) {
                            ?>
                            <div class="card__hidden">
                                <div class="card__col-1">
                                    <?php
                                    if ( (bool) $product_payment_detail['has_first_payment'] ) {
                                        ?>
                                        <span>
                                            <?php esc_html_e( 'First Payment', 'north-commerce' ); ?>
                                        </span>
                                        <p>
                                            <?php echo Settings::formatted_price( $product_payment_detail['first_payment'], false ); ?>
                                        </p>
                                        <?php
                                    }
                                    ?>
                                </div>
                                <div class="card__col-1">
                                    <span>
                                        <?php esc_html_e( 'Remaining Payments', 'north-commerce' ); ?>
                                    </span>
                                    <?php

                                    $payment_counter = intval( $product_payment_detail['num_payments'] );
                                    $payment_value = floatval( $order['line_items'][0]['amount'] ) / $payment_counter;

                                    ?>
                                    <p>
                                        <?php echo "{$payment_counter} payments of " . Settings::formatted_price( $payment_value, false ); ?>
                                    </p>
                                </div>
                            </div>
                            <?php
                        }

                        if ( ! empty( $bump_id ) && ( $bump_product_type ?? null ) == 'Payment Plan' ) {
                            ?>
                            <div class="card__hidden">
                                <div class="card__col-1">
                                    <?php
                                    if ( ! empty( $bump_payment_plan['product_first_payment'] ) && $bump_payment_plan['product_first_payment'] === 'on' ) {
                                        ?>
                                        <span>Bump First Payment</span>
                                        <p><?php echo Settings::formatted_price( $bump_payment_plan['product_first_payment_price'], false ); ?></p>
                                        <?php
                                    }
                                    ?>
                                </div>
                                <div class="card__col-1">
                                    <span>Bump Remaining Payments</span>
                                    <?php
                                    $payments_counter = intval( $bump_payment_plan['product_payment_numbers'] );
                                    $payment_value = floatval( $bump_product_subtotal ?? null ) / $payments_counter;

                                    echo '<p>',
                                        "{$payments_counter} payments of " . Settings::formatted_price( $payment_value, false );
                                    '</p>';
                                    ?>
                                </div>
                            </div>
                            <?php
                        }
                    }
                    ?>
                </div>
                <div class="card__body">
                    <div class="card__row payment">
                        <div class="payment__label">
                           <?php esc_html_e( 'Subtotal', 'north-commerce' ); ?>
                        </div>

                        <div class="payment__value">
                            <?php
                            $item_sum = 0;
                            foreach ( $order['line_items'] as $item ) {
                                $item_sum += $item['quantity'];
                            }
                            echo $item_sum . ' items';
                            ?>
                        </div>

                        <div class="payment__amount">
                           <?php echo Settings::formatted_price( $order['subtotal'], false ); ?>
                        </div>
                    </div>
                    <div class="card__row payment">
                        <div class="payment__label">
                           <?php esc_html_e( 'Shipping', 'north-commerce' ); ?>
                        </div>
                        <div class="payment__value shipping-carrier-line-item">
                            <?php
                            $shipping_carrier = $shipping_details['carrier'] ?? null;
                            $shipping_service = $shipping_details['service'] ?? null;

                            if ( $shipping_service ) {
                                $insert_spaces_before_uppercase = function () use ( $shipping_service ): string {
                                    return preg_replace('/(?<!\s)([A-Z])/', ' $1', $shipping_service);
                                };
                                $shipping_service = $insert_spaces_before_uppercase();
                            }

                            if ( $shipping_carrier && $shipping_service ) {
                                echo esc_html( "{$shipping_carrier} - {$shipping_service}" );
                            }
                            ?>
                        </div>
                        <div class="payment__amount">
                           <?php echo Settings::formatted_price( $order['shipping'], false ); ?>
                        </div>
                    </div>
                    <?php

                    $coupon = $counpon_model->list_coupon_order_map_by_order_id( $order['id'], [ 'expand' => 'coupon' ] )[0]['coupon'] ?? null;
                    if ( $coupon ) {
                        ?>
                        <div class="card__row payment">
                            <div class="payment__label">
                                <?php esc_html_e( 'Coupon', 'north-commerce' ); ?>
                            </div>
                            <div class="payment__value">
                                <?php echo esc_html( $coupon['name'] ); ?>
                            </div>
                            <div class="payment__amount">
                                <?php
                                $discount = ( $order['subtotal'] - $order['total'] ) * -1;
                                echo Settings::formatted_price( $discount, false );
                                ?>
                            </div>
                        </div>
                        <?php
                    }

                    if ( ! empty( $bump_id ) ) {
                        ?>
                        <div class="card__row payment">
                            <?php
                            echo '<div class="payment__label">',
                                esc_html__( 'Special offer', 'north-commerce' ),
                            '</div>';
                            ?>
                            <div class="payment__value"></div>
                            <div class="payment__amount">
                                <?php echo Settings::formatted_price( $bump_price, false ); ?>
                            </div>
                        </div>
                        <?php
                    }

                    if ( ProductTypes::subscription()->slug === $product_type_slug ) {
                        $shipping_cost = $order['shipping_details']['shipping_cost'] ?? null;
                        ?>
                        <div class="card__row payment">
                            <div class="payment__label">
                                <?php esc_html_e( 'Shipping', 'north-commerce' ); ?>
                            </div>
                            <div class="payment__value">
                                <?php
                                if ( 0 === $shipping_cost ) {
                                    esc_html_e( 'Free Shipping', 'north-commerce' );
                                }
                                ?>
                            </div>
                            <div class="payment__amount">
                                <?php echo esc_html( $shipping_cost ); ?>
                            </div>
                        </div>
                        <?php
                    }

                    ?>
                    <div class="card__row payment">
                        <div class="payment__label">
                            <?php echo $tax_type ?>
                        </div>
                        <div class="payment__value"></div>
                        <div class="payment__amount">
                            <?php echo Settings::formatted_price( $order['tax'], false ); ?>
                        </div>
                    </div>
                    <div class="card__row card__row-underline payment">
                        <div class="payment__label">
                            <?php esc_html_e( 'Total', 'north-commerce' ); ?>
                        </div>
                        <div class="payment__value"></div>
                        <div class="payment__amount">
                            <?php echo Settings::formatted_price( $order['total'], false ); ?>
                        </div>
                    </div>
                    <div class="card__row payment">
                        <div class="payment__label payment__label-bold">
                            <?php
                            $payment_status_id === PaymentStatuses::unpaid()->id
                                ? esc_html_e( 'Unpaid by customer', 'north-commerce' )
                                : esc_html_e( 'Paid by customer', 'north-commerce' );
                            ?>
                        </div>
                        <div class="payment__value"></div>
                        <div class="payment__amount">
                            <?php
                            if ( ProductTypes::paymentPlan()->slug === $product_type_slug ) {
                                echo Settings::formatted_price( $order['paid'], false ); ?>
                                <span class="payment__value">
                                    <?php echo '/' . Settings::formatted_price( $order['total'], false ); ?>
                                </span>
                                <?php
                            } else {
                                echo Settings::formatted_price( $order['total'], false );
                            }
                            ?>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>
                        <?php esc_html_e( 'Timeline', 'north-commerce' ); ?>
                    </h3>
                </div>
                <div class="card__body timeline">
                    <?php

                    // need to loop through line items here
                    if ( $order['order_changes'] ) {
                        foreach ( $order['order_changes'] as $change ) {
                            // in the future may need to change the message based on the change type, but for now return data is not understandable
                            $action_message = $change['description'] . ' (' . $order_currency . $change['value'] . ')';

                            ?>
                            <div class="card__row timeline__item">
                                <p class="timeline__action">
                                    <?php echo $change['description'] . ' (' . Settings::formatted_price( $change['value'], false ) . ') '; ?>
                                </p>
                                <p class="timeline__date">
                                    <?php echo Settings::formatted_datetime( $change['created'] ); ?>
                                </p>
                            </div>
                            <?php
                        }
                    }

                    ?>
                </div>
            </div>

        </div>
        <div class="order__sidebar">
            <div class="card">
                <div class="card__header">
                    <h3>
                        <?php esc_html_e( 'Customer', 'north-commerce' ); ?>
                    </h3>
                    <div class="card__action">
                        <a
                            href="javascript:void(0);"
                            class="btn-edit"
                            data-form-type="customer"
                        ></a>
                    </div>
                </div>

                <div class="card__body">
                    <div class="card__row">
                        <p class="card__text card__text-icon card__text-icon-user card__text-customer-name">
                            <?php echo esc_html( $order['customer']['first_name'] . ' ' . $order['customer']['last_name'] ); ?>
                        </p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>
                        <?php esc_html_e( 'Contact Information', 'north-commerce' ); ?>
                    </h3>
                    <div class="card__action">
                        <a
                            href="javascript:void(0);"
                            class="btn-edit"
                            data-form-type="contact"
                        ></a>
                    </div>
                </div>
                <div class="card__body">
                    <div class="card__row card__row-margin">
                        <p class="card__text card__text-icon card__text-icon-email card__text-customer-email">
                            <?php echo esc_html( $order['customer']['email'] ); ?>
                        </p>
                    </div>
                    <div class="card__row">
                        <p class="card__text card__text-icon card__text-icon-phone card__text-customer-phone">
                            <?php echo esc_html( $order['customer']['country_code'] . $order['customer']['phone'] ); ?>
                        </p>
                    </div>
                </div>
            </div>
            <?php

            if ( ProductTypes::subscription()->slug === $product_type_slug ) {
                ?>
                <div class="card">
                    <div class="card__header">
                        <h3><?php esc_html_e( 'Subscription Information', 'north-commerce' ); ?></h3>
                    </div>
                    <div class="card__body">
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Subscription', 'north-commerce' ); ?>
                            </p>
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Premium', 'north-commerce' ); ?>
                            </p>
                        </div>

                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Frequency', 'north-commerce' ); ?>
                            </p>

                            <p class="card__text card__text-padding-zero">
                                <?php echo esc_html( $product_payment_detail['payment_frequency']['name'] ); ?>
                            </p>
                        </div>
                        <?php

                        if ( $product_payment_detail['has_free_trial'] ) {
                            echo '<div class="card__row card__row-margin">',
                                '<p class="card__text card__text-padding-zero">',
                                    esc_html__( 'Free Trial', 'north-commerce' ),
                                '</p>',
                                '<p class="card__text card__text-padding-zero">',
                                    esc_html( $product_payment_detail['free_trial_frequency'] . ' ' . $product_payment_detail['free_trial_type']['name'] ),
                                '</p>',
                            '</div>';
                        }

                        if ( $product_payment_detail['has_first_period_payment'] ) {
                            echo '<div class="card__row card__row-margin">',
                                '<p class="card__text card__text-padding-zero">',
                                    esc_html__( 'First Period', 'north-commerce' ),
                                '</p>',
                                '<p class="card__text card__text-padding-zero">',
                                    Settings::formatted_price( $product_payment_detail['first_period_payment'], false ),
                                '</p>',
                            '</div>';
                        }

                        ?>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Status', 'north-commerce' ); ?>
                            </p>
                            <?php

                            $subscription_status = get_option( "nc/order_{$order_id}/subscription_status" );
                            if ( 'canceled' === $subscription_status ) {
                                $subscription_status_text = esc_html__( 'Canceled', 'north-commerce' );
                                $margin_class = ' card__row-margin';
                            } else {
                                $is_status_active = ( isset( $payment['label'] ) && 'Paid' === $payment['label'] )
                                    || ( isset( $bump_status['label'] ) && 'paid' === $bump_status['label'] );
                                $subscription_status_text = $is_status_active
                                    ? esc_html__( 'Active', 'north-commerce' )
                                    : esc_html__( 'Not Active', 'north-commerce' );
                            }

                            echo '<p class="card__text card__text-padding-zero">',
                                $subscription_status_text,
                            '</p>';
                            ?>
                        </div>
                        <div class="card__row<?php echo esc_attr( $margin_class ?? '' ); ?>">
                            <p class="card__text card__text-padding-zero">Start Date</p>
                            <p class="card__text card__text-padding-zero">
                                <?php echo Settings::convert_datetime_into_date( $order['created'] ); ?>
                            </p>
                        </div>
                        <?php

                        if ( 'canceled' === $subscription_status ) {
                            $subscription_expired_at = get_option( "nc/order_{$order_id}/subscription/expired_at", $unix_date_expiry );

                            echo '<div class="card__row">',
                                '<p class="card__text card__text-padding-zero">',
                                    esc_html__( 'Expire Date', 'north-commerce' ),
                                '</p>',
                                '<p class="card__text card__text-padding-zero">',
                                    gmdate( 'F j, Y', $subscription_expired_at ),
                                '</p>',
                            '</div>';
                        }
                        ?>
                    </div>
                </div>
                <?php
            }

            if ( ! empty( $bump_id ) && ( $bump_product_type ?? null ) == 'Subscription' ) {
                ?>
                <div class="card">
                    <div class="card__header">
                        <h3>
                            <?php esc_html_e( 'Subscription Information', 'north-commerce' ); ?>
                        </h3>
                    </div>
                    <div class="card__body">
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Subscription', 'north-commerce' ); ?>
                            </p>
                            <p class="card__text card__text-padding-zero"><?php echo 'Bump'; ?></p>
                        </div>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Frequency', 'north-commerce' ); ?>
                            </p>
                            <p class="card__text card__text-padding-zero">
                                <?php echo ucfirst( $bump_subscription['product_frequency'] ); ?>
                            </p>
                        </div>
                        <?php

                        if ( $bump_subscription['product_free_trial'] === 'on' ) {
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-padding-zero">Free Trial</p>
                                <p class="card__text card__text-padding-zero">
                                    <?php echo $bump_subscription['product_trial_count'] . ' ' . $bump_subscription['product_trial_type']; ?>
                                </p>
                            </div>
                            <?php
                        }

                        if ( $bump_subscription['product_first_period'] === 'on' ) {
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-padding-zero">First Period</p>
                                <p class="card__text card__text-padding-zero">
                                    <?php echo Settings::formatted_price( $bump_subscription['product_start_price'], false ); ?>
                                </p>
                            </div>
                            <?php
                        }

                        ?>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Status', 'north-commerce' ); ?>
                            </p>
                            <p class="card__text card__text-padding-zero">
                                <?php echo 'paid' === strtolower( $bump_status['label'] ) ? 'Active' : 'Not Active'; ?>
                            </p>
                        </div>
                        <div class="card__row">
                            <p class="card__text card__text-padding-zero">
                                <?php esc_html_e( 'Start Date', 'north-commerce' ); ?>
                            </p>
                            <p class="card__text card__text-padding-zero">
                                <?php echo Settings::convert_sql_timestamp_into_date( $order['created'] ); ?>
                            </p>
                        </div>
                    </div>
                </div>
                <?php
            }

            ?>
            <div class="card">
                <div class="card__header">
                    <h3>
                        <?php esc_html_e( 'Payment Method', 'north-commerce' ); ?>
                    </h3>
                </div>

                <div class="card__body">
                    <div class="card__row">
                        <?php
                        $payment_method = $order['customer_payment_method'];
                        $payment_provider = $payment_method['payment_provider']['slug'] ?? '';
                        $extra_class = $payment_provider ? ' card__text-icon-' . $payment_provider : '';
                        $payment_method_last4 = ! empty( $payment_method['last4'] ) ? $payment_method['last4'] : '••••';

                        echo '<p class="card__text card__text-icon' . $extra_class . '">',
                            '•••• •••• •••• ' . $payment_method_last4,
                        '</p>';
                        ?>
                    </div>
                </div>
            </div><?php

            if (
                ProductTypes::subscription()->slug !== $product_type_slug
                || ( ! empty( $bump_id ) && 'Subscription' !== ( $bump_product_type ?? null ) )
            ) {
                ?>
                <div class="card">
                    <div class="card__header">
                        <h3>
                            <?php esc_html_e( 'Shipping Address', 'north-commerce' ); ?>
                        </h3>
                        <div class="card__action">
                            <a
                                class="btn-edit"
                                href="javascript:void(0);"
                                data-form-type="shipping"
                            ></a>
                        </div>
                    </div>
                    <div class="card__body">
                        <?php
                        if ( ! empty( $order['shipping_address']['first_name'] ) ) {
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-icon card__text-icon-address shipping-address-name">
                                    <?php echo esc_html( $order['shipping_address']['first_name'] . ' ' . $order['shipping_address']['last_name'] ); ?>
                                </p>
                            </div>
                            <?php
                        }

                        if ( ! empty( $order['shipping_address']['addressline1'] ) ) {
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-icon shipping-address-address">
                                    <?php echo esc_html( $order['shipping_address']['addressline1'] . ' ' . $order['shipping_address']['addressline2'] ); ?>
                                </p>
                            </div>
                            <?php
                        }

                        if (
                            ! empty( $order['shipping_address']['city'])
                            || ! empty( $order['shipping_address']['state'] )
                            || ! empty( $order['shipping_address']['zipcode'] )
                        ) {
                            $text = $order['shipping_address']['city'] . '|' . $order['shipping_address']['state'] . '|' . $order['shipping_address']['zipcode'];
                            $text = implode( ', ', array_filter( explode( '|', $text ) ) );
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-icon shipping-address-city-state-zipcode">
                                    <?php echo esc_html( $text ); ?>
                                </p>
                            </div>
                            <?php
                        }

                        if ( ! empty( $order['shipping_address']['country'] ) ) {
                            ?>
                            <div class="card__row card__row-margin">
                                <p class="card__text card__text-icon shipping-address-country">
                                    <?php echo esc_html( $order['shipping_address']['country']['name'] ); ?>
                                </p>
                            </div>
                            <?php
                        }
                        ?>
                    </div>
                </div>
                <?php
            }

            ?>
            <div class="card card-billing">
                <div class="card__header">
                    <h3>
                        <?php esc_html_e( 'Billing Address', 'north-commerce' ); ?>
                    </h3>
                    <div class="card__action">
                        <a
                            class="btn-edit"
                            href="javascript:void(0);"
                            data-form-type="billing"
                        ></a>
                    </div>
                </div>

                <div class="card__body">
                    <?php
                    if ( ! empty( $order['billing_address'] ) ) {
                        ?>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-icon card__text-icon-address">
                                <?php
                                echo esc_html(
                                    $order['billing_address']['first_name']
                                    . ' ' .  $order['billing_address']['last_name']
                                );
                                ?>
                            </p>
                        </div>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-icon">
                                <?php
                                echo esc_html(
                                    $order['billing_address']['addressline1']
                                    . ' ' . $order['billing_address']['addressline2']
                                );
                                ?>
                            </p>
                        </div>
                        <?php
                    }

                    if (
                        ! empty( $order['billing_address']['city'] )
                        || ! empty( $order['billing_address']['state'] )
                        || ! empty( $order['billing_address']['zipcode'] )
                    ) {
                        $text = $order['billing_address']['city'] . '|' . $order['billing_address']['state'] . '|' . $order['billing_address']['zipcode'];
                        $text = implode( ', ', array_filter( explode( '|', $text ) ) );
                        ?>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-icon"><?php echo $text; ?></p>
                        </div>
                        <?php
                    }

                    if ( ! empty( $order['billing_address']['country']['name'] ) ) {
                        ?>
                        <div class="card__row card__row-margin">
                            <p class="card__text card__text-icon">
                                <?php echo $order['billing_address']['country']['name']; ?>
                            </p>
                        </div>
                        <?php
                    }
                    ?>
                </div>
            </div>
            <?php

            $this->template( 'shipping-label-card', 'order/single', compact(
                'order',
                'shipping_details',
                'shipping_label',
            ) );

            ?>
        </div>
        <div class="order__overlay"></div>
    </div>
</div>

<form class="admin-popup" data-form-type="customer">
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">
                <?php esc_html_e( 'Edit Customer Information', 'north-commerce' ); ?>
            </h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
            href="javascript:void(0);"
            class="admin-popup__close order-popup-close"
            data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>
        <div class="admin-popup__content">
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="customer_name"
                    >
                        <?php esc_html_e( 'First Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="customer_name"
                        id="customer_name"
                        value="<?php echo esc_attr( $order['customer']['first_name'] ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="customer_surname"
                    >
                        <?php esc_html_e( 'Last Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="customer_surname"
                        id="customer_surname"
                        value="<?php echo esc_attr( $order['customer']['last_name'] ); ?>"
                    >
                </div>
            </div>
        </div>
        <div class="admin-popup__actions">
            <a
                href="javascript:void(0);"
                class="admin-popup-cancel order-popup-cancel"
                data-fancybox-close
            >
                <span>
                    <?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
                </span>
            </a>
            <input
                class="admin-popup-submit"
                type="submit"
                value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
            >
        </div>
    </div>
</form>

<form class="admin-popup" data-form-type="contact">
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">
                <?php esc_html_e( 'Edit Contact Information', 'north-commerce' ); ?>
            </h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
            href="javascript:void(0);"
            class="admin-popup__close order-popup-close"
            data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>
        <div class="admin-popup__content">
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="contact_email"
                    >
                        <?php esc_html_e( 'Email Address', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="email"
                        name="contact_email"
                        id="contact_email"
                        value="<?php echo esc_attr( $order['customer']['email'] ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper admin-popup__field-wrapper-phone admin-popup__field-wrapper-flex">
                    <select
                        class="phoneSelect phoneInputFocus north-single-select select2-hidden-accessible"
                        data-minimum-results-for-search="Infinity"
                    >
                        <?php
                        $phones = get_int_phone();
                        foreach ( $phones as $key => $value ) {
                            ?>
                            <option
                                class="phoneSelectOption"
                                data-dial-code="<?php echo $value['dial_code']; ?>"
                                value="<?php echo $key; ?> "
                            ><?php echo $key; ?></option>
                            <?php
                        }
                        ?>
                    </select>
                    <div class="phoneSelectDivider"></div>
                    <input
                        type="tel"
                        name="contact_phone"
                        id="contact_phone"
                        value="<?php echo $order['customer']['phone']; ?> "
                    >
                    <label class="admin-popup__label-sticky" for="customer_surname">
                        <?php esc_html_e( 'Phone Number', 'north-commerce' ); ?>
                    </label>
                </div>
            </div>

            <div class="checkbox-select">
                <label class="checkbox-select__item">
                    <?php esc_html_e( 'Update customer profile', 'north-commerce' ); ?>
                    <input
                        type="checkbox"
                        name="update_customer"
                        id="update_customer"
                    >
                    <span class="checkbox-select__checkmark"></span>
                </label>
            </div>
        </div>
        <div class="admin-popup__actions">
            <a
                href="javascript:void(0);"
                class="admin-popup-cancel order-popup-cancel"
                data-fancybox-close
            >
                <span>
                    <?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
                </span>
            </a>
            <input
                type="submit"
                class="admin-popup-submit"
                value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
            >
        </div>
    </div>
</form>

<form
    class="admin-popup"
    data-form-type="shipping"
    data-form-identity="shipping-address-form"
    data-shipping-address-id="<?php echo esc_attr( $order['shipping_address']['id'] ?? '' ); ?>"
>
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">
                <?php esc_html_e( 'Edit Shipping Address', 'north-commerce'); ?>
            </h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
            href="javascript:void(0);"
            class="admin-popup__close order-popup-close"
            data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>
        <div class="admin-popup__content">
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_name"
                    >
                        <?php esc_html_e( 'First Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="shipping_name"
                        id="shipping_name"
                        value="<?php echo esc_attr( $order['shipping_address']['first_name'] ?? '' ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_surname"
                    >
                        <?php esc_html_e( 'Last Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="shipping_surname"
                        id="shipping_surname"
                        value="<?php echo esc_attr( $order['shipping_address']['last_name'] ?? '' ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        ]class="admin-popup__label-sticky"
                        for="shipping_address"
                    >
                        <?php esc_html_e( 'Shipping Address', 'north-commerce'); ?>
                    </label>
                    <input
                        type="text"
                        name="shipping_address"
                        id="shipping_address"
                        value="<?php echo esc_attr( $order['shipping_address']['addressline1'] ?? '' ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_address"
                    >
                        <?php esc_html_e( 'Shipping Address Line 2', 'north-commerce' )?>
                    </label>
                    <input
                        type="text"
                        name="shipping_address2"
                        id="shipping_address"
                        value="<?php echo esc_attr( $order['shipping_address']['addressline2'] ?? '' ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="city"
                    >
                        <?php esc_html_e( 'City', 'north-commerce'); ?>
                    </label>
                    <input
                        type="tel"
                        name="city"
                        id="city"
                        value="<?php echo esc_attr( $order['shipping_address']['city'] ?? '' ); ?>"
                    >
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="state"
                    >
                        <?php esc_html_e( 'State', 'north-commerce'); ?>
                    </label>
                    <input
                        type="text"
                        name="state"
                        id="state"
                        value="<?php echo esc_attr( $order['shipping_address']['state'] ?? '' ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="zip"
                    >
                        <?php esc_html_e( 'Zip Code', 'north-commerce'); ?>
                    </label>
                    <input
                        type="text"
                        name="zip"
                        id="zip"
                        value="<?php echo esc_attr( $order['shipping_address']['zipcode'] ?? '' ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper dropdown-arrow-container">
                    <label
                        class="admin-popup__label-sticky"
                        for="country"
                    >
                        <?php esc_html_e( 'Country', 'north-commerce'); ?>
                    </label>
                    <select
                        class="shipping-country-dropdown"
                        data-shipping-country-selector
                    >
                        <?php
                        $customers_country_id = $order['shipping_address']['country_id'] ?? '';
                        foreach ( $countries as $country ) {
                            ?>
                            <option
                                name="country"
                                value="<?php echo esc_attr( $country['id'] ); ?>"
                                <?php selected( $customers_country_id == $country['id'] ); ?>
                                data-shipping-country-id="<?php echo esc_attr( $country['id'] ); ?>"
                            >
                                <?php echo esc_html( $country['name'] ); ?>
                            </option>
                            <?php
                        }
                        ?>
                    </select>
                </div>
            </div>
        </div>
        <div class="admin-popup__actions">
            <a
                href="javascript:void(0);"
                class="admin-popup-cancel order-popup-cancel"
                data-fancybox-close
            >
                <span>
                    <?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
                </span>
            </a>
            <input
                type="submit"
                class="admin-popup-submit"
                value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
            >
        </div>
    </div>
</form>

<form class="admin-popup" data-form-type="billing">
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">
                <?php esc_html_e( 'Edit Billing Address', 'north-commerce' ); ?>
            </h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
            href="javascript:void(0);"
            class="admin-popup__close order-popup-close"
            data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>
        <div class="admin-popup__content">
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_name"
                    >
                        <?php esc_html_e( 'First Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="shipping_name"
                        id="shipping_name"
                        value="<?php echo esc_attr( $order['customer']['first_name'] ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_surname"
                    >
                        <?php esc_html_e( 'Last Name', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="shipping_surname"
                        id="shipping_surname"
                        value="<?php echo esc_attr( $order['customer']['last_name'] ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="shipping_address"
                    >
                        <?php esc_html_e( 'Billing Address', 'north-commerce' ); ?>
                    </label>
                    <?php
                    $address_line = ( $order['billing_address']['addressline1'] ?? '' ) . ' ' . ( $order['billing_address']['addressline2'] ?? '' );
                    ?>
                    <input
                        type="tel"
                        name="shipping_address"
                        id="shipping_address"
                        value="<?php echo esc_attr( $address_line ); ?>"
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="country"
                    >
                        <?php esc_html_e( 'Country', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="tel"
                        name="country"
                        id="country"
                        value="<?php echo esc_attr( $order['billing_address']['country']['abbreviation'] ?? '' ); ?> "
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="city"
                    >
                        <?php esc_html_e( 'City', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="tel"
                        name="city"
                        id="city"
                        value="<?php echo esc_attr( $order['billing_address']['city'] ?? '' ); ?> "
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="state"
                    >
                        <?php esc_html_e( 'State', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="state"
                        id="state"
                        value="<?php echo esc_attr( $order['billing_address']['state'] ?? '' ); ?> "
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_half">
                <div class="admin-popup__field-wrapper">
                    <label
                        class="admin-popup__label-sticky"
                        for="zip"
                    >
                        <?php esc_html_e( 'Zip Code', 'north-commerce' ); ?>
                    </label>
                    <input
                        type="text"
                        name="zip"
                        id="zip"
                        value="<?php echo esc_attr( $order['billing_address']['zipcode'] ?? '' ); ?> "
                    >
                </div>
            </div>
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper admin-popup__field-wrapper-phone admin-popup__field-wrapper-flex">
                    <select
                        class="phoneSelect phoneInputFocus north-single-select select2-hidden-accessible"
                        data-minimum-results-for-search="Infinity"
                    >
                        <?php
                        $phones = get_int_phone();
                        foreach ( $phones as $key => $value ) {
                            echo '<option',
                                ' class="phoneSelectOption"',
                                ' data-dial-code="' . esc_attr( $value['dial_code'] ) . '"',
                                ' value="' . esc_attr( $key ) . '"',
                                '>',
                                esc_html( $key ),
                            '</option>';
                        }
                        ?>
                    </select>
                    <div class="phoneSelectDivider"></div>
                    <input
                        type="tel"
                        name="contact_phone"
                        id="contact_phone"
                        placeholder="No phone added"
                        value="<?php echo esc_attr( $order['customer']['phone'] ); ?> "
                    >
                </div>
            </div>
        </div>
        <div class="admin-popup__actions">
            <a
                href="javascript:void(0);"
                class="admin-popup-cancel order-popup-cancel"
                data-fancybox-close
            >
                <span>
                    <?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
                </span>
            </a>
            <input
                class="admin-popup-submit"
                type="submit"
                value="<?php esc_attr_e( 'Save', 'north-commerce' ); ?>"
            >
        </div>
    </div>
</form>

<form
        class="admin-popup"
        data-form-type="refunding"
>
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">
				<?php esc_html_e( 'Confirm refunding', 'north-commerce'); ?>
            </h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
                href="javascript:void(0);"
                class="admin-popup__close order-popup-close"
                data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>
        <div class="admin-popup__content"></div>
        <div class="admin-popup__actions">
            <a
                    href="javascript:void(0);"
                    class="admin-popup-cancel order-popup-cancel"
                    data-fancybox-close
            >
                <span>
                    <?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
                </span>
            </a>
            <input
                    type="submit"
                    class="admin-popup-submit"
                    data-text-processing="<?php esc_attr_e( 'Processing...', 'north-commerce' ); ?>"
                    value="<?php esc_attr_e( 'Refund', 'north-commerce' ); ?>"
            >
        </div>
    </div>
</form>
