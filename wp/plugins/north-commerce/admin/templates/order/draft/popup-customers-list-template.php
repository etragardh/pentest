<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\{
	CustomerModel,
	CountryModel
};

/**
 * Customers List modal window
 *
 *
 * @package north-commerce/admin/templates/order/draft
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 * @version 0.1.25
 */

$render_search_input = function () {
	?>
	<input
		type="text"
		name="customer-filter-name"
		class="search-input customer-filter-name"
		id="customer-filter-name"
		placeholder="<?php esc_attr_e( 'Search by name or email', 'north-commerce' ); ?>"
	>
	<label
		for="customer-filter-name"
		class="search-icon"
	>
	</label>
	<?php
};

$render_customers_list = function () {
	$customer_model = new CustomerModel();

	$options = [
		'columns' => [
			'id',
			'customer_number',
			'first_name',
			'last_name',
			'email',
		],
		'expand' => [
			'addresses.country',
		],
	];
	$customers_list = $customer_model->list_all( true, $options );

	foreach ( $customers_list as $customer ) {
		$id_attr = 'customer-' . $customer['id'];
		?>
		<div class="list__item customer-id">
			<div class="item__wrapper">
				<div class="customer__checkbox">
					<input
						type="checkbox"
						class="north-checkbox__handler"
						name="applied_customer_id"
						id="<?php echo esc_attr( $id_attr ); ?>"
						value="<?php echo esc_attr( $customer['id'] ); ?>"
					>
					<label
						class="north-checkbox"
						for="<?php echo esc_attr( $id_attr ); ?>"
					>
					</label>
				</div>

				<label
					class="name customer__name"
					for="<?php echo esc_attr( $id_attr ); ?>"
				>
					<?php
					echo esc_html(
						$customer['first_name']
						. ' '
						.  $customer['last_name']
					);
					?>
				</label>

				<label
					class="email customer__email"
					for="<?php echo esc_attr( $id_attr ); ?>"
				>
					<?php echo esc_html( $customer['email'] ); ?>
				</label>
			</div>
		</div>
		<?php
	}
};

$render_customer_creation_form = function() {
	$error_svg = function() {
		include NORTH_COMMERCE_PLUGIN_DIR_PATH . 'public/images/error.svg';
	};

	?>
	<form id="create_customer" class="create_customer">
		<?php
		wp_nonce_field( 'customer_form', 'customer_form_nonce', false );
		?>
		<div class="form-row customer-names">
			<div class="admin-popup-field_half">
				<div class="input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_first_name"
					>
						<?php esc_html_e( 'First Name', 'north-commerce' ); ?>
					</label>
					<input
						type="text"
						id="customer_first_name"
						name="customer_first_name"
					>
					<div class="text-field-error" data-type="error">
						<span class="text-field-error-icon" data-type="error-icon">
							<?php $error_svg(); ?>
						</span>
					</div>
				</div>
			</div>
			<div class="admin-popup-field_half">
				<div class="input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_last_name"
					>
						<?php esc_html_e( 'Last Name', 'north-commerce' ); ?>
					</label>
					<input
						type="text"
						name="customer_last_name"
						id="customer_last_name"
					>
					<div class="text-field-error" data-type="error">
						<span class="text-field-error-icon" data-type="error-icon">
							<?php $error_svg(); ?>
						</span>
					</div>
				</div>
			</div>
		</div>
		<div class="form-row customer-email input-wrapper">
			<label
				class="admin-popup__label-sticky"
				for="customer_email"
			>
				<?php esc_html_e( 'Email', 'north-commerce' ); ?>
			</label>
			<input
				type="email"
				name="customer_email"
				id="customer_email"
				required
			>
			<div class="text-field-error" data-type="error">
				<span class="text-field-error-icon" data-type="error-icon">
					<?php $error_svg(); ?>
				</span>
			</div>
		</div>
		<div class="phone-wrapper">
            <div class="phone-main">
                <label class="phone-label">
					<?php esc_html_e( 'Phone', 'north-commerce' ); ?>
				</label>
                <select
					class="phone-select"
					name="customer_country_code"
				></select>
                <div class="phone-select-divider"></div>
                <input
                    class="phone-input"
					name="customer_phone"
                >
            </div>
            <div class="phone-error" data-type="error">
                <span class="phone-error-icon" data-type="error-icon">
					<?php $error_svg(); ?>
                </span>
            </div>
        </div>

		<div class="shipping-address">
			<h4 class="shipping-address_subtitle">
				<?php
				esc_html_e( 'Shipping Address', 'north-commerce' );
				?>
			</h4>
			<div class="form-row shipping-names">
				<div class="admin-popup-field_half input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_shipping_first_name"
					>
						<?php esc_html_e( 'First Name', 'north-commerce' ); ?>
					</label>
					<input
						type="text"
						name="customer_shipping_first_name"
						id="customer_shipping_first_name"
					>
				</div>
				<div class="admin-popup-field_half input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_shipping_last_name"
					>
						<?php esc_html_e( 'Last Name', 'north-commerce' ); ?>
					</label>
					<input
						type="text"
						name="customer_shipping_last_name"
						id="customer_shipping_last_name"
					>
				</div>
			</div>
			<div class="form-row shipping-address-line input-wrapper">
				<label
					class="admin-popup__label-sticky"
					for="customer_shipping_address"
				>
					<?php esc_html_e( 'Address Line', 'north-commerce'); ?>
				</label>
				<input
					type="text"
					name="customer_shipping_address"
					id="customer_shipping_address"
				>
			</div>
			<div class="form-row shipping-address-line input-wrapper">
				<label
					class="admin-popup__label-sticky"
					for="customer_shipping_address_2"
				>
					<?php esc_html_e( 'Address Line 2', 'north-commerce' )?>
				</label>
				<input
					type="text"
					name="customer_shipping_address_2"
					id="customer_shipping_address_2"
				>
			</div>
			<div class="form-row shipping-city input-wrapper">
				<label
					class="admin-popup__label-sticky"
					for="customer_shipping_city"
				>
					<?php esc_html_e( 'City', 'north-commerce'); ?>
				</label>
				<input
					type="tel"
					name="customer_shipping_city"
					id="customer_shipping_city"
				>
			</div>
			<div class="form-row shipping-state">
				<div class="admin-popup-field_half input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_shipping_state"
					>
						<?php esc_html_e( 'State', 'north-commerce'); ?>
					</label>
					<input
						type="text"
						name="customer_shipping_state"
						id="customer_shipping_state"
					>
				</div>
				<div class="admin-popup-field_half input-wrapper">
					<label
						class="admin-popup__label-sticky"
						for="customer_shipping_zip"
					>
						<?php esc_html_e( 'Zip Code', 'north-commerce'); ?>
					</label>
					<input
						type="text"
						name="customer_shipping_zip"
						id="customer_shipping_zip"
					>
				</div>
			</div>
			<div class="form-row input-wrapper">
				<label
					class="admin-popup__label-sticky"
					for="customer_shipping_country_id"
				>
					<?php esc_html_e( 'Country', 'north-commerce'); ?>
				</label>
				<select
					class="shipping-country-dropdown"
					name="customer_shipping_country_id"
					id="customer_shipping_country_id"
				>
					<?php
					$countries = ( new CountryModel() )->list_all();
					foreach ( $countries as $country ) {
						?>
						<option value="<?php echo esc_attr( $country['id'] ); ?>">
							<?php echo esc_html( $country['name'] ); ?>
						</option>
						<?php
					}
					?>
				</select>
			</div>
		</div>
	</form>
	<?php
};

$render_action_buttons = function() {
	?>
	<a
		href="javascript:void(0);"
		class="btn btn--cancel admin-popup-cancel"
		data-nc-custom-popup-close
	>
		<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
	</a>
	<input
		type="submit"
		class="btn btn--submit admin-popup-submit"
		data-nc-type="create"
		data-nc-select="<?php esc_attr_e( 'Select Customer', 'north-commerce' ); ?>"
		data-nc-create="<?php esc_attr_e( 'Create Customer', 'north-commerce' ); ?>"
		value="<?php esc_attr_e( 'Create Customer', 'north-commerce' ); ?>"
	>
	<?php
};

?>
<div id="customers-modal" class="nc-custom-popup">
	<form class="popup-new-customers admin-popup nc-custom-popup__window">
		<div class="admin-popup__header">
			<div class="admin-popup__left-side">
				<?php
				$popup_name = __( 'Create or select a customer for new order', 'north-commerce' );
				?>
				<h3
					class="integration-popup-name"
					data-nc-text-default="<?php echo esc_attr( $popup_name ); ?>"
					data-nc-text-customer-create="<?php esc_attr_e( 'Customer Creation', 'north-commerce' ); ?>"
				>
					<?php echo esc_html( $popup_name ); ?>
				</h3>
				<div class="loader"></div>
			</div>
			<a
				href="javascript:void(0);"
				class="admin-popup__close"
				data-nc-custom-popup-close
			></a>
		</div>

		<div class="admin-popup__body">

			<div class="admin-popup__notice"></div>

			<div class="admin-popup__content">

				<div class="search-input-wrapper">
					<?php
					$render_search_input();
					?>
				</div>

				<div class="empty-list hide">
					<p>
						<?php esc_html_e( 'No customer was found for ', 'north-commerce' ); ?>
						<span class="search-query"></span>
					</p>
					<p>
						<?php esc_html_e( 'Would you like to create this customer?', 'north-commerce' ); ?>
					</p>
				</div>

				<div class="popup-list popup-customers-list">
					<?php
					$render_customers_list();
					?>
					<div class="loader-wrap">
						<div class="loader"></div>
					</div>
				</div>

				<div class="create-new-customer hide">
					<?php
					$render_customer_creation_form();
					?>
				</div>

				<div id="errors" class="form-errors"></div>

				<div class="admin-popup__actions">
					<?php
					$render_action_buttons();
					?>
				</div>
			</div>
		</div>
	</form>
</div>