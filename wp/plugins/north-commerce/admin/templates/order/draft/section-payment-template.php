<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\OrderModel;
use North_Commerce_Settings as Settings;

/**
 * Payment section template.
 *
 *
 * @package north-commerce/admin/templates/order/draft
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 * @version 0.1.25
 */

$order_model = new OrderModel();

$sd = 'shipping_details';
$sr = 'shipping_rates';
$sz = 'shipping_zone';

$order = $order_model->get_by_id( $order['id'], [
    'expand' => [
        "{$sd}",
        "{$sd}.{$sr}_internal",
        "{$sd}.{$sr}_easypost",
        "{$sd}.{$sr}_internal.{$sz}",
        "{$sd}.{$sr}_easypost.{$sz}",
        "{$sd}.{$sr}_internal.{$sz}.{$sz}_type",
        "{$sd}.{$sr}_easypost.{$sz}.{$sz}_type",
    ],
] );

$shipping_detail = $order['shipping_details'][0] ?? null;
if ( $shipping_detail ) {
    $rate_name = $shipping_detail["{$sr}_internal"]['name'] ?? $shipping_detail["{$sr}_easypost"]['name'] ?? null;
    $zone_type_name = $shipping_detail["{$sr}_internal"][ $sz ]["{$sz}_type"]['name'] ?? $shipping_detail["{$sr}_easypost"]['carrier_label'] ?? null;
}

$rate_type_id_attr = function () use ( $shipping_detail ): void {
    echo ! empty( $shipping_detail['rate_type_id'] )
        ? ' data-rate-type-id="' . esc_attr( $shipping_detail['rate_type_id'] ) . '"'
        : null;
};

$rate_id_attr = function () use ( $shipping_detail ): void {
    $internal_id = $shipping_detail['shipping_rates_internal_id'] ?? null;
    $easypost_id = $shipping_detail['shipping_rates_easypost_id'] ?? null;

    echo $internal_id || $easypost_id
        ? ' data-rate-id="' . esc_attr(  $internal_id ?: $easypost_id ) . '"'
        : null;
};

$taxable_amount = $order['subtotal'] + $order['shipping'];
$tax_value = floatval( $order['tax'] ) ? round( $order['tax'] / $taxable_amount * 100 ) : null;

?>
<div class="card totals">
    <div class="card__header">
        <div class="card__status">
            <h3>
                <?php esc_html_e( 'Payment', 'north-commerce' ); ?>
            </h3>
        </div>
    </div>
    <div class="card__body">
        <div class="card__row payment subtotal">
            <div class="payment__label">
                <?php esc_html_e( 'Subtotal', 'north-commerce' ); ?>
            </div>
            <div class="payment__value"></div>
            <div class="payment__amount" data-nc-type="subtotal">
                <?php echo Settings::formatted_price( $order['subtotal'] ); ?>
            </div>
        </div>
        <div class="card__row payment shipping">
            <div class="payment__label">
                <button
                    type="button"
                    class="add-shipping disabled"
                    data-nc-custom-popup="#shipping-modal"
                >
                    <?php esc_html_e( 'Add Shipping', 'north-commerce' ); ?>
                </button>
            </div>
            <div
                class="payment__value"
                data-label-zero="<?php esc_attr_e( 'Free Shipping', 'north-commerce' ); ?>"
                <?php
                $rate_type_id_attr();
                $rate_id_attr();
                echo floatval( $order['shipping'] ) ? ' data-nc-shipping-price="' . floatval( $order['shipping'] ) . '"' : '';
                ?>
            >
                <?php
                echo $shipping_detail
                    ? esc_html( "{$rate_name} ({$zone_type_name})" )
                    : esc_html__( 'Free Shipping', 'north-commerce' );
                ?>
            </div>
            <div class="payment__amount" data-nc-type="shipping">
                <?php echo Settings::formatted_price( $order['shipping'] ); ?>
            </div>
        </div>
        <div class="card__row payment tax">
            <div class="payment__label">
                <button
                    type="button"
                    class="add-tax disabled"
                    data-nc-custom-popup="#taxes-modal"
                >
                    <?php esc_html_e( 'Add Tax', 'north-commerce' ); ?>
                </button>
            </div>
            <div
                class="payment__value"
                data-label-zero="<?php esc_attr_e( 'Not calculated', 'north-commerce' ); ?>"
                <?php
                echo $tax_value ? ' data-nc-tax-percent="' . $tax_value . '"' : '';
                ?>
            >
                <?php
                echo $tax_value ? $tax_value . '%' : esc_html__( 'Not calculated', 'north-commerce' );
                ?>
            </div>
            <div class="payment__amount" data-nc-type="tax">
                <?php echo Settings::formatted_price( $order['tax'] ); ?>
            </div>
        </div>
        <div class="cards__divider"></div>
        <div class="card__row payment total">
            <div class="payment__label">
                <?php esc_html_e( 'Total', 'north-commerce' ); ?>
            </div>
            <div class="payment__value"></div>
            <div class="payment__amount" data-nc-type="total">
                <?php echo Settings::formatted_price( $order['total'] ); ?>
            </div>
        </div>
        <div class="card__row actions">
            <button
                type="button"
                class="btn action action-draft disabled"
                data-nc-action="draft"
                data-title-idle="<?php esc_attr_e( 'Save Draft', 'north-commerec' ); ?>"
                data-title-saving="<?php esc_attr_e( 'Saving...', 'north-commerec' ); ?>"
            >
                <?php esc_html_e( 'Save Draft', 'north-commerce' ); ?>
            </button>
            <button
                type="button"
                class="btn action disabled"
                data-nc-action="invoice"
            >
                <?php esc_html_e( 'Send Invoice', 'north-commerce' ); ?>
            </button>
            <div
                class="btn action action-save disabled"
                data-nc-action="collect-payment"
            >
                <span class="btn__text">
                    <?php esc_html_e( 'Collect Payment', 'north-commerce' ); ?>
                </span>
                <div class="btn__options">
                    <button
                        type="button"
                        class="btn__option pay"
                        data-nc-custom-popup="#order-payment-modal"
                    >
                        <?php esc_html_e( 'Pay with credit card', 'north-commerce' ); ?>
                    </button>
                    <button
                        type="button"
                        class="btn__option mark_paid"
                        data-nc-custom-popup="#order-paid-create-modal"
                    >
                        <?php esc_html_e( 'Mark as paid', 'north-commerce' ); ?>
                    </button>
                    <?php
                    wp_nonce_field( 'order_new', 'admin_order_create' );
                    ?>
                </div>
            </div>
        </div>
    </div>
</div>