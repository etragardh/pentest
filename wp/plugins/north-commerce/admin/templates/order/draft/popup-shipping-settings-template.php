<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\RateTypes;
use NorthCommerce\Models\ShippingProfileModel;
use North_Commerce_Settings as Settings;
use North_Commerce_Easypost as Easypost;

/**
 * Shipping Settings modal template.
 *
 *
 * @package north-commerce/admin/templates/order/draft
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 * @version 0.1.25
 */


$shipping_options = [
	'Free Shipping',
	'Calculated', // via Easypost API
	'Flat',
];

$rate_type_id_attr = function ( $option_name ): void {
	switch ( $option_name ) {
		case 'Flat':
			$id = RateTypes::flatRate()->id;
			break;
		case 'Calculated':
			$id = RateTypes::calculatedRate()->id;
			break;
	}
	echo isset( $id )
		? ' data-rate-type-id="' . $id . '"'
		: null;
};

$optional_container_for_type_calculated = function() use ( $customer ) {
	$easypost = new Easypost();
	$profile_model = new ShippingProfileModel();
	$customer_shipping_address = $customer['addresses'][0] ?? null;
	$profile_warehouse_address = $profile_model->get_default_shipping_address();

	$errors = null;
	if ( empty( $profile_warehouse_address['id'] ) ) {
		$errors[] = sprintf(
			__( 'There is no "Ship From" address for your <a href="%s" target="_blank">Shipping Profile</a>.', 'north-commerce' ),
			admin_url( 'admin.php?page=north-commerce-settings&tab=shipment' )
		);
	}
	if ( ! $easypost->is_connected() ) {
		$errors[] = sprintf(
			__( 'Note: your <a href="%s" target="_blank">Easypost</a> integration in not active. Only Internal rates can be applied.', 'north-commerce' ),
			admin_url( 'admin.php?page=north-commerce-integration' )
		);
	}

	if ( ! $errors ) {
		$preformatted_customer_address = [
			'addressline1' => $customer_shipping_address['addressline1'] ?? '',
			'city' => $customer_shipping_address['city'] ?? '',
			'state' => $customer_shipping_address['state'] ?? '',
			'zipcode' => $customer_shipping_address['zipcode'] ?? '',
			'country' => [
				'abbreviation' => $customer_shipping_address['country']['abbreviation'] ?? '',
			],
		];
	}

	?>
	<div
		class="optional-container shipping-options_calculated"
		data-nc-type="calculated"
		data-rate-type-id="<?php echo RateTypes::calculatedRate()->id; ?>"
		data-nc-customer-address="<?php echo htmlentities( json_encode( $preformatted_customer_address ?? null ) ); ?>"
	>
		<?php
		if ( $errors ) {
			?><div class="errors"><?php
				foreach ( $errors as $error ) {
					?><div class="error"><?php
						echo wp_kses( $error, [
							'a' => [
								'href' => true,
								'target' => true,
							],
						] );
					?></div><?php
				}
			?></div><?php
		}
		?>
		<div class="notices"></div>
	</div>
	<script type="text/template" id="nc-tmpl-shipping-rate-item">
		<label class="radio-container shipping-rate">
			<input
				type="radio"
				class="shipping_rate_option"
				name="shipping_rate_option"
			>
			<span class="checkmark"></span>
			<span class="rate_name"></span>
			<span class="rate_price"><?php echo Settings::formatted_price( 0 ); ?></span>
		</label>
	</script>
	<?php

};

$optional_container_for_type_flat = function() {
	$profile_model = new ShippingProfileModel();
	$rates = $profile_model->list_rates( true, [
		'expand' => [
			'shipping_zone',
			'shipping_zone.shipping_zone_type'
		],
		'include' => [
			'internal',
		],
	] );
	$flat_rates = $rates['internal'];

	$rates_select = function () use ( $flat_rates ) {
		?>
		<label class="admin-popup__label-sticky" for="shipping_flat_rate">
			<?php esc_html_e( 'Flat Rate', 'north-commerce' ); ?>
		</label>
		<select
			class="flat-rates-dropdown"
			id="shipping_flat_rate"
			data-rate-type-id="<?php echo RateTypes::flatRate()->id; ?>"
		>
			<?php
			foreach ( $flat_rates as $rate ) {
				$shipping_zone_type_name = $rate['shipping_zone']['shipping_zone_type']['name'];
				$rate_price_formatted = Settings::formatted_price( $rate['price'], false );

				?>
				<option
					name="shipping_flat_rate"
					value="<?php echo esc_attr( $rate['id'] ); ?>"
					data-name="<?php echo esc_attr( "{$rate['name']} ({$shipping_zone_type_name})" ); ?>"
					data-price="<?php echo esc_attr( $rate['price'] ); ?>"
				>
					<?php
					echo esc_html( "{$rate['name']} ({$shipping_zone_type_name}): {$rate_price_formatted}" );
					?>
				</option>
				<?php
			}
			?>
		</select>
		<?php
	};

	$no_rates_notice = function() {
		?>
		<div class="nc-admin-notice nc-admin-notice-error">
			<?php
			printf(
				__( 'There is no available Flat Rates. </br>Visit %1$sShipping Profiles settings page%2$s and create one.', 'north-commerce' ),
				'<a href="' . admin_url( 'admin.php?page=north-commerce-settings&tab=shipment' ) . '" target="_blank">',
				'</a>'
			 );
			?>
		</div>
		<?php
	};

	?>
	<div
		class="optional-container shipping-options_flat"
		data-nc-type="flat"
	>
		<div class="admin-popup-field_full">
			<div class="admin-popup__field-wrapper dropdown-arrow-container">
				<?php
				$flat_rates
					? $rates_select()
					: $no_rates_notice();
				?>
			</div>
		</div>
	</div>
	<?php
};

?>
<div class="nc-custom-popup" id="shipping-modal">
	<form class="popup-shipping-settings admin-popup nc-custom-popup__window">
		<div class="admin-popup__header">
			<div class="admin-popup__left-side">
				<h3 class="integration-popup-name">
					<?php esc_html_e( 'Shipping', 'north-commerce' ); ?>
				</h3>
				<div class="loader"></div>
			</div>
			<a
				href="javascript:void(0);"
				class="admin-popup__close"
				data-nc-custom-popup-close
			></a>
		</div>

		<div class="admin-popup__body">
			<div class="admin-popup__notice"></div>
			<div class="admin-popup__content">
				<div class="shipping-options">
					<?php
					foreach ( $shipping_options as $i => $option_name ) {
						$option_slug = sanitize_title( $option_name );

						?>
						<label class="radio-container">
							<?php echo esc_html( $option_name ); ?>
							<input
								type="radio"
								class="shipping_option"
								name="shipping_option"
								id="<?php echo esc_attr( 'shipping_option_' . $option_slug ); ?>"
								value="<?php echo esc_attr( $option_slug ); ?>"
								<?php
								$rate_type_id_attr( $option_name );
								checked( 0 === $i );
								?>
							>
							<span class="checkmark"></span>
						</label>
						<?php

						if ( 'Calculated' === $option_name ) {
							$optional_container_for_type_calculated();
						}
						if ( 'Flat' === $option_name ) {
							$optional_container_for_type_flat();
						}
					}
					?>
				</div>

				<div class="admin-popup__actions">
					<a
						href="javascript:void(0);"
						class="btn btn--cancel admin-popup-cancel"
						data-nc-custom-popup-close
					>
						<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
					</a>
					<button
						type="button"
						class="btn btn--submit admin-popup-submit disabled"
					>
						<?php esc_html_e( 'Save', 'north-commerce' ); ?>
					</button>
				</div>
			</div>
		</div>
	</form>
</div>
