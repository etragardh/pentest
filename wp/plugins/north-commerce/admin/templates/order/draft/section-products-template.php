<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\OrderModel;

/**
 * Products section template.
 *
 *
 * @package north-commerce/admin/templates/order/draft
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 * @version 0.1.25
 */

$order_model = new OrderModel();
$order = $order_model->get_by_id( $order['id'] );

$formatted_line_items_json = function () use ( $order ) {
    $line_items = [];
    foreach ( $order['line_items'] as $li ) {
        $product_id = $li['product_variant']['product']['id'];
        $product_variant_id = $li['product_variant']['id'];
        $line_items[ $product_id ][] = "{$product_variant_id}:{$li['quantity']}";
    }

    return json_encode( $line_items ?: null );
};

?>
<div class="card products">
    <div class="card__header">
        <div class="card__status">
            <h3>
                <?php esc_html_e( 'Products', 'north-commerce' ); ?>
            </h3>
        </div>
    </div>

    <div
        class="selected-list list-products"
        data-order-line-items="<?php echo htmlentities( $formatted_line_items_json() ); ?>"
    >
        <div class="loader-wrap">
            <div class="loader"></div>
        </div>
    </div>
    <?php

    $btn_search_visibility = (bool) $order['line_items'];
    ?>
    <button
        type="button"
        class="search_products btn disabled<?php echo esc_attr( $btn_search_visibility ? ' hide' : '' ); ?>"
        data-nc-custom-popup="#products-modal"
    >
        <svg class="btn__icon search_icon" width="20" height="19" viewBox="0 0 20 19">
            <path d="M8.5 16C10.346 16 12.043 15.365 13.397 14.312L17.793 18.708L19.207 17.294L14.811 12.898C15.865 11.543 16.5 9.846 16.5 8C16.5 3.589 12.911 0 8.5 0C4.089 0 0.5 3.589 0.5 8C0.5 12.411 4.089 16 8.5 16ZM8.5 2C11.809 2 14.5 4.691 14.5 8C14.5 11.309 11.809 14 8.5 14C5.191 14 2.5 11.309 2.5 8C2.5 4.691 5.191 2 8.5 2Z"/>
        </svg>
        <span class="btn__label">
            <?php esc_html_e( 'Search products', 'north-commerce' ); ?>
        </span>
    </button>

    <button
        type="button"
        class="add_products btn disabled<?php echo esc_attr( $btn_search_visibility ? '' : ' hide' ); ?>"
        data-nc-custom-popup="#products-modal"
    >
        <span class="btn__icon"></span>
        <span class="btn__label">
            <?php esc_html_e( 'Add products', 'north-commerce' ); ?>
        </span>
    </button>
</div>