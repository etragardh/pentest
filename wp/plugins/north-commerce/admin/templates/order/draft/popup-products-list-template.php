<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Db\Collections\ProductVariantTypes;
use NorthCommerce\Models\ProductModel;
use North_Commerce_Settings as Settings;

/**
 * Products List modal window.
 *
 *
 * @package north-commerce/admin/templates/order/draft
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 * @version 0.1.25
 */

$products_model = new ProductModel();

$options = [
	'columns' => [
		'id',
		'created',
		'name',
		'slug',
		'description',
		'deleted',
		'base_price',
		'quantity',
		'is_physical_product',
		'has_product_variants',
		'product_type_id',
		'product_status_id',
	],
	'expand' => [
		'product_type',
		'product_status',
		'product_images',
		'product_variants',
		'product_variants.product_variant_type',
	]
];
$products_list = $products_model->list( $criteria = true, $options );

$render_product_item = function ( $product ) {
	$product_id = $product['id'];
	$product_has_variants = count( $product['product_variants'] ) > 1; // more than single `solo` variant

	$variant_solo_id = null;
	if ( ! $product_has_variants ) {
		foreach ( $product['product_variants'] as $variant ) {
			if ( ProductVariantTypes::solo()->id === $variant['product_variant_type']['id'] ) {
				$variant_solo_id = $variant['id'];
				break;
			}
		}
	}

	?>
	<div
		class="list__product <?php echo esc_attr( 'product-' . $product_id ); ?>"
		data-level="product"
		data-id="<?php echo esc_attr( $product_id ); ?>"
		<?php echo $variant_solo_id ? ' data-variant-id="' . esc_attr( $variant_solo_id ) . '"' : ''; ?>
	>
		<div class="product__wrapper">
			<div class="product__checkbox">
				<input
					type="checkbox"
					name="order_products[]"
					class="north-checkbox__handler"
					id="<?php echo esc_attr( "product_{$product_id}" ); ?>"
					value="<?php echo esc_attr( $product_id ); ?>"
				>
				<label
					for="<?php echo esc_attr( "product_{$product_id}" ) ?>"
					class="north-checkbox"
				>
				</label>
			</div>

			<label
				for="<?php echo esc_attr( "product_{$product_id}" ); ?>"
				class="product__img"
			>
				<?php
				$product_image = $product['product_images'][0]['image_url']
					?? NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';
				?>
				<img
					src="<?php echo esc_url( $product_image ); ?>"
					alt="<?php echo esc_attr( $product['name'] ); ?>"
				>
			</label>

			<label
				for="<?php echo esc_attr( "product_{$product_id}" ); ?>"
				class="product__name"
			>
				<?php echo esc_html( $product['name'] ); ?>
			</label>

			<label
				for="<?php echo esc_attr( "product_{$product_id}" ); ?>"
				class="product__quantity"
			>
				<?php
				if ( $product['quantity'] ) {
					?>
					<span class="quantity__value">
						<?php echo esc_html( $product['quantity'] ); ?>
					</span>
					<?php
					esc_html_e( ' in stock', 'north-commerce' );
				}
				?>
			</label>

			<label
				for="<?php echo esc_attr( "product_{$product_id}" ); ?>"
				class="product__price"
			>
				<?php echo Settings::formatted_price( $product['base_price'] ); ?>
			</label>

			<label
				for="<?php echo esc_attr( "product-{$product_id}-variation-expander" ); ?>"
				class="product__handler<?php echo ! $product_has_variants ? ' hide' : ''; ?>"
			>
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
					<path d="M12.0002 15.713L18.0102 9.70299L16.5972 8.28799L12.0002 12.888L7.40423 8.28799L5.99023 9.70199L12.0002 15.713Z">
				</svg>
			</label>
		</div>

		<input
			type="checkbox"
			id="<?php echo esc_attr( "product-{$product_id}-variation-expander" ); ?>"
			class="product__expander"
		>

		<div class="product__variants-list<?php echo ! $product_has_variants ? ' hide' : ''; ?>">
			<?php

			foreach ( $product['product_variants'] as $variant ) {
				if ( ProductVariantTypes::solo()->id === $variant['product_variant_type']['id'] ) {
					continue;
				}

				$variant_attr_id = "product-{$product_id}_variant-{$variant['id']}";
				?>
				<div
					class="product__variant <?php echo esc_attr( $variant_attr_id ); ?>"
					data-level="variant"
				>
					<div class="variant__wrapper">
						<div class="variant__checkbox">
							<input
								type="checkbox"
								name="order_variants[]"
								id="<?php echo esc_attr( $variant_attr_id ); ?>"
								class="variant__handler north-checkbox__handler"
								value="<?php echo esc_attr( $variant['id'] ); ?>"
								<?php
								echo isset( $variant['price'] ) ? 'data-nc-price="' . esc_attr( $variant['price'] ) . '"' : '';
								checked( isset( $related_variants[ intval( $variant['id'] ) ] ) );
								?>
							>
							<label
								for="<?php echo esc_attr( $variant_attr_id ); ?>"
								class="north-checkbox"
							>
							</label>
						</div>
						<label
							for="<?php echo esc_attr( $variant_attr_id ); ?>"
							class="variant__label slug"
						>
							<?php echo esc_html( $variant['slug'] ); ?>
						</label>
						<?php
						if ( isset( $variant['price'] ) ) {
							?>
							<label
								for="<?php echo esc_attr( $variant_attr_id ); ?>"
								class="variant__label price"
							>
								<?php echo Settings::formatted_price( $variant['price'] ); ?>
							</label>
							<?php
						}
						?>
					</div>
				</div>
				<?php
			}

			?>
		</div>
	</div>
	<?php
};

?>
<div class="nc-custom-popup" id="products-modal">
	<form class="popup-new-products admin-popup nc-custom-popup__window">
		<div class="admin-popup__header">
			<div class="admin-popup__left-side">
				<h3 class="integration-popup-name">
					<?php esc_html_e( 'Add products', 'north-commerce' ); ?>
				</h3>
				<div class="loader"></div>
			</div>
			<a
				href="javascript:void(0);"
				class="admin-popup__close"
				data-nc-custom-popup-close
			></a>
		</div>

		<div class="admin-popup__body">
			<div class="admin-popup__notice"></div>
			<div class="admin-popup__content">
				<div class="search-input-wrapper">
					<input
						type="text"
						name="product-variant-filter-name"
						class="search-input product-variant-filter-name"
						id="product-variant-filter-name"
						placeholder="<?php esc_attr_e( 'Search by Product name or Variation name', 'north-commerce' ); ?>"
					>
					<label for="product-variant-filter-name" class="search-icon">
					</label>
				</div>

				<div class="empty-list hide">
					<?php esc_html_e( 'No results for: ', 'north-commerce' ); ?>
					<span class="search-query"></span>
				</div>

				<div class="popup-list popup-products-list">
					<?php
					foreach ( $products_list as $product ) {
						$render_product_item( $product );
					}
					?>
					<div class="loader-wrap">
						<div class="loader"></div>
					</div>
				</div>

				<div class="admin-popup__actions">
					<a
						href="javascript:void(0);"
						class="btn btn--cancel admin-popup-cancel"
						data-nc-custom-popup-close
					>
						<?php esc_html_e( 'Cancel', 'north-commerce' ); ?>
					</a>
					<button
						type="button"
						class="btn btn--submit admin-popup-submit disabled"
					>
						<?php esc_html_e( 'Add products', 'north-commerce' ); ?>
					</button>
				</div>
			</div>
		</div>
	</form>
</div>
