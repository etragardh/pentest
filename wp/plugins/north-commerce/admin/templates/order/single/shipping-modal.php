<?php
     require_once NORTH_COMMERCE_PLUGIN_DIR_PATH . 'includes/models/class-shipping-profile-model.php';

     $currency_code = North_Commerce_Settings::get_currency_code();
     $currency_symbol = North_Commerce_Settings::get_currency_symbol();
     $shipping_profile = new \NorthCommerce\Models\ShippingProfileModel();
     $shipping_profile_address = $shipping_profile->get_shipping_address();
     $all_addresses = $shipping_profile->list_addresses();


    // Ship to address (Customer address)
    if ($order['shipping_address']) {
        $address = $order['shipping_address'];
        $address_id = $address['id'];
        $full_name = $address['first_name'] . ' ' . $address['last_name'];
        $address_line1 = $address['addressline1'];
        $address_line2 = $address['addressline2'];
        $city = $address['city'];
        $state = $address['state'];
        $zip_code = $address['zipcode'];
        $country = $address['country']['abbreviation'];
        $customer_full_address =  $address_line1 . ' ' . $address_line2 . ' ' . $city . ' ' . $state . ' ' . $zip_code . ' ' . $country;
    }
?>

<form
    class="admin-popup shipping-popup"
    data-form-type="shipping-label"
    data-order-id="<?php echo $order['id'] ?>"
    data-nonce="<?php echo wp_create_nonce('wp_rest') ?>"
    data-form-identity="shipping-label-form"
>
    <div class="admin-popup__header">
        <div class="admin-popup__left-side">
            <h3 class="integration-popup-name">Create Shipping Label</h3>
            <div class="loader" style="display: none;"></div>
        </div>
        <a
            href="javascript:void(0);"
            class="admin-popup__close customer-popup-close"
            data-fancybox-close
        ></a>
    </div>
    <div class="admin-popup__body">
        <div class="admin-popup__notice"></div>

        <div class="admin-popup__content">
            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper dropdown-arrow-container">
                    <label class="admin-popup__label-sticky" for="country">Ship From Address</label>
                    <select class="shipping-country-dropdown" data-shipping-country-selector>
                        <?php
                        foreach ( $all_addresses as $address ) {
                            ?>
                            <option
                                name="country"
                                value="<?php echo 'address-' . $address['id']; ?>"
                                data-address="<?php echo htmlentities( json_encode( $address ) ); ?>"
                            >
                                <?php
                                echo esc_html( $address['preformatted_line'] . ' ' . $address['country']['abbreviation'] );
                                ?>
                            </option>
                            <?php
                        }
                        ?>
                    </select>
                </div>
            </div>

            <div class="admin-popup-field admin-popup-field_full">
                <div class="admin-popup__field-wrapper dropdown-arrow-container">
                    <label class="admin-popup__label-sticky" for="country">Ship To Address</label>
                    <select class="shipping-country-dropdown" data-shipping-country-selector>
                        <option
                            name="country"
                            value="<?php echo ! empty( $address ) ? 'address-' . $address['id'] : ''; ?>"
                            data-address="<?php echo ! empty( $address ) ? htmlentities( json_encode( $address ) ) : ''; ?>"
                        >
                                <?php echo $customer_full_address ?? ''; ?>
                        </option>
                    </select>
                </div>
            </div>

            <div data-shipping-root data-currency-code="<?php echo $currency_code ?>" data-currency-symbol="<?php echo $currency_symbol ?>" class="available-shipping-rates-container">
                <label for="" class="shipping-carrier-container shipping-carrier-container-loader">
                    <div class="shipping-carrier-name">
                        <p class="shipping-carrier-container-loading">Getting rates...</p>
                    </div>
                </label>
            </div>

        </div>
        <div class="admin-popup__actions">
            <a
                href="javascript:void(0);"
                class="admin-popup-cancel order-popup-cancel"
                data-fancybox-close
            >
                <span>Cancel</span>
            </a>
            <input
                type="submit"
                class="admin-popup-submit"
                data-action-create-shipping-label
                value="Create Label"
            >
        </div>
    </div>
</form>
