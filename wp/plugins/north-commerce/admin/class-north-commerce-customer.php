<?php

use NorthCommerce\Models\CustomerModel;

/**
 * Customer controller class.
 *
 *
 * @package north-commerce/admin
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.3
 * @version 0.1.24
 */
class North_Commerce_Customer extends North_Commerce_Admin_Base {

	private $customer_model;

	/**
	 * @version 0.1.24
	 */
	public function __construct() {
		parent::__construct();
		$this->customer_model = new CustomerModel();
	}

	public function get_customers_admin_ui() {
        $page = sanitize_text_field( $_POST['page'] ?? 1 ); // phpcs:ignore WordPress.Security.NonceVerification.Missing
        $posts_per_page = sanitize_text_field( $_POST['posts_per_page'] ?? 10 ); // phpcs:ignore WordPress.Security.NonceVerification.Missing
        $status = sanitize_text_field( $_POST['status'] ?? true );

		$filter = $_POST['filter'] ?? [];
		if ( ! is_array( $filter ) ) {
			$filter = [];
		}

        $result = $this->get_customer_items( $page, $posts_per_page, $status, $filter );
        wp_die( json_encode( $result ) );

	}

	public function get_customer_items( $page = 1, $per_page = 10, $user_type = 'any', $filter = array() ) {
        $options = [
            'limit' => $per_page,
            'offset' => $per_page * ( $page - 1 ),
        ];

		if ( $filter['customer-data-sort'] ?? false ) {
			$sort_direction = in_array( $filter['customer-data-sort'], [ 'ASC', 'DESC' ] )
				? $filter['customer-data-sort']
				: 'DESC';
			$options['order_by'] = "created $sort_direction";
		}

		$criteria = true;
		if ($filter['customer-search'] ?? false) {
			$search_input = $filter['customer-search'];
			$criteria = [
				'or',
				[ 'eq', 'id', $search_input ],
				[ 'like', 'first_name', "%{$search_input}%" ],
				[ 'like', 'last_name', "%{$search_input}%" ],
				[ 'like', 'email', "%{$search_input}%" ],
			];
		}

        $criteria = apply_filters( 'north-commerce/get_order_items/criteria', $criteria );
        $options = apply_filters( 'north-commerce/get_order_items/options', $options );

		$customers = $this->customer_model->list_all( $criteria, $options );

		$total_customers_count = $this->customer_model->get_total_count( $criteria );
        if ( $customers ) {
            ob_start();
            foreach ( $customers as $customer ) {
                $this->template( 'customer-item', 'customer', ['customer' => $customer] );
            }
            $result['customers'] = ob_get_contents();
            ob_end_clean();

            $total_customers_count = $this->customer_model->get_total_count( $criteria );
            $result['max_page'] = ceil( $total_customers_count / $per_page );
        } else {
            $result['customers'] = '<div class="result__empty" style="display: block;">Customers not found!</div>';
            $result['max_page'] = 0;
        }

        $result['current_page'] = $page;

        $result['pagination'] = count( $customers )
            ? $options['offset'] + 1 . '-' . ( $options['offset'] + count( $customers ) ) . ' of ' . ( $total_customers_count ?? 0 )
            : '0-0 of 0';


		return $result;
	}

}
