<?php

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\NotificationModel;

/**
 * Notification Events controller.
 *
 *
 * @package north-commerce/admin
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.19
 * @version 0.1.24
 */
class North_Commerce_Notification_Event {

	const SCHEMA_VERSION_WITH_NOTIFICATION_EVENTS = 39;

    protected $notification_model;

    /**
     * @version 0.1.24
     */
    public function __construct() {
        $schema_version = ( North_Commerce_Db_Agent::instance() )->schema()->installedVersion();

        if ( $schema_version < self::SCHEMA_VERSION_WITH_NOTIFICATION_EVENTS ) {
            return false;
        }

        $this->notification_model = new NotificationModel();

        $notifications_list = $this->notification_model->list();
        foreach ( $notifications_list as $notification ) {
            $trigger_event = $notification['trigger_event'];

            if ( ! $trigger_event ) {
                continue;
            }

            add_action( "nc_db_event/{$trigger_event}", function( $event, $table, $old, $new, $processed ) use ( $notification ) {
                $notification_controller = new North_Commerce_Notification;

                // This functionality requires that a customer phone number and email exists within $data['customer']
                if (
                    ! isset( $processed['customer']['phone'] )
                    && ! isset( $processed['customer']['email'] )
                ) {
                    return;
                }

                $relation = $table;

                if ( 'orders' === $table ) {
                    // special case for orders table
                    $relation = 'order';
                }

                $customer_notification_data = [
                    'relation' => $relation,
                    $relation => $processed,
                    'email' => $processed['customer']['email'],
                    'phone' => $processed['customer']['phone'],
                ];

                $notification_controller->send_notifications( $notification['slug'], $customer_notification_data );

            }, 10, 5 );
        }
    }

}
