/**
 * Notifications Settings
 *
 * @since 0.1.19
 */
export class SettingsNotifications {
    constructor() {
        const notificationSection = document.querySelector('.settings-tab .notification-section')
        const notificationSettingsForm = document.querySelector('.north-settings .notification-form')

        const notificationOverlay = notificationSettingsForm
            ? notificationSettingsForm.querySelector('.notification__overlay')
            : null


        jQuery('.notification-email').on('click', function(e) {
            const slug = jQuery(this).data('notification-id')
            const status = jQuery(this).is(':checked')

            jQuery.ajax({
                type: 'POST',
                url: ajax_object.ajaxurl,
                data: {
                    'action': 'toggle_notification_email',
                    slug,
                    status
                },
                beforeSend() {
                    if (notificationOverlay) {
                        notificationOverlay.style.display = 'block'
                    }
                },
                success: function () {
                    if (notificationOverlay) {
                        notificationOverlay.style.display = 'none'
                    }
                }
            })
        })

        jQuery('.notification-sms').on('click', function() {
            const slug = jQuery(this).data('notification-id')
            const status = jQuery(this).is(':checked')

            jQuery.ajax({
                type: 'POST',
                url: ajax_object.ajaxurl,
                data: {
                    'action': 'toggle_notification_sms',
                    slug,
                    status
                },
                beforeSend() {
                    if (notificationOverlay) {
                        notificationOverlay.style.display = 'block'
                    }
                },
                success: function () {
                    if (notificationOverlay) {
                        notificationOverlay.style.display = 'none'
                    }
                }
            })
        })


        if (notificationSection) {

            jQuery('.notification__dropdown').on('click', function() {
                jQuery(this).parents('.notification').toggleClass('active')
            })

            jQuery('input[name="desktop_notification"]').on('click', function() {
                const status = jQuery(this).is(':checked')

                jQuery.ajax({
                    type: 'POST',
                    url: ajax_object.ajaxurl,
                    data: {
                        'action': 'toggle_desktop_notifications',
                        status
                    },
                    beforeSend() {
                        if (notificationOverlay) {
                            notificationOverlay.style.display = 'block'
                        }
                    },
                    success: function () {
                        if (notificationOverlay) {
                            notificationOverlay.style.display = 'none'
                        }
                    }
                })
            })

        }

        if (notificationSettingsForm) {

            jQuery('.form-notification__toggle').on('click', function() {
                let type = jQuery(this).data('notification-type');
                jQuery('.form-notification__toggle.active').removeClass('active');
                jQuery('.form-notification__content.active').removeClass('active');
                jQuery(this).addClass('active');
                jQuery('.form-notification__content[data-notification-type="' + type + '"]').addClass('active');
            })

            jQuery('.notification-form').on('submit', function(e) {
                e.preventDefault();

                const formData = jQuery(this).serializeArray()
                formData.push({
                    name: 'notification-id',
                    value: jQuery(this).data('notification-id')
                })

                jQuery.ajax({
                    type: 'POST',
                    url: ajax_object.ajaxurl,
                    data: {
                        'action': 'update_notification',
                        'data': formData.reduce( function(m,o) { m[o.name] = o.value; return m;}, {} ),
                    },
                    beforeSend() {
                        jQuery('.action-save').addClass('disabled')
                    },
                    success: function () {
                        location.reload()
                    },
                    error: function (j){
                        let error_txt = '<div><div class="admin-popup__header" style="margin:0;"><a href="javascript:void(0);" class="admin-popup__close" data-fancybox-close="" style="position:absolute;top:10px;right:10px;width:20px;height:20px;border:0;"></a></div><div style="color:red;">Incorrect structure of notification email template.<div><div>'
                        jQuery.fancybox.open({
                            src : error_txt,
                            type : 'inline',
                            opts : {
                                modal: true,
                                infobar: false,
                                toolbar: false,
                                arrows: false,
                            },
                        })
                        jQuery('.action-save').removeClass('disabled')
                        console.warn(j)
                    }
                })
            })

            jQuery('.notification-form__readmore').on('click', function() {
                jQuery.fancybox.open({
                    src: jQuery('.notification-about-variables'),
                    type: 'inline',
                    opts: {
                        modal: true,
                        infobar: false,
                        toolbar: false,
                        arrows: false,
                    },
                })
            })

            let emailSubjectPos = 0
            jQuery('.notification-field__input[name="notification-email-subject"]').on('keyup click', function(e) {
                emailSubjectPos = jQuery(this).prop('selectionStart')
            })

            let emailBodyPos = 0
            jQuery('.notification-field__input[name="notification-email-body"]').on('keyup click', function(e) {
                emailBodyPos = jQuery(this).prop('selectionStart')
            })

            let smsPos = 0
            jQuery('.notification-field__input[name="notification-sms-content"]').on('keyup click', function(e) {
                smsPos = jQuery(this).prop('selectionStart')
            })

            let currentTemplateInput = ''
            jQuery('.notification-form input, .notification-form textarea').focus(function() {
                currentTemplateInput = jQuery(this).attr('name')
            })

            jQuery(document).on('mouseup', '#select2-notification-variable-results > li', function(e) {
                if ( ! currentTemplateInput ) {
                    return
                }

                const textArea = jQuery('.notification-field__input[name="' + currentTemplateInput + '"]')

                const position = 'notification-email-subject' === currentTemplateInput
                    ? emailSubjectPos
                    : ( 'notification-email-body' === currentTemplateInput ? emailBodyPos : smsPos )

                const updatedText = [
                    textArea.val().slice( 0, position ),
                    getTemplateVariable(),
                    textArea.val().slice( position )
                ]

                textArea.val( updatedText.join('') )

                function getTemplateVariable() {
                    let variable = jQuery('select[name="notification-variable"]').find(':selected').val()

                    if ( 'line_items' === variable ) {
                        return `\n{{line_items_loop_start}}\n\t<div class="line_item">\n\t\t<img src="{{line_item_image}}">\n\t\t{{line_item_description}}\n\t\t{{line_item_quantity}}\n\t\t{{line_item_amount}}\n\t</div>\n{{line_items_loop_end}}\n\n`
                    }

                    return `{{${variable}}}`
                }
            })

            jQuery('.notification-form__action-test').on('click', function() {
                const form = jQuery('.notification-test-send')
                const currentType = jQuery('.form-notification__content[data-notification-type="email"]').hasClass('active') ? 'email' : 'sms'

                form.attr('data-form-type', currentType)
                form.find('.admin-popup-submit').css('pointer-events', 'all')
                form.find('.loader').css('display', 'none')
                form.find('.north-error').remove()
                form.find('.north-success').css('display', 'none')

                jQuery.fancybox.open({
                    src : form,
                    type : 'inline',
                    opts : {
                        modal: true,
                        infobar: false,
                        toolbar: false,
                        arrows: false,
                    },
                })
            })

            jQuery(document).on('submit', '.notification-test-send', function(e) {
                e.preventDefault()

                const form = e.target
                const data = {
                    relation: document.querySelector('.notification-form__variables').dataset.notificationRelation
                }

                if (jQuery('.form-notification__content[data-notification-type="email"]').hasClass('active')) {
                    data.email = form.querySelector('.test_email').value
                    data.action = 'send_test_email'
                    data.subject = jQuery('.notification-field__input[name="notification-email-subject"]').val()
                    data.body = jQuery('.notification-field__input[name="notification-email-body"]').val()
                } else {
                    data.phone = form.querySelector('.test_phone').value
                    data.action = 'send_test_sms'
                    data.body = jQuery('.notification-field__input[name="notification-sms-content"]').val()
                }

                if ( ! data.email && ! data.phone ) {
                    // Bailout
                    return e.target.querySelector('[type="submit"]').blur()
                }

                jQuery.ajax({
                    type: 'POST',
                    url: ajax_object.ajaxurl,
                    data: data,
                    beforeSend() {
                        form.querySelector('.admin-popup-submit').style.pointerEvents = 'none'
                        form.querySelector('.north-success').style.display = 'none'
                        form.querySelector('.loader').style.display = 'block'
                        const northError = form.querySelector('.north-error')
                        if (northError) {
                            northError.remove()
                        }
                    },
                    success: function (response) {
                        if ( ! response.success ) {
                            form.querySelector('.admin-popup__notice').insertAdjacentHTML(
                                'beforeend',
                                '<div class="north-error">' + response.data + '</div>'
                            )
                        } else {
                            form.querySelector('.north-success').style.display = 'block'
                        }

                        form.querySelector('.admin-popup-submit').style.pointerEvents = 'all'
                        form.querySelector('.loader').style.display = 'none'
                    },
                    error(e) {
                        form.querySelector('.admin-popup-submit').style.pointerEvents = 'all'
                        form.querySelector('.loader').style.display = 'none'
                        let error_txt = '<div style="border-radius: 20px;"><div class="admin-popup__header" style="margin:0;"><a href="javascript:void(0);" class="admin-popup__close" data-fancybox-close="" style="position:absolute;top:14px;right:14px;width:20px;height:20px;border:0;"></a></div><div style="color:red;text-align:center;">Email sending error.<br>Maybe incorrect structure of notification email template or system error.<div><div>'
                        jQuery.fancybox.open({
                            src : error_txt,
                            type : 'inline',
                            opts : {
                                modal: true,
                                infobar: false,
                                toolbar: false,
                                arrows: false,
                            },
                        })
                        console.warn(e)
                    }
                })
            })

            jQuery('.notification-form__action-preview').on('click', function(e) {
                const data = {
                    relation: jQuery('.notification-form__variables').data('notification-relation')
                }

                if (jQuery('.form-notification__content[data-notification-type="email"]').hasClass('active')) {
                    data.action = 'build_test_email'
                    data.subject = jQuery('.notification-field__input[name="notification-email-subject"]').val()
                    data.body = jQuery('.notification-field__input[name="notification-email-body"]').val()
                } else {
                    data.action = 'build_test_sms'
                    data.body = jQuery('.notification-field__input[name="notification-sms-content"]').val()
                }

                jQuery.ajax({
                    type: 'POST',
                    url: ajax_object.ajaxurl,
                    data: data,
                    beforeSend() {
                        //e.target.classList.add('disabled')
                    },
                    success: function (response) {
                        //e.target.classList.remove('disabled')

                        if ( ! response.success ) {
                            return console.warn(response.data)
                        }

                        const form  = jQuery('.notification-preview-popup')
                        form.find('.admin-popup__body').html(response.data)

                        jQuery.fancybox.open({
                            src : form,
                            type : 'inline',
                            opts : {
                                modal: true,
                                infobar: false,
                                toolbar: false,
                                arrows: false,
                            },
                        })
                    },
                    error(j) {
                        let error_txt = ''
                        //if(j && j.statusText){
                            //error_txt = '<div><div class="admin-popup__header" style="margin:0;"><a href="javascript:void(0);" class="admin-popup__close" data-fancybox-close="" style="position:absolute;top:10px;right:10px;width:20px;height:20px;border:0;"></a></div><div style="color:red;">' + j.statusText + '</div></div>'
                        //}else{
                            error_txt = '<div style="border-radius: 20px;"><div class="admin-popup__header" style="margin:0;"><a href="javascript:void(0);" class="admin-popup__close" data-fancybox-close="" style="position:absolute;top:14px;right:14px;width:20px;height:20px;border:0;"></a></div><div style="color:red;">Incorrect structure of notification email template.<div><div>'
                        //}


                        jQuery.fancybox.open({
                            src : error_txt,
                            type : 'inline',
                            opts : {
                                modal: true,
                                infobar: false,
                                toolbar: false,
                                arrows: false,
                            },
                        })
                        console.warn(j)
                    }
                })
            })

        }
    }
}
