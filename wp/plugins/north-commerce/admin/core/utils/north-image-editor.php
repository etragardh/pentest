<?php

defined( 'ABSPATH' ) || exit;

/**
 * @since 0.1.0
 * @version 0.1.2
 */
function rotate_post_attachment( ...$args  ) {

    $args = $args[0];
    $image_id = $args['id'] ?? '';
    $image_url = $args['url'] ?? '';
    $angle = $args['rotate'] ?? '';

    if ( '0' === $angle ) {
        // Bailout
        return;
    }

    if ( $image_url && ! $image_id ) {
        global $wpdb;
        $attachment = $wpdb->get_col( $wpdb->prepare( "SELECT ID FROM $wpdb->posts WHERE guid='%s';", $image_url ) );
        $image_id = $attachment[0] ?? null;
    }

    $url = wp_get_original_image_path( $image_id );

    if ( ! $url ) {
        // Bailout
        return;
    }

    $editor = wp_get_image_editor( $url );
    $meta = wp_get_attachment_metadata( $image_id );

    if ( ! is_wp_error( $editor ) ) {
        $editor->rotate( $angle );
        $editor->save( $url );
    }

    $file_name = basename( $meta['file'] );
    $folder_url = $_SERVER['DOCUMENT_ROOT'] . '/wp-content/uploads/' . str_replace( $file_name, '', $meta['file'] );

    if ( ! empty( $meta['sizes'] ) ) {
        foreach ( $meta['sizes'] as $value ) {
            $uri = $folder_url . $value['file'];
            $editor = wp_get_image_editor( $uri );
            if ( ! is_wp_error( $editor ) ) {
                $editor->rotate( $angle );
                $editor->save( $uri );
            }
        }
    }

    wp_update_attachment_metadata( $image_id, $meta );

}
