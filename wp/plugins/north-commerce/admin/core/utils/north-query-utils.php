<?php

/**
 * Multi search on title and meta-key value
 */

defined( 'ABSPATH' ) || exit;

class North_Query_Utils {

    public function search_on_title_or_meta( $query ) {
        if( $title = $query->get( '_meta_or_title' ) ) {
            add_filter( 'get_meta_sql', function( $sql ) use ( $title ) {
                global $wpdb;

                $sql['where'] = sprintf(
                    " AND ( %s OR %s ) ",
                    $wpdb->prepare( "{$wpdb->posts}.post_title like '%%%s%%'", $title ),
                    mb_substr( $sql['where'], 5, mb_strlen( $sql['where'] ) )
                );
                return $sql;
            } );
        }
    }

    public function title_filter( $where, &$wp_query ) {
        global $wpdb;
        if ( $search_term = $wp_query->get( 'search_prod_title' ) ) {
            $where .= ' AND ' . $wpdb->posts . '.post_title LIKE \'%' . esc_sql( like_escape( $search_term ) ) . '%\'';
        }
        return $where;
    }

}
