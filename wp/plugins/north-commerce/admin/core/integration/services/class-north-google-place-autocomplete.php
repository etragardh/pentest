<?php
/**
 * Google Place Autocomplete integration
 *
 *
 * @package  north-commerce/admin/core/integrations
 * @link     https://northcommerce.com/
 * @since    0.1.4
 * @version  0.1.13
 */
class North_Commerce_GooglePlaceAutocomplete implements North_Integration_Connectable {

	public const OPTIONAL_KEY = 'google_place_autocomplete';

	/**
	 * @var  string  $api_key  Google API Key.
	 */
	private $api_key;

	/**
	 * @var  bool  $enabled  Connection status.
	 */
	private $enabled;


	public function __construct() {
		$options = get_option( self::OPTIONAL_KEY, array() );
		$this->api_key = $options['api_key'] ?? '';
		$this->enabled = $options['enabled'] ?? false;
	}

	public function get_integration_label(): string {
		return 'Google Place Autocomplete';
	}

	public function get_integration_icon(): string {
		return NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/integration-google-place-autocomplete.png';
	}

	public function get_integration_description(): string {
		return 'The Place Autocomplete service is a web service that returns place predictions in response to an HTTP request.';
	}

	public function update_options() {
		update_option( self::OPTIONAL_KEY, [
			'api_key' => $this->api_key,
			'enabled' => $this->enabled,
		] );
	}

	/**
	 * @param  array  $args  Connection arguments.
	 *
	 * @since   0.1.4
	 * @version 0.1.24
	 */
	public function connect( $args ): array {
		if ( empty( $args ) || $args['integration_id'] !== self::OPTIONAL_KEY ) {
			return [ 'is_connected' => false ];
		}

        $this->api_key = $args['api_key'];
        $this->enabled = $this->has_keys();
		$this->update_options();

		return [ 'is_connected' => $this->enabled ];
	}

	public function disconnect(): bool {
		$this->enabled = false;
		$this->update_options();
		return true;
	}

	public function is_connected(): bool {
		return $this->enabled;
	}

	public function has_keys(): bool {
		return (bool) $this->api_key;
	}

	public function get_api_key(): string {
		return $this->api_key;
	}

	/**
	 * Get Form field fot integration tab
	 *
	 * @since   0.1.4
	 * @version 0.1.13
	 */
	public function get_form_fields(): string {
		ob_start();
		?>
		<input type="hidden" name="integration_id" value="<?php echo self::OPTIONAL_KEY; ?>">
		<div class="admin-popup-field">
			<label for="api_key">
				<?php esc_html_e( 'Google API Key', 'north-commerce' ); ?>
			</label>
			<input
				type="text"
				name="api_key"
				id="api_key"
				value="<?php echo $this->get_api_key(); ?>"
				class="api_key"
				>
		</div>
		<?php
		return ob_get_clean();
	}

}
