<?php
/*
 * A PHP file for testing out our API db_helper
 */
require_once(__DIR__ . '/../../north-commerce-test-case.php');

class North_Commerce_Api_Db_Helper_Test extends North_Commerce_Db_Test_Case
{

	public function testTargetTable()
	{
		$tests = [
			['params' => ['entity' => 'orders'], 'expected' => 'orders'],
			['params' => ['entity' => 'orders', 'id' => 94], 'expected' => 'orders'],
			['params' => ['entity' => 'does-not-exist', 'id' => 94], 'expected' => false],
			['params' => ['parent' => 'orders', 'id' => 29, 'child' => 'line-items'], 'expected'=> 'line_items'],
			['params' => ['bob' => 100], 'expected' => false]
		];

		$db_helper = new North_Commerce_Api_Db_Helper();
		
		foreach($tests as $t) {
			$req = new WP_Rest_Request();
			$req->set_url_params($t['params']);
			$this->assertEquals($t['expected'], $db_helper->targetTable($req));
		}
	}

	public function testTargetTableColumns()
	{
		$agent = North_Commerce_Db_Agent::instance();
		$db_helper = new North_Commerce_Api_Db_Helper();
		$req = new WP_Rest_Request();
		$req->set_url_params([
			'parent' => 'orders',
			'id' => 19,
			'child' => 'line-items'
		]);

		$table = nc_g($agent->schema()->getTables(), 'line_items');
		$cols = $db_helper->targetTableColumns($req);

		foreach($cols as $name => $desc) {
			$this->assertIsArray($table['cols'][$name]);
		}

	}

}
