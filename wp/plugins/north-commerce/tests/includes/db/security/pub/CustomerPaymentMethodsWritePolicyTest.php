<?php
/*
 * A PHP file for testing out our customer payment
 * method write policy
 */

use NorthCommerce\Db\Collections\PaymentProviders;
use NorthCommerce\Db\Security\Pub\CustomerPaymentMethodsWritePolicy;

require_once(__DIR__ . '/../../North_Commerce_Db_Test_Case.php');

class CustomerPaymentMethodsWritePolicyTest extends North_Commerce_Db_Test_Case
{

	public function testPrepareForCreate()
	{
		$c = $this->ef->newCustomer();
		$values = [
			'customer_id' => $c['id'],
			'payment_provider_id' => PaymentProviders::stripe()->id
		];

		$wp = new CustomerPaymentMethodsWritePolicy();
		$updated =  $wp->prepareForCreate($values);

		foreach($values as $k => $v) {
			$this->assertEquals($v, $updated[$k]);
		}

		$this->assertIsString($updated['token']);

		$sc = (new North_Commerce_Stripe())->stripe_client();
		$stripe_customer = $sc->customers->retrieve($updated['token']);
		$this->assertEquals($updated['token'], $stripe_customer->id);
	}

}
