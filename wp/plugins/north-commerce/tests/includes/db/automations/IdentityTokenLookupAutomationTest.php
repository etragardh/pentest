<?php
/*
 * A PHP file for testing out StripeTransactionLookupAutomation
 */

use NorthCommerce\Db\Automations\IdentityTokenLookupAutomation;

require_once(__DIR__ . '/../../../north-commerce-test-case.php');

class IdentityTokenLookupAutomationTest extends North_Commerce_Test_case
{
	public function testOnEntityAccessCriteriaSuccess()
	{
		$ot = $this->ef->newOrderTransaction();
		$this->assertStringStartsWith('pi_', $ot['identity_token']);

		$this->agent->perspectiveManager()->asPublic(function() use($ot) {
			$stla = new IdentityTokenLookupAutomation();
			$criteria = $stla->onEntityAccessCriteria(['identity_token' => $ot['identity_token']],
													  'order_transactions');
			$this->assertCount(1, $criteria);
			$this->assertEquals($ot['id'], $criteria['id']);
		});
	}

	public function testOnEntityAccessCriteriaIgnored()
	{
		$this->agent->perspectiveManager()->asPublic(function() {
			$stla = new IdentityTokenLookupAutomation();
			$criteria = $stla->onEntityAccessCriteria(['amount' => 100], 'order_transactions');
			$this->assertCount(1, $criteria);
			$this->assertEquals(100, $criteria['amount']);
		});
	}
}
