<?php
/*
 * A PHP file for testing out our DB updater
 */

require_once(__DIR__ . "/North_Commerce_Db_Test_Case.php");

class North_Commerce_Db_Updater_Test extends North_Commerce_Db_Test_Case
{

	public function testUpdateFile() {
		$agent = North_Commerce_Db_Agent::instance();
		$f = $agent->updater()->updateFile(2);
		$text = file_get_contents($f);
		$this->assertStringContainsString("customs_details", $text);
	}

	public function testUpdateSql() {
		$agent = North_Commerce_Db_Agent::instance();
		$prefix = "unit_test_" . nc_random_token() . "_";
		$statements = $agent->updater()->updateSqlStatements($prefix, 2);
		$this->assertGreaterThan(5, count($statements));

		$found = 0;
		
		foreach($statements as $stmt) {
			if(preg_match("/^INSERT INTO {$prefix}customs_content_types/", $stmt)) {
				$found++;
			}
		}
		$this->assertEquals($found, 5);
	}
	
}
