<?php
/*
 * A PHP file for upgrading the DB to include sequence number support
 * See: https://northcommerce.atlassian.net/browse/NC-137
 */
?>
-- Table: sequence_numbers
CREATE TABLE <?= $prefix ?>sequence_numbers (
  slug VARCHAR(64) NOT NULL,
  INDEX(slug),
  value INT NOT NULL,
  INDEX(value),
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

<?php foreach(['order', 'customer'] as $t) { ?>
	ALTER TABLE <?= $prefix?><?= $t ?>s ADD COLUMN  <?= $t ?>_number INT NOT NULL AFTER id;
	ALTER TABLE <?= $prefix?><?= $t ?>s ADD INDEX(<?= $t ?>_number);
	UPDATE <?= $prefix?><?= $t ?>s SET <?= $t ?>_number = (@rownum := 1 + @rownum) + 1000
  	WHERE 0 = (@rownum := 0) AND <?= $t ?>_number = 0;
	INSERT INTO <?= $prefix ?>sequence_numbers(slug,value)
	  SELECT '<?= $t ?>-number', MAX(<?= $t ?>_number) FROM <?= $prefix?><?= $t ?>s;
<?php } ?>
