<?php
/**
 * Update DB Schema from v.25 to v.26.
 *
 * Implement shipping_details changes to formalize this structure.
 */

$to_remove = [
	'ezpost_carrier_id',
	'ezpost_shipping_id',
	'fixed_rate_id',
	'planned_handling_fee',
	'planned_handling_percentage',
];

$to_add = [
	'carrier VARCHAR(128) NULL',
	'service VARCHAR(128) NULL',
	'handling_percentage DECIMAL(4,2)',
	'ezpost_rate_id VARCHAR(128) NULL',
	'ezpost_shipment_id VARCHAR(128) NULL',
	'shipping_rates_internal_id BIGINT NULL',
	'shipping_rates_easypost_id BIGINT NULL'
];
?>

ALTER TABLE <?php echo $prefix?>orders CHANGE shipping_detail_id planned_shipping_detail_id CHAR(28) NULL;
ALTER TABLE  <?php echo $prefix?>orders ADD actual_shipping_detail_id CHAR(28) NULL;
ALTER TABLE <?php echo $prefix?>orders ADD FOREIGN KEY(actual_shipping_detail_id) REFERENCES <?php echo $prefix?>shipping_details(id);


<?php foreach($to_remove as $col) { ?>
	ALTER TABLE <?php echo $prefix ?>shipping_details DROP <?php echo $col ?>;
<?php } ?>

<?php foreach($to_add as $defn) { ?>
	ALTER TABLE <?php echo $prefix ?>shipping_details ADD <?php echo $defn ?>;
<?php } ?>

ALTER TABLE <?php echo $prefix?>shipping_details ADD FOREIGN KEY(shipping_rates_internal_id) REFERENCES <?php echo $prefix?>shipping_rates_internal(id);
ALTER TABLE <?php echo $prefix?>shipping_details ADD FOREIGN KEY(shipping_rates_easypost_id) REFERENCES <?php echo $prefix?>shipping_rates_easypost(id);

<?php
/*
 * Address some schema inconsistencies between the schema definition
 * and the updates for shipping tables.
 *
 * Just bringing things back into sync.
 */

$inspector = North_Commerce_Db_Agent::instance()->introspector();
?>

<?php
$col_indexes = $inspector->tableColumns("{$prefix}shipping_addresses", [
	'as' => 'index_map'
]);
?>
<?php if(isset($col_indexes['shipping_profile_id'])) { ?>
	ALTER TABLE <?php echo $prefix  ?>shipping_addresses DROP shipping_profile_id;
<?php } ?>

<?php
$needs_created = [
	'shipping_addresses',
	'shipping_profile_product_variants',
	'shipping_profiles',
	'shipping_rate_condition_bases',
	'shipping_rate_conditions',
	'shipping_rates_easypost',
	'shipping_rates_internal',
	'shipping_zones',
];
?>
<?php  foreach($needs_created as $table) { ?>
	<?php $col_indexes = $inspector->tableColumns("{$prefix}$table", [ 'as' => 'index_map' ]); ?>
	<?php if($col_indexes['created'] != 'MUL') { ?>
		CREATE INDEX created ON <?php echo $prefix  ?><?php echo $table ?>(created);
	<?php  } ?>
<?php } ?>

ALTER TABLE <?php echo $prefix  ?>shipping_rate_condition_bases DROP INDEX slug;
ALTER TABLE <?php echo $prefix  ?>shipping_rate_condition_bases ADD UNIQUE(slug);


<?php $col_indexes = $inspector->tableColumns("{$prefix}shipping_rates_internal", [ 'as' => 'index_map' ]); ?>
<?php if($col_indexes['has_conditions'] == 'MUL') { ?>
	ALTER TABLE <?php echo $prefix  ?>shipping_rates_internal DROP INDEX has_conditions;
<?php } ?>

<?php if($col_indexes['conditions_operator'] == 'MUL') { ?>
	ALTER TABLE <?php echo $prefix  ?>shipping_rates_internal DROP INDEX conditions_operator;
<?php } ?>
