<?php
/**
 * Update DB Schema to version 25.
 *
 * Fix slug for `Partially Paid` payment status.
 * Add `Partially Fulfilled` order status.
 * Add Notification tables.
 *
 * @since   0.1.19
 * @version 0.1.24
 */

?>
UPDATE <?php echo $prefix; ?>payment_statuses SET slug = 'partially-paid' WHERE name = 'Partially Paid';
INSERT INTO <?php echo $prefix; ?>payment_statuses (name, slug) VALUES ('Partially Paid', 'partially-paid') ON DUPLICATE KEY UPDATE slug = 'partially-paid';

INSERT INTO <?php echo $prefix; ?>order_statuses (name, slug) VALUES ('Partially Fulfilled', 'partially-fulfilled') ON DUPLICATE KEY UPDATE slug = 'partially-fulfilled';

CREATE TABLE <?php echo $prefix ?>notification_types (
  `id` BIGINT NOT NULL AUTO_INCREMENT
  , PRIMARY KEY (`id`)
  , `slug` VARCHAR(128) NOT NULL UNIQUE
  , INDEX(`slug`)
  , `title` VARCHAR(512) NOT NULL
  , `description` VARCHAR(1024) NULL
  , `desktop_enabled` BOOLEAN NOT NULL
  , `created` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  , INDEX(`created`)
) Engine=Innodb;

INSERT INTO <?php echo $prefix; ?>notification_types (slug, title, description) VALUES ('customer', 'Customer notifications', 'Customize the look of your email notifications templates, or edit the content of your SMS notifications individually.');
INSERT INTO <?php echo $prefix; ?>notification_types (slug, title, description) VALUES ('admin', 'Admin notifications', 'Choose how you want to be notified.');
<?php

$type_customer_id = 1;
$type_admin_id = 2;

?>
CREATE TABLE <?php echo $prefix; ?>notifications (
	`id` BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (`id`)
	, `slug` VARCHAR(128) NOT NULL UNIQUE
	, INDEX(`slug`)
	, `title` VARCHAR(255) NOT NULL
	, `description` VARCHAR(1024) NULL
	, `email_enabled` BOOLEAN NOT NULL
	, `email_subject` VARCHAR(512) NULL
	, `email_body` MEDIUMTEXT NULL
	, `sms_enabled` BOOLEAN NOT NULL
	, `sms_body` VARCHAR(1024) NULL
	, `notification_type_id` BIGINT NOT NULL
	, FOREIGN KEY(`notification_type_id`) REFERENCES <?php echo $prefix; ?>notification_types(`id`)
    , `created` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    , INDEX(`created`)
) ENGINE = InnoDB;
<?php

$notifications_list = [
	[
		'slug' => 'order_confirmation',
		'title' => 'Order confirmation',
		'description' => 'Notification about placed order.',
		'notification_type_id' => $type_customer_id,
		'email_subject' => nc_schema_25_get_notification_email_subject( 'order_confirmation' ),
		'email_body' => nc_schema_25_get_notification_email_body( 'order_confirmation' ),
	],
	[
		'slug' => 'order_edited',
		'title' => 'Order edited',
		'description' => 'Notifications about edited order.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'order_canceled',
		'title' => 'Order canceled',
		'description' => 'Notification about canceled order.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'order_refund',
		'title' => 'Order refund',
		'description' => 'Notification about refunded order.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'abandoned_commerce',
		'title' => 'Abandoned commerce',
		'description' => 'Notification about the unfinished commerce process.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'pos_and_mobile',
		'title' => 'POS and mobile receipt',
		'description' => 'Notification about an order receipt.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'payment_error',
		'title' => 'Payment error',
		'description' => 'Notification about the payment that cannot be processed.',
		'notification_type_id' => $type_customer_id,
		'email_subject' => nc_schema_25_get_notification_email_subject( 'payment_error' ),
		'email_body' => nc_schema_25_get_notification_email_body( 'payment_error' ),
	],
	[
		'slug' => 'shipping_confirmation',
		'title' => 'Shipping confirmation',
		'description' => 'Notification about fulfilled order.',
		'notification_type_id' => $type_customer_id,
		'email_subject' => nc_schema_25_get_notification_email_subject( 'shipping_confirmation' ),
		'email_body' => nc_schema_25_get_notification_email_body( 'shipping_confirmation' ),
	],
	[
		'slug' => 'customer_account_invite',
		'title' => 'Customer account invite',
		'description' => 'Notifications with account activation instructions.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'customer_account_welcome',
		'title' => 'Customer account welcome',
		'description' => 'Notification about completed account activation.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'customer_account_password_reset',
		'title' => 'Customer account password reset',
		'description' => 'Notification with reset account password instructions.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'contact_customer',
		'title' => 'Contact customer',
		'description' => 'Sent to the customer when you contact them from the orders or customers page.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'confirmation_email',
		'title' => 'Confirmation email',
		'description' => 'Notification about email confirmation (if email double opt-in is enabled).',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'return_instructions',
		'title' => 'Return instructions',
		'description' => 'Sent automatically to the customer when you create a return.',
		'notification_type_id' => $type_customer_id,
	],
	[
		'slug' => 'new_order',
		'title' => 'New order',
		'description' => 'Notification about placed order.',
		'notification_type_id' => $type_admin_id,
	],
	[
		'slug' => 'cancelled_order',
		'title' => 'Cancelled order',
		'description' => 'Notifications about orders that have been marked cancelled.',
		'notification_type_id' => $type_admin_id,
	],
	[
		'slug' => 'failed_order',
		'title' => 'Failed order',
		'description' => 'Notifications about orders that have been marked failed.',
		'notification_type_id' => $type_admin_id,
	],
];

function nc_schema_25_get_notification_email_subject( $notification_slug ):string {
	switch ( $notification_slug ) {
		case 'order_confirmation':
			$email_subject = 'Your order has been completed - {{order_number}}';
			break;
		case 'payment_error':
			$email_subject = 'Failed Payment - Your payment has failed.';
			break;
		case 'shipping_confirmation':
			$email_subject = 'Shipping Confirmation - Your order has been shipped!';
			break;
	}

	return $email_subject ?? '';
}

/**
 * @return string SQL escaped HTML template
 */
function nc_schema_25_get_notification_email_body( $notification_slug ):string {
	$default_notification_file_path = NORTH_COMMERCE_PLUGIN_DIR_PATH . "includes/notifications/$notification_slug.html";

	$html_template = file_get_contents( $default_notification_file_path ) ?: '';
	$html_entities = htmlentities( $html_template, ENT_QUOTES|ENT_SUBSTITUTE|ENT_HTML5 );
	$html_entities_without_doubled_linebreaks = str_replace( "\r&NewLine;", "&NewLine;", $html_entities );

	return $html_entities_without_doubled_linebreaks;
}

$notifications_table = $prefix . 'notifications';
foreach ( $notifications_list as $notification ) {
	echo "INSERT INTO $notifications_table"
		. ' (notification_type_id, slug, title, description)'
		. ' VALUES ('
			. $notification['notification_type_id']
			. ", '{$notification['slug']}'"
			. ", '{$notification['title']}'"
			. ", '{$notification['description']}'"
		. ");\n";

	if ( ! empty( $notification['email_subject'] ) ) {
		echo "UPDATE {$notifications_table}"
			. " SET email_subject = '{$notification['email_subject']}'"
			. " WHERE slug = '{$notification['slug']}';\n";
	}

	if ( ! empty( $notification['email_body'] ) ) {
		echo "UPDATE {$notifications_table}"
			. " SET email_body = '{$notification['email_body']}'"
			. " WHERE slug = '{$notification['slug']}';\n";
	}
}
