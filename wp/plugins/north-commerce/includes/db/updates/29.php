<?php
/**
 * A PHP file for updating our schema from v28 to v29.
 *
 * We're updating the shipping_details (SD) schema from
 * orders point to SD, and having SD point to orders.
 */
$dbi = new North_Commerce_Db_Introspector();
?>

-- Table: shipping_detail_types
CREATE TABLE <?php echo $prefix?>shipping_detail_types (
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;


ALTER TABLE <?php echo $prefix?>shipping_details ADD order_id CHAR(28) NOT NULL AFTER id;
ALTER TABLE <?php echo $prefix?>shipping_details ADD deleted TIMESTAMP NULL AFTER created;
CREATE INDEX deleted ON <?php echo $prefix ?>shipping_details(deleted);
ALTER TABLE <?php echo $prefix?>shipping_details ADD  shipping_detail_type_id BIGINT NOT NULL;


-- Data: shipping_detail_types
INSERT INTO <?php echo $prefix?>shipping_detail_types (name, slug) VALUES ('Planned', 'planned');
INSERT INTO <?php echo $prefix?>shipping_detail_types (name, slug) VALUES ('Actual', 'actual');


UPDATE <?php echo $prefix ?>shipping_details sd JOIN <?php echo $prefix ?>orders o ON (o.planned_shipping_detail_id = sd.id)
  SET sd.order_id = o.id, sd.shipping_detail_type_id = (SELECT id FROM <?php echo $prefix ?>shipping_detail_types WHERE slug = 'planned');

UPDATE <?php echo $prefix ?>shipping_details sd JOIN <?php echo $prefix ?>orders o ON (o.actual_shipping_detail_id = sd.id)
  SET sd.order_id = o.id, sd.shipping_detail_type_id = (SELECT id FROM <?php echo $prefix ?>shipping_detail_types WHERE slug = 'actual');

<?php foreach(['planned', 'actual'] as $type) { ?>
	<?php if(($constraint = $dbi->foreignKeyConstraintName('orders', "{$type}_shipping_detail_id",
														   ['prefix' => $prefix]))) { ?>
		ALTER TABLE <?= $prefix?>orders DROP FOREIGN KEY <?= $constraint?>;
	<?php } ?>
	ALTER TABLE <?php echo $prefix ?>orders DROP <?php echo $type ?>_shipping_detail_id;
<?php } ?>

DELETE FROM <?php echo $prefix ?>shipping_details WHERE shipping_detail_type_id = 0;

ALTER TABLE <?php echo $prefix?>shipping_details ADD FOREIGN KEY(shipping_detail_type_id) REFERENCES <?php echo $prefix?>shipping_detail_types(id);
ALTER TABLE <?php echo $prefix?>shipping_details ADD FOREIGN KEY(order_id) REFERENCES <?php echo $prefix?>orders(id);
