<?php
/*
 * A PHP file for updating the DB from v12 to v13, tweaking how
 * we store payments
 */
$dbi = new North_Commerce_Db_Introspector();
?>

<?php if(($constraint = $dbi->foreignKeyConstraintName('customer_payment_methods', 'payment_type_id',
													   ['prefix' => $prefix]))) { ?>
	ALTER TABLE <?= $prefix?>customer_payment_methods DROP FOREIGN KEY <?= $constraint?>;
<?php } ?>
ALTER TABLE	<?= $prefix?>customer_payment_methods DROP payment_type_id;
DROP TABLE <?= $prefix?>payment_types;

ALTER TABLE <?= $prefix?>customer_payment_methods CHANGE payment_token token VARCHAR(255) NULL;
ALTER TABLE <?= $prefix?>customer_payment_methods CHANGE payment_last4 last4 VARCHAR(4) NULL;
ALTER TABLE <?= $prefix?>customer_payment_methods ADD    brand VARCHAR(128) NULL;
ALTER TABLE <?= $prefix?>customer_payment_methods ADD    expiration_month INT NULL;
ALTER TABLE <?= $prefix?>customer_payment_methods ADD    expiration_year INT NULL;

CREATE INDEX brand ON  <?= $prefix?>customer_payment_methods(brand);
CREATE INDEX expiration_year ON  <?= $prefix?>customer_payment_methods(expiration_year);
CREATE INDEX expiration_month ON  <?= $prefix?>customer_payment_methods(expiration_month);

<?php foreach(['PayPal', 'Stripe', 'Mollie'] as $name) { ?>
	<?php $slug = strtolower($name); ?>
	INSERT INTO <?= $prefix?>payment_providers(slug,name) VALUES('<?= $slug ?>', '<?= $name ?>');
<?php } ?>
