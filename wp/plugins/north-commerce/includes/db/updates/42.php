<?php
/**
 * Update DB Schema to version 42.
 *
 * Add new notifications:
 *   `order_out_for_delivery`,
 *   `order_ready_for_pickup`
 *
 * @since 0.1.24
 */

$prefix_table = function ( string $table_name ) use ( $prefix ): string {
	return "{$prefix}{$table_name}";
};

$notification_type_customer_id = nc_schema_42_get_notification_type_customer_id( $prefix_table );
$new_notifications_list = [
	[
		'slug' => 'order_out_for_delivery',
		'title' => 'Order is out for delivery',
		'description' => 'Notification about order that is out for delivery.',
		'notification_type_id' => $notification_type_customer_id,
		'email_subject' => nc_schema_42_get_notification_email_subject( 'order_out_for_delivery' ),
		'email_body' => nc_schema_42_get_notification_email_body( 'order_out_for_delivery' ),
		'trigger_event' => 'order.outForDelivery',
		'email_enabled' => 1,
	],
	[
		'slug' => 'order_ready_for_pickup',
		'title' => 'Order is ready for pickup',
		'description' => 'Notification about order that is ready for pickup.',
		'notification_type_id' => $notification_type_customer_id,
		'email_subject' => nc_schema_42_get_notification_email_subject( 'order_ready_for_pickup' ),
		'email_body' => nc_schema_42_get_notification_email_body( 'order_ready_for_pickup' ),
		'trigger_event' => 'order.readyForPickup',
		'email_enabled' => 1,
	],
];

function nc_schema_42_get_notification_type_customer_id( $prefix_table ) {
	global $wpdb;

	$notification_types_table = $prefix_table( 'notification_types' );
	$db_notification_types = $wpdb->get_results( "SELECT id, slug FROM $notification_types_table;" );
	$db_types_by_slug = array_column( $db_notification_types , 'slug' );
	$customer_row_key = array_search( 'customer', $db_types_by_slug );
	return $type_customer_id = (int) $db_notification_types[ $customer_row_key ]->id;
}

function nc_schema_42_get_notification_email_subject( $notification_slug ):string {
	switch ( $notification_slug ) {
		case 'order_out_for_delivery':
			$email_subject = 'Your Order is out for delivery.';
			break;

		case 'order_ready_for_pickup':
			$email_subject = 'Your Order is ready for pickup!';
			break;
	}

	return $email_subject ?? '';
}

/**
 * @return string SQL escaped HTML template
 */
function nc_schema_42_get_notification_email_body( $notification_slug ):string {
	$default_notification_file_path = NORTH_COMMERCE_PLUGIN_DIR_PATH . "includes/notifications/$notification_slug.html";

	$html_template = file_get_contents( $default_notification_file_path ) ?: '';
	$html_entities = htmlentities( $html_template, ENT_QUOTES|ENT_SUBSTITUTE|ENT_HTML5 );
	$html_entities_without_doubled_linebreaks = str_replace( "\r&NewLine;", "&NewLine;", $html_entities );

	return $html_entities_without_doubled_linebreaks;
}

$notifications_table = $prefix_table( 'notifications' );
foreach ( $new_notifications_list as $notification ) {
	echo "INSERT INTO $notifications_table"
		. ' (notification_type_id, slug, title, description, trigger_event, email_enabled)'
		. ' VALUES ('
			. "'{$notification['notification_type_id']}'"
			. ", '{$notification['slug']}'"
			. ", '{$notification['title']}'"
			. ", '{$notification['description']}'"
			. ", '{$notification['trigger_event']}'"
			. ", '{$notification['email_enabled']}'"
		. ");\n";

	if ( ! empty( $notification['email_subject'] ) ) {
		echo "UPDATE {$notifications_table}"
			. " SET email_subject = '{$notification['email_subject']}'"
			. " WHERE slug = '{$notification['slug']}';\n";
	}

	if ( ! empty( $notification['email_body'] ) ) {
		echo "UPDATE {$notifications_table}"
			. " SET email_body = '{$notification['email_body']}'"
			. " WHERE slug = '{$notification['slug']}';\n";
	}
}
