<?php
/**
 * Update DB Schema from v20 to v21.
 *
 * Shipping Profile refactoring.
 */

?>
CREATE TABLE <?php echo $prefix; ?>shipping_addresses (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, shipping_profile_id BIGINT NOT NULL
	, is_default BOOLEAN NOT NULL
	, INDEX(is_default)
	, address VARCHAR(255) NOT NULL
	, INDEX(address)
	, city VARCHAR(128) NOT NULL
	, INDEX(city)
	, state VARCHAR(128) NULL
	, INDEX(state)
	, zipcode VARCHAR(20) NULL
	, INDEX(zipcode)
	, country_id BIGINT NOT NULL
	, FOREIGN KEY(country_id) REFERENCES <?php echo $prefix; ?>countries(id)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE = InnoDB;

CREATE TABLE <?php echo $prefix; ?>shipping_profiles (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, is_default BOOLEAN NOT NULL
	, INDEX(is_default)
	, shipping_address_id BIGINT NULL
	, FOREIGN KEY(shipping_address_id) REFERENCES <?php echo $prefix; ?>shipping_addresses(id)
	, all_variants_included BOOLEAN NOT NULL
	, INDEX(all_variants_included)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

CREATE TABLE <?php echo $prefix; ?>shipping_profile_product_variants (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, shipping_profile_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_profile_id) REFERENCES <?php echo $prefix; ?>shipping_profiles(id)
	, product_variant_id BIGINT NOT NULL
	, FOREIGN KEY(product_variant_id) REFERENCES <?php echo $prefix; ?>product_variants(id)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

CREATE TABLE <?php echo $prefix; ?>shipping_zones (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, shipping_profile_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_profile_id) REFERENCES <?php echo $prefix; ?>shipping_profiles(id)
	, name VARCHAR(64) NOT NULL
	, INDEX(name)
	, slug VARCHAR(64) NOT NULL
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

CREATE TABLE <?php echo $prefix; ?>shipping_rates_internal (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, shipping_zone_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_zone_id) REFERENCES <?php echo $prefix; ?>shipping_zones(id)
	, name VARCHAR(64) NOT NULL
	, INDEX(name)
	, slug VARCHAR(64) NOT NULL
	, INDEX(slug)
	, has_conditions BOOLEAN NOT NULL
	, INDEX(has_conditions)
	, conditions_operator VARCHAR(5) NOT NULL
	, INDEX(conditions_operator)
	, fee_flat DECIMAL(13,2) NULL
	, fee_percent DECIMAL(13,2) NULL
	, price DECIMAL(13,2) NULL
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

CREATE TABLE <?php echo $prefix; ?>shipping_rates_easypost (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, shipping_zone_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_zone_id) REFERENCES <?php echo $prefix; ?>shipping_zones(id)
	, carrier_id VARCHAR(128) NOT NULL
	, INDEX(carrier_id)
	, carrier_label VARCHAR(64) NOT NULL
	, INDEX(carrier_label)
	, services VARCHAR(1024) NULL
	, future_services BOOLEAN NOT NULL
	, fee_flat DECIMAL(13,2) NULL
	, fee_percent DECIMAL(13,2) NULL
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

CREATE TABLE <?php echo $prefix; ?>shipping_rate_condition_bases (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;

INSERT INTO <?php echo $prefix  ?>shipping_rate_condition_bases (name, slug) VALUES ('Weight', 'weight');
INSERT INTO <?php echo $prefix  ?>shipping_rate_condition_bases (name, slug) VALUES ('Price', 'price');
INSERT INTO <?php echo $prefix  ?>shipping_rate_condition_bases (name, slug) VALUES ('User Role', 'user-role');

CREATE TABLE <?php echo $prefix; ?>shipping_rate_conditions (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, shipping_rate_internal_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_rate_internal_id) REFERENCES <?php echo $prefix; ?>shipping_rates_internal(id)
	, shipping_rate_condition_base_id BIGINT NOT NULL
	, FOREIGN KEY(shipping_rate_condition_base_id) REFERENCES <?php echo $prefix; ?>shipping_rate_condition_bases(id)
	, value_min INT NULL
	, value_max INT NULL
	, value_roles VARCHAR(1024) NULL
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) Engine=Innodb;
