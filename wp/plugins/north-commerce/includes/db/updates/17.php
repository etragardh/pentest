<?php
/*
 * A PHP file for updating to version 17 of the schema, which
 * introduces pubids!
 */


$tables = [
	'customers',
	'customer_payment_methods',
	'customer_changes',
	'addresses',
	'shipping_details',
	'orders',
	'order_transactions',
	'line_items',
	'order_changes'
];

$refs = [
	['customer_payment_methods', 'customer_id', 'customers', 'NOT NULL'],
	['customer_tags', 'customer_id', 'customers', 'NOT NULL'],
	['customer_changes', 'customer_id', 'customers', 'NOT NULL'],
	['addresses', 'customer_id', 'customers', 'NOT NULL'],
	['orders', 'customer_id', 'customers', 'NULL'],
	['orders', 'customer_payment_method_id', 'customer_payment_methods', 'NULL'],
	['order_transactions', 'customer_payment_method_id', 'customer_payment_methods', 'NULL'],
	['orders', 'shipping_address_id', 'addresses', 'NULL'],
	['orders', 'billing_address_id', 'addresses', 'NULL'],
	['orders', 'shipping_detail_id', 'shipping_details', 'NULL'],
	['order_transactions', 'order_id', 'orders', 'NOT NULL'],
	['line_items', 'order_id', 'orders', 'NOT NULL'],
	['order_changes', 'order_id', 'orders', 'NOT NULL	']
];

$dbi = new North_Commerce_Db_Introspector();
?>

<?php  foreach($refs as $ref) { ?>
	<?php  [$table, $col, $ref_table, $null] = $ref; ?>
	<?php if($constraint = $dbi->foreignKeyConstraintName($table, $col,
														  ['prefix' => $prefix])) { ?>
		ALTER TABLE <?= $prefix?><?= $table?> DROP FOREIGN KEY <?= $constraint?>;
	<?php } ?>
<?php } ?>

<?php foreach($tables as $t) { ?>
	ALTER TABLE <?= $prefix ?><?= $t?> CHANGE id id CHAR(28) NOT NULL;
<?php  } ?>

<?php foreach($refs as $ref) { ?>
	<?php  [$table, $col, $ref_table, $null] = $ref; ?>
	ALTER TABLE <?= $prefix ?><?= $table ?> CHANGE <?= $col?> <?= $col ?> CHAR(28) <?= $null ?>;
	ALTER TABLE <?= $prefix?><?= $table ?> ADD FOREIGN KEY(<?= $col?>) REFERENCES <?=$prefix?><?=$ref_table?>(id);
<?php  } ?>
