<?php
/*
 * A PHP file for converting version 4 of our schema to 5.
 *
 * Lots of improvements to orders, products and customers here
 */

$dbi = new North_Commerce_Db_Introspector();

$add_slug_col = [
	'product_types',
	'payment_frequencies', 'free_trial_types',
	'customs_content_types', 'product_option_types',
	'order_statuses', 'payment_statuses',
];

$uniques = [
	['table' => 'countries', 'cols' => ['abbreviation', 'name']],
	['table' => 'tags', 'cols' => ['slug']],
	['table' => 'categories', 'cols' => ['slug']],
	['table' => 'order_change_types', 'cols' => ['slug']]
];


$indexes = [
	['table' => 'products', 'cols' => [
		'sku', 'name', 'description',
		'permalink', 'scheduled', 'published', 'deleted',
		'base_price', 'compare_price', 'profit',
		'quantity', 'weight', 'is_physical_product',
	]],
	['table' => 'product_images', 'cols' => [
		'sequence'
	]],
	['table' => 'product_options', 'cols' => [
		'name'
	]],
	['table' => 'product_option_values', 'cols' => [
		'deleted', 'value', 'sequence'
	]],
	['table' => 'product_variants', 'cols' => [
		'sku', 'price', 'quantity', 'sequence'
	]],
	['table' => 'shipping_details', 'cols' => [
		'shipping_cost', 'handling_fee', 'tracking_number'
	]],
	['table' => 'orders', 'cols' => [
		'shipping', 'tax', 'subtotal', 'total', 'paid'
	]],
	['table' => 'line_items', 'cols' => [
		'amount', 'quantity', 'description'
	]],
	['table' => 'order_changes', 'cols' => [
		'value', 'description'
	]],
	['table' => 'categories', 'cols' => ['name', 'slug']],
	['table' => 'tags', 'cols' => ['name', 'slug']],
	['table' => 'order_change_types', 'cols' => ['name']]
];

?>
-- ========================================================================
-- Add missing payment_frequencies row
DELETE FROM <?= $prefix ?>payment_frequencies where name = 'Yearly';
INSERT INTO <?= $prefix ?>payment_frequencies (name) VALUES ('Yearly');

-- ========================================================================
-- Delete extra 'Failed' value
DELETE FROM  <?= $prefix ?>payment_statuses WHERE name = 'Failed' and id = 6;


-- ========================================================================
-- Remove parent id from categories to simplify things
<?php if(($constraint = $dbi->foreignKeyConstraintName('categories', 'parent_id', ['prefix' => $prefix]))) { ?>
	ALTER TABLE <?= $prefix?>categories DROP FOREIGN KEY <?= $constraint?>;
<?php } ?>

ALTER TABLE <?= $prefix ?>categories DROP parent_id;


-- ========================================================================
-- make sure column lengths match
ALTER TABLE <?= $prefix?>tags CHANGE slug slug VARCHAR(128) NOT NULL;
ALTER TABLE <?= $prefix?>tags CHANGE name name VARCHAR(128) NOT NULL;
ALTER TABLE <?= $prefix?>categories CHANGE slug slug VARCHAR(128) NOT NULL;
ALTER TABLE <?= $prefix?>categories CHANGE name name VARCHAR(128) NOT NULL;

-- ========================================================================
-- Table: product_attributes
CREATE TABLE <?= $prefix ?>product_attributes (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: product_attribute_values
CREATE TABLE <?= $prefix ?>product_attribute_values (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  product_id BIGINT NOT NULL,
  product_attribute_id BIGINT NOT NULL,
  value VARCHAR(255) NOT NULL,
  INDEX(value),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Finalize: product_attribute_values
ALTER TABLE <?= $prefix ?>product_attribute_values ADD FOREIGN KEY(product_id) REFERENCES <?= $prefix ?>products(id);
ALTER TABLE <?= $prefix ?>product_attribute_values ADD FOREIGN KEY(product_attribute_id) REFERENCES <?= $prefix ?>product_attributes(id);

-- ========================================================================
-- Remove bump_details
<?php if(($constraint = $dbi->foreignKeyConstraintName('products', 'bump_detail_id', ['prefix' => $prefix]))) { ?>
	ALTER TABLE <?= $prefix?>products DROP FOREIGN KEY <?= $constraint?>;
<?php } ?>
ALTER TABLE <?= $prefix?>products DROP COLUMN bump_detail_id;
DROP TABLE <?= $prefix ?>bump_details;

-- ========================================================================
-- Table: product_variant_types
CREATE TABLE <?= $prefix ?>product_variant_types (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

ALTER TABLE <?= $prefix?>product_variants ADD COLUMN product_variant_type_id BIGINT NOT NULL;
ALTER TABLE <?= $prefix ?>product_variants ADD FOREIGN KEY(product_variant_type_id) REFERENCES <?= $prefix ?>product_variant_types(id);

-- Data: product_variant_types
INSERT INTO <?= $prefix ?>product_variant_types (name, slug) VALUES ('Standard', 'standard');
INSERT INTO <?= $prefix ?>product_variant_types (name, slug) VALUES ('Bump', 'bump');

-- ========================================================================
-- Table: payment_types
CREATE TABLE <?= $prefix ?>payment_types (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: payment_providers
CREATE TABLE <?= $prefix ?>payment_providers (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- ========================================================================
-- Table: customers
CREATE TABLE <?= $prefix ?>customers (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  first_name VARCHAR(128) NOT NULL,
  INDEX(first_name),
  last_name VARCHAR(128) NOT NULL,
  INDEX(last_name),
  email VARCHAR(128) NOT NULL,
  INDEX(email),
  phone VARCHAR(128) NULL,
  INDEX(phone),
  country_code VARCHAR(10) NULL,
  INDEX(country_code),
  wp_user_id BIGINT UNSIGNED NULL,
  INDEX(wp_user_id),
  total_amount_spent DECIMAL(13,2) NULL,
  INDEX(total_amount_spent),
  total_number_of_orders INT NULL,
  INDEX(total_number_of_orders),
  has_active_subscription BOOLEAN NULL,
  INDEX(has_active_subscription),
  marketing_optin BOOLEAN NOT NULL,
  INDEX(marketing_optin),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: customer_payment_methods
CREATE TABLE <?= $prefix ?>customer_payment_methods (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  customer_id BIGINT NOT NULL,
  payment_type_id BIGINT NOT NULL,
  payment_provider_id BIGINT NOT NULL,
  payment_token VARCHAR(255) NULL,
  payment_last4 VARCHAR(4) NULL,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: customer_tags
CREATE TABLE <?= $prefix ?>customer_tags (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  customer_id BIGINT NOT NULL,
  tag_id BIGINT NOT NULL,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: customer_change_types
CREATE TABLE <?= $prefix ?>customer_change_types (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  admin_editable BOOLEAN NOT NULL,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: customer_changes
CREATE TABLE <?= $prefix ?>customer_changes (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  customer_id BIGINT NOT NULL,
  customer_change_type_id BIGINT NOT NULL,
  description VARCHAR(1024) NOT NULL,
  INDEX(description),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: addresses
CREATE TABLE <?= $prefix ?>addresses (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  is_default_shipping BOOLEAN NOT NULL,
  INDEX(is_default_shipping),
  customer_id BIGINT NOT NULL,
  is_default_billing BOOLEAN NOT NULL,
  INDEX(is_default_billing),
  first_name VARCHAR(128) NOT NULL,
  INDEX(first_name),
  last_name VARCHAR(128) NOT NULL,
  INDEX(last_name),
  phone VARCHAR(20) NULL,
  INDEX(phone),
  addressline1 VARCHAR(255) NULL,
  INDEX(addressline1),
  addressline2 VARCHAR(255) NULL,
  city VARCHAR(128) NULL,
  INDEX(city),
  state VARCHAR(128) NULL,
  INDEX(state),
  zipcode VARCHAR(20) NULL,
  INDEX(zipcode),
  country_id BIGINT NOT NULL,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Finalize: customer_payment_methods
ALTER TABLE <?= $prefix ?>customer_payment_methods ADD FOREIGN KEY(customer_id) REFERENCES <?= $prefix ?>customers(id);
ALTER TABLE <?= $prefix ?>customer_payment_methods ADD FOREIGN KEY(payment_type_id) REFERENCES <?= $prefix ?>payment_types(id);
ALTER TABLE <?= $prefix ?>customer_payment_methods ADD FOREIGN KEY(payment_provider_id) REFERENCES <?= $prefix ?>payment_providers(id);

-- Finalize: customer_tags
ALTER TABLE <?= $prefix ?>customer_tags ADD FOREIGN KEY(customer_id) REFERENCES <?= $prefix ?>customers(id);
ALTER TABLE <?= $prefix ?>customer_tags ADD FOREIGN KEY(tag_id) REFERENCES <?= $prefix ?>tags(id);

-- Finalize: customer_changes
ALTER TABLE <?= $prefix ?>customer_changes ADD FOREIGN KEY(customer_id) REFERENCES <?= $prefix ?>customers(id);
ALTER TABLE <?= $prefix ?>customer_changes ADD FOREIGN KEY(customer_change_type_id) REFERENCES <?= $prefix ?>customer_change_types(id);

-- Finalize: addresses
ALTER TABLE <?= $prefix ?>addresses ADD FOREIGN KEY(customer_id) REFERENCES <?= $prefix ?>customers(id);
ALTER TABLE <?= $prefix ?>addresses ADD FOREIGN KEY(country_id) REFERENCES <?= $prefix ?>countries(id);


-- ========================================================================
-- Table: rate_types
CREATE TABLE <?= $prefix ?>rate_types (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

ALTER TABLE <?= $prefix ?>shipping_details DROP COLUMN carrier_name;
ALTER TABLE <?= $prefix ?>shipping_details ADD rate_type_id BIGINT NOT NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD ezpost_carrier_id VARCHAR(128) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD ezpost_shipping_id VARCHAR(128) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD fixed_rate_id VARCHAR(128) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD planned_handling_fee DECIMAL(13,2) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD planned_handling_percentage NUMERIC(4,2) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD handling_fee NUMERIC(13,2) NULL;
ALTER TABLE <?= $prefix ?>shipping_details ADD shipping_cost NUMERIC(13,2) NULL;

-- Finalize: shipping_details
ALTER TABLE <?= $prefix ?>shipping_details ADD FOREIGN KEY(rate_type_id) REFERENCES <?= $prefix ?>rate_types(id);


-- ========================================================================
ALTER TABLE <?= $prefix ?>orders DROP COLUMN customer_wp_user_id;
ALTER TABLE <?= $prefix ?>orders ADD COLUMN customer_id BIGINT NOT NULL AFTER created;
ALTER TABLE <?= $prefix ?>orders ADD COLUMN shipping_address_id BIGINT NULL AFTER customer_id;
ALTER TABLE <?= $prefix ?>orders ADD COLUMN billing_address_id BIGINT NULL AFTER shipping_address_id;
ALTER TABLE <?= $prefix ?>orders ADD COLUMN subtotal NUMERIC(13,2) NULL AFTER shipping_detail_id;

-- Finalize: orders
ALTER TABLE <?= $prefix ?>orders ADD FOREIGN KEY(customer_id) REFERENCES <?= $prefix ?>customers(id);
ALTER TABLE <?= $prefix ?>orders ADD FOREIGN KEY(shipping_address_id) REFERENCES <?= $prefix ?>addresses(id);
ALTER TABLE <?= $prefix ?>orders ADD FOREIGN KEY(billing_address_id) REFERENCES <?= $prefix ?>addresses(id);


-- ========================================================================
ALTER TABLE <?= $prefix ?>line_items DROP COLUMN product_wp_post_id;
ALTER TABLE <?= $prefix ?>line_items ADD COLUMN product_variant_id BIGINT NOT NULL AFTER order_id;
ALTER TABLE <?= $prefix ?>line_items ADD FOREIGN KEY(product_variant_id) REFERENCES <?= $prefix ?>product_variants(id);

-- ========================================================================
ALTER TABLE <?= $prefix ?>order_changes CHANGE description description VARCHAR(1024) NOT NULL;

-- ========================================================================
-- Table: product_statuses
CREATE TABLE <?= $prefix ?>product_statuses (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Data: product_statuses
INSERT INTO <?= $prefix ?>product_statuses (name, slug) VALUES ('Published', 'published');
INSERT INTO <?= $prefix ?>product_statuses (name, slug) VALUES ('Draft', 'draft');
INSERT INTO <?= $prefix ?>product_statuses (name, slug) VALUES ('Archive', 'archive');
INSERT INTO <?= $prefix ?>product_statuses (name, slug) VALUES ('Schedule', 'schedule');

<?php if(($constraint = $dbi->foreignKeyConstraintName('products', 'status_id', ['prefix' => $prefix]))) { ?>
	ALTER TABLE <?= $prefix?>products DROP FOREIGN KEY <?= $constraint?>;
<?php } ?>
ALTER TABLE <?= $prefix ?>products DROP COLUMN status_id;
ALTER TABLE <?= $prefix ?>products ADD COLUMN product_status_id BIGINT NOT NULL AFTER created;
ALTER TABLE <?= $prefix ?>products ADD FOREIGN KEY(product_status_id) REFERENCES <?= $prefix ?>product_statuses(id);
DROP TABLE <?= $prefix ?>statuses;


-- ========================================================================
-- Table: product
ALTER TABLE <?= $prefix?>products ADD COLUMN created_by_wp_user_id BIGINT UNSIGNED NULL AFTER created;
ALTER TABLE <?= $prefix?>products ADD INDEX(created_by_wp_user_id);

-- ========================================================================
<?php if(($constraint = $dbi->foreignKeyConstraintName('product_options', 'type', ['prefix' => $prefix]))) { ?>
	ALTER TABLE <?= $prefix?>product_options DROP FOREIGN KEY <?= $constraint?>;
<?php } ?>
ALTER TABLE <?= $prefix?>product_options DROP COLUMN type;
ALTER TABLE <?= $prefix?>product_options ADD COLUMN product_option_type_id BIGINT NOT NULL;
ALTER TABLE <?= $prefix ?>product_options ADD FOREIGN KEY(product_option_type_id) REFERENCES <?= $prefix ?>product_option_types(id);



-- ========================================================================
<?php foreach($add_slug_col as $table) { ?>
	ALTER TABLE <?= $prefix ?><?= $table?>  ADD COLUMN slug VARCHAR(128) NOT NULL;
	UPDATE  <?= $prefix ?><?= $table?> SET slug = replace(lower(name), ' ', '-');
	ALTER TABLE <?= $prefix ?><?= $table?>  ADD UNIQUE(slug);
	ALTER TABLE <?= $prefix ?><?= $table?>  ADD INDEX(name);
<?php } ?>

-- ========================================================================
<?php foreach($uniques as $defn) { ?>
	<?php $table = $defn['table'] ?>
	<?php foreach($defn['cols'] as $col) { ?>
		ALTER TABLE <?= $prefix ?><?= $table?>  ADD UNIQUE(<?= $col ?>);
	<?php } ?>
<?php } ?>

-- ========================================================================
<?php foreach($indexes as $defn) { ?>
	<?php $table = $defn['table'] ?>
	<?php foreach($defn['cols'] as $col) { ?>
		ALTER TABLE <?= $prefix ?><?= $table?>  ADD INDEX(<?= $col ?>);
	<?php } ?>
<?php } ?>
