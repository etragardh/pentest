<?php
/**
 * Update DB Schema to version 32.
 *
 * Modifying the webhooks table and adding new tables webhook_triggers and webhook_trigger_types
 *
 * @since 0.1.21
 */


$prefix_table = function ( string $table_name ) use ( $prefix ): string {
    return "{$prefix}{$table_name}";
};

$insert_predefined_values = function ( array $values, string $table_name ) use ( $prefix_table ): void {
	foreach ( $values as $value_name ) {
		$prefixed_table_name = $prefix_table( $table_name );
		$value_slug = sanitize_title( $value_name );

		echo "INSERT INTO {$prefixed_table_name}"
			. " (label, slug) VALUES ('{$value_name}', '{$value_slug}')"
			. " ON DUPLICATE KEY UPDATE slug = '{$value_slug}';"
			. "\n";
	}
};

?>
CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'webhook_triggers' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, webhook_id BIGINT NOT NULL
	, INDEX(webhook_id)
	, FOREIGN KEY(webhook_id) REFERENCES <?php echo $prefix?>webhooks(id)
	, table_name VARCHAR(255)
	, webhook_trigger_type_id BIGINT NOT NULL
	, INDEX(webhook_trigger_type_id)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'webhook_trigger_types' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, label VARCHAR(255)
	, slug VARCHAR(255)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'Created',
		'Updated'
	],
	'webhook_trigger_types'
);
?>