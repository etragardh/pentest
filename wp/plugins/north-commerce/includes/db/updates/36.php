<?php
/*
 * Update DB Schema to version 35.
 *
 * Add in shipping_zone_types and link shipping zones to them.
 */
?>

-- Table: shipping_zone_types
CREATE TABLE <?php echo $prefix ?>shipping_zone_types (
  name VARCHAR(128) NOT NULL,
 INDEX(name),
  slug VARCHAR(128) NOT NULL,
 UNIQUE(slug),
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;


ALTER TABLE <?php echo $prefix ?>shipping_zones  ADD instructions VARCHAR(1024) NULL;


-- Data: shipping_zone_types
INSERT INTO <?php echo $prefix ?>shipping_zone_types (name, slug) VALUES ('Regional', 'regional');
INSERT INTO <?php echo $prefix ?>shipping_zone_types (name, slug) VALUES ('Local', 'local');
INSERT INTO <?php echo $prefix ?>shipping_zone_types (name, slug) VALUES ('Pickup', 'pickup');


ALTER TABLE <?php echo $prefix ?>shipping_zones ADD shipping_zone_type_id BIGINT NOT NULL AFTER shipping_profile_id;

UPDATE <?php echo $prefix ?>shipping_zones SET shipping_zone_type_id =
  (SELECT id FROM <?php echo $prefix ?>shipping_zone_types WHERE slug = 'regional');

ALTER TABLE <?php echo $prefix ?>shipping_zones CHANGE shipping_zone_type_id  shipping_zone_type_id BIGINT NOT NULL;
ALTER TABLE <?php echo $prefix ?>shipping_zones ADD FOREIGN KEY(shipping_zone_type_id) REFERENCES <?php echo $prefix ?>shipping_zone_types(id);