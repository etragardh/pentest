<?php
/*
 * A PHP file for updating from v14 to v15 of our schema. We
 * We add in tables to track transactions
 */
?>

-- Table: order_transaction_statuses
CREATE TABLE <?= $prefix  ?>order_transaction_statuses (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(128) NOT NULL,
  INDEX(name),
  slug VARCHAR(128) NOT NULL,
  UNIQUE(slug),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;

-- Table: order_transactions
CREATE TABLE <?= $prefix  ?>order_transactions (
  id BIGINT NOT NULL AUTO_INCREMENT,
  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  order_id BIGINT NOT NULL,
  order_transaction_status_id BIGINT NOT NULL,
  customer_payment_method_id BIGINT NULL,
  amount DECIMAL(13,2) NOT NULL,
  INDEX(amount),
  identity_token VARCHAR(255) NULL,
  INDEX(identity_token),
  PRIMARY KEY(id),
  INDEX(created)
) Engine=Innodb;


-- Finalize: order_transactions
ALTER TABLE <?= $prefix  ?>order_transactions ADD FOREIGN KEY(order_id) REFERENCES <?= $prefix  ?>orders(id);
ALTER TABLE <?= $prefix  ?>order_transactions ADD FOREIGN KEY(order_transaction_status_id) REFERENCES <?= $prefix  ?>order_transaction_statuses(id);
ALTER TABLE <?= $prefix  ?>order_transactions ADD FOREIGN KEY(customer_payment_method_id) REFERENCES <?= $prefix  ?>customer_payment_methods(id);

-- Data: order_transaction_statuses
INSERT INTO <?= $prefix  ?>order_transaction_statuses (name, slug) VALUES ('Building', 'building');
INSERT INTO <?= $prefix  ?>order_transaction_statuses (name, slug) VALUES ('Processing', 'processing');
INSERT INTO <?= $prefix  ?>order_transaction_statuses (name, slug) VALUES ('Successful', 'successful');
INSERT INTO <?= $prefix  ?>order_transaction_statuses (name, slug) VALUES ('Failed', 'failed');
