<?php
/**
 * Update DB Schema to version 30.
 *
 * Add Coupon tables.
 *
 * @since 0.1.21
 */

$prefix_table = function ( string $table_name ) use ( $prefix ): string {
	return "{$prefix}{$table_name}";
};

$insert_predefined_values = function ( array $values, string $table_name ) use ( $prefix_table ): void {
	foreach ( $values as $value_name ) {
		$prefixed_table_name = $prefix_table( $table_name );
		$value_slug = sanitize_title( $value_name );

		echo "INSERT INTO {$prefixed_table_name}"
			. " (name, slug) VALUES ('{$value_name}', '{$value_slug}')"
			. " ON DUPLICATE KEY UPDATE slug = '{$value_slug}';"
			. "\n";
	}
};

?>
CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_statuses' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL UNIQUE
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'Published',
		'Scheduled',
		'Expired',
		'Disabled'
	],
	'coupon_statuses'
);
?>


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_discount_types' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL UNIQUE
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'Percent',
		'Fixed',
		'Free Shipping'
	],
	'coupon_discount_types'
);
?>

CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_modes' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL UNIQUE
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'Manual',
		'Automatic'
	],
	'coupon_modes'
);
?>

CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_requirements' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL UNIQUE
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'None',
		'Minimum Purchase Amount',
		'Minimum Quantity'
	],
	'coupon_requirements'
);
?>


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupons' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, name VARCHAR(255) NOT NULL
	, INDEX(name)
	, slug VARCHAR(255) NOT NULL
	, INDEX(slug)
	, coupon_status_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_status_id) REFERENCES <?php echo $prefix; ?>coupon_statuses(id)
	, usage_counter INT
	, usage_limit INT NULL
	, coupon_mode_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_mode_id) REFERENCES <?php echo $prefix; ?>coupon_modes(id)
	, coupon_discount_type_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_discount_type_id) REFERENCES <?php echo $prefix; ?>coupon_discount_types(id)
	, discount_amount DECIMAL(13,2) NULL
	, coupon_requirement_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_requirement_id) REFERENCES <?php echo $prefix; ?>coupon_requirements(id)
	, requirement_amount DECIMAL(13,2) NULL
	, any_product BOOLEAN NOT NULL
	, any_country BOOLEAN NOT NULL
	, any_customer BOOLEAN NOT NULL
	, time_start TIMESTAMP NULL
	, time_end TIMESTAMP NULL
	, deleted TIMESTAMP NULL
	, INDEX(deleted)
    , created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) ENGINE = InnoDB;


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_product_variants' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, coupon_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_id) REFERENCES <?php echo $prefix; ?>coupons(id)
	, product_variant_id BIGINT NOT NULL
	, FOREIGN KEY(product_variant_id) REFERENCES <?php echo $prefix; ?>product_variants(id)
    , created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) ENGINE = InnoDB;


CREATE TABLE IF NOT EXISTS <?php echo $prefix; ?>coupon_countries (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, coupon_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_id) REFERENCES <?php echo $prefix; ?>coupons(id)
	, country_id BIGINT NOT NULL
	, FOREIGN KEY(country_id) REFERENCES <?php echo $prefix; ?>countries(id)
    , created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) ENGINE = InnoDB;


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_customer_eligibilities' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY(id)
	, name VARCHAR(128) NOT NULL
	, INDEX(name)
	, slug VARCHAR(128) NOT NULL UNIQUE
	, INDEX(slug)
	, created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) Engine=Innodb;

<?php
$insert_predefined_values(
	[
		'New Customer',
		'Customer Emails',
		'North Commerce Customer IDs',
		'North Commerce Customer Tags',
		'Wordpress Users',
		'Wordpress Roles'
	],
	'coupon_customer_eligibilities'
);
?>


CREATE TABLE IF NOT EXISTS <?php echo $prefix_table( 'coupon_customers' ); ?> (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, coupon_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_id) REFERENCES <?php echo $prefix_table( 'coupons' ); ?>(id)
	, customer_new BOOLEAN NULL
	, customer_id CHAR(28) NULL
	, FOREIGN KEY(customer_id) REFERENCES <?php echo $prefix_table( 'customers' ); ?>(id)
	, customer_email VARCHAR(255) NULL
	, customer_tag_id BIGINT NULL
	, FOREIGN KEY(customer_tag_id) REFERENCES <?php echo $prefix_table( 'tags' ); ?>(id)
	, wp_user_id BIGINT UNSIGNED NULL
	, wp_role VARCHAR(255) NULL
    , created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) ENGINE = InnoDB;


CREATE TABLE IF NOT EXISTS <?php echo $prefix; ?>coupon_orders (
	id BIGINT NOT NULL AUTO_INCREMENT
	, PRIMARY KEY (id)
	, coupon_id BIGINT NOT NULL
	, FOREIGN KEY(coupon_id) REFERENCES <?php echo $prefix; ?>coupons(id)
	, order_id CHAR(28) NOT NULL
	, FOREIGN KEY(order_id) REFERENCES <?php echo $prefix; ?>orders(id)
    , created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	, INDEX(created)
) ENGINE = InnoDB;
