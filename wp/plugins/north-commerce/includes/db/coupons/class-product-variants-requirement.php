<?php
namespace NorthCommerce\Db\Coupons;

defined( 'ABSPATH' ) || exit;

use NorthCommerce\Models\CouponModel;
/**
 * Applied Product Variants requirement.
 *
 * @package north-commerce/includes/db/coupons
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.21
 * @version 0.1.21
 */
class Product_Variants_Requirement extends Requirement {

	public function verify( $coupon, Coupon_Criteria $criteria ) {

		if (
			boolval( $coupon['any_product'] )
			|| empty( $criteria->get_cart_product_variants() )
		) {
			return true;
		}

		$coupon_model = new CouponModel();
		$is_variants_valid = true;
		$cart_product_variants = $criteria->get_cart_product_variants();
		$unvalid_variants = [];

		foreach ( $cart_product_variants as $cart_key => $variant ) {
			$is_valid = $coupon_model->is_applied_product_variant_valid( $coupon['id'], $variant['id'] );

			if ( $is_variants_valid && ! $is_valid ) {
				$is_variants_valid = false;
				$unvalid_variants[] = $cart_product_variants[ $cart_key ];
			}
		}

		return $is_variants_valid ?: $this->error_message( $unvalid_variants );

	}

	public function error_message( array $unvalid_variants ): string {

		$variant_names = '';
		foreach ( $unvalid_variants as $variant ) {
			$variant_names .= $variant_names ? ', ' : '';
			$variant_names .= $variant['product']['name'] . ': ' . $variant['slug'];
		}

		return sprintf(
			__( 'This promo code cannot be used with chosen product(s): %s.', 'north-commerce' ),
			$variant_names
		);

	}

}
