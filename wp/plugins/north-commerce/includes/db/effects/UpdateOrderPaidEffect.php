<?php
/**
 * A PHP file for updating our order's paid value based on
 * the order transactions that have been completed.
 */

namespace NorthCommerce\Db\Effects;

use NorthCommerce\Db\Collections\{
	OrderStatuses,
	OrderTransactionStatuses,
	PaymentStatuses
};

class UpdateOrderPaidEffect extends PostEffect {

	protected static function behavior( $order ) {
		$all_txs = Effect::$ea->list( 'order_transactions', [
			'order_id' => $order['id'],
			'order_transaction_status_id' => OrderTransactionStatuses::successful()->id
		] );

		$amount_paid = array_reduce( $all_txs, function( $carry, $ot ) {
			return $carry + $ot['amount'];
		}, 0 );

		$changes = [
			'paid' => $amount_paid,
			// Needs to be updated to paid_time
			'created' => date('Y-m-d H:i:s')
		];

		if ( $amount_paid >= $order['total'] ) {
			$changes['order_status_id'] = OrderStatuses::unfulfilled()->id;
			$changes['payment_status_id'] = PaymentStatuses::paid()->id;
		}

		$order = Effect::$ea->update( 'orders', $order, $changes );

		if ( $order['payment_status_id'] == PaymentStatuses::paid()->id ) {
			$order = UpdateOrderInventoryEffect::run($order);
		}

		return $order;
	}

}
