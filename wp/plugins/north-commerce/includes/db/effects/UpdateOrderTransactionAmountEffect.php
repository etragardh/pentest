<?php
/**
 * A PHP file for keeping an order transaction's total up to date
 */

namespace NorthCommerce\Db\Effects;

use NorthCommerce\Db\Collections\OrderTransactionStatuses;

class UpdateOrderTransactionAmountEffect extends PostEffect {

	protected static function behavior($ot) {

		if ( $ot['order_transaction_status_id'] != OrderTransactionStatuses::building()->id ) {
			throw new \Exception(
				"Refusing to update order transaction {$ot['id']}, "
				. "it's not in status building ({$ot['order_transaction_status_id']})"
			);
		}

		$o = Effect::$ea->ref( $ot['order_id'] );
		$ot = Effect::$ea->update( 'order_transactions', $ot, [
			'amount' => $o['total']
		] );

		return $ot;

	}
}
