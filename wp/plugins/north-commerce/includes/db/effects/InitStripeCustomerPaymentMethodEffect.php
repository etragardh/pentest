<?php
/*
 * A PHP file for initializing our customer payment method
 * for stripe.
 *
 * This ensures we have a customer record backing this CPM,
 * and that future transactions can be saved against this.
 *
 * See: https://stripe.com/docs/payments/save-during-payment
 */

namespace NorthCommerce\Db\Effects;

use North_Commerce_Stripe;
use NorthCommerce\Services\CustomerPaymentMethodStripeToken;

class InitStripeCustomerPaymentMethodEffect extends PreEffect
{
	private static $stripeClient;

	protected static function behavior($cpm) {
		if(!self::$stripeClient) {
			self::$stripeClient = (new North_Commerce_Stripe())->stripe_client();
		}

		$c = Effect::$ea->ref($cpm['customer_id']);
		$token = CustomerPaymentMethodStripeToken::fromCustomer($c);
		$cpm['token'] = $token->toString();

		return $cpm;
	}
}
