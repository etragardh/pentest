<?php
/*
 * A PHP file for responding to our order transaction
 * having been approved by stripe. Hurray!
 */

namespace NorthCommerce\Db\Effects;

use NorthCommerce\Services\CustomerPaymentMethodStripeToken;

class UpdateOrderTransactionStripeSuccessEffect extends PostEffect {

	public static function behavior($order_transaction) {

		$cpm = Effect::$ea->ref($order_transaction['customer_payment_method_id']);

		$token = CustomerPaymentMethodStripeToken::fromOrderTransaction($order_transaction);

		$cpm = Effect::$ea->update( 'customer_payment_methods', $cpm, [
			'token' => $token->toString(),
			'brand' => $token->brand(),
			'expiration_month' => $token->expirationMonth(),
			'expiration_year' => $token->expirationYear(),
			'last4' => $token->last4()
		] );

		return $order_transaction;

	}
}
