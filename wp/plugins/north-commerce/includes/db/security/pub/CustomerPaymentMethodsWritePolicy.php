<?php
/*
 * A PHP file for defining the write rules associated
 * with customer_payment_methods.
 */

namespace NorthCommerce\Db\Security\Pub;

use NorthCommerce\Db\Collections\PaymentProviders;
use NorthCommerce\Db\Effects\InitStripeCustomerPaymentMethodEffect;
use NorthCommerce\Db\Security\ColumnRules;
use NorthCommerce\Db\Security\WritePolicy;

class CustomerPaymentMethodsWritePolicy extends WritePolicy {

	private $update_cols = [
		'token',
		'last4',
		'brand',
		'expiration_month',
		'expiration_year'
	];

	public function createColumnRules($values) {
		return new ColumnRules(['customer_id', 'payment_provider_id'], $this->update_cols);
	}

	public function updateColumnRules($entity, $changes) {
		return new ColumnRules([], $this->update_cols);
	}

	public function prepareForCreate($values) {
		if($values['payment_provider_id'] == PaymentProviders::stripe()->id) {
			$values = InitStripeCustomerPaymentMethodEffect::run($values);
		}
		return $values;
	}

}
