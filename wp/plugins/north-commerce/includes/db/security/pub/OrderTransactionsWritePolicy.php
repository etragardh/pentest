<?php
/*
 * A PHP file for implementing our write policy for Order Transactions
 */
namespace NorthCommerce\Db\Security\Pub;

use NorthCommerce\Db\Collections\OrderTransactionStatuses;
use NorthCommerce\Db\Effects\InitOrderTransactionEffect;
use NorthCommerce\Db\Security\ColumnRules;
use NorthCommerce\Db\Security\WritePolicy;

class OrderTransactionsWritePolicy extends WritePolicy
{
	private $optional_cols = [
		'identity_token',
		'customer_payment_method_id'
	];

	public function createColumnRules($values) {
		return new ColumnRules(['order_id'], $this->optional_cols);
	}

	public function	updateColumnRules($ot, $changes) {
		if ($ot['order_transaction_status_id'] == OrderTransactionStatuses::building()->id) {
			return new ColumnRules(
				[],
				array_merge( ['order_transaction_status_id'], $this->optional_cols )
			);
		}

		return new ColumnRules([], []);
	}

	public function prepareForCreate($values) {
		return InitOrderTransactionEffect::run($values);
	}
}
