<?php
/*
 * A PHP file for triggering order events with the status of abandoned
 */

namespace NorthCommerce\Db\Events;

use NorthCommerce\Db\Collections\PaymentStatuses;
use NorthCommerce\Db\Collections\OrderStatuses;
use NorthCommerce\Models\OrderModel;

/**
 * Abandoned order event.
 *
 *
 * @package north-commerce/includes/db/events
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.24
 */
class AbandonedOrderEvent extends Event {

	public function name() {
		return 'An order is abandoned';
	}

	public function key() {
		return 'order.abandoned';
	}

	public function description() {
		return "This event is triggered when an order's status is updated to `Abandoned`.";
	}

	public function applies( $table ) {
		return $table == 'orders';
	}

	public function shouldTrigger( $table, $old, $new ) {
		return ( ! $old || $old['order_status_id'] != $new['order_status_id'] )
			&& $new['order_status_id'] == OrderStatuses::abandoned()->id
			&& $new['payment_status_id'] == PaymentStatuses::paid()->id;
	}

	public function process( $data ) {
		$orderModel = new OrderModel;
		$newData = $orderModel->get( $data );

		return $newData;
	}

}
