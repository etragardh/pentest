<?php
/**
 * Database updater
 */
class North_Commerce_Db_Updater {

	private $updateDir = __DIR__ . "/updates";

	public function updateSqlStatements( $prefix, $version ) {

		ob_start();

		require $this->updateFile( $version );

		$sql = ob_get_clean();
		$statements = preg_split( "/; *\r?\n/", $sql );

		$scrub = function( $query ) {
			return trim( preg_replace( "/-- .*?\n/", "", $query ) );
		};

		$statements = array_filter( array_map( $scrub, $statements ) );
		foreach( $statements as $i => $stmt ) {
			$statements[ $i ] .= ";";
		}
		return $statements;

	}

	public function updateFile( $version ) {

		$file = $this->updateDir . "/$version.php";

		if ( file_exists( $file ) ) {
			return $file;
		}

		throw new Exception( "No update file found for $version" );

	}

}
