<?php
/**
 * Generator of database SQL from metadata
 *
 *
 * @package north-commerce/includes/db/generator
 * @link    https://northcommerce.com/
 * @since   0.1.0
 * @since   0.1.23
 */
class North_Commerce_Db_Generator {

	private $id_manager;

	public function __construct() {
		$this->id_manager = North_Commerce_Db_Agent::instance()->idManager();
	}

    public function createTableSql($prefix, $table_name, $cols) {
        $sql = "CREATE TABLE {$prefix}{$table_name} (\n";
        foreach ($cols as $name => $defn) {
            $sql .= $this->colSql($name, $defn);
        }
        $sql .= "  PRIMARY KEY(id),\n";
        $sql .= "  INDEX(created)\n";
        $sql .= ") Engine=Innodb;";
        return $sql;
    }

	public function finalizeTableSql($prefix, $table_name, $cols) {
		$statements = [];
		foreach($cols as $name => $defn) {
			$sql = $this->finalizeColSql($prefix, $table_name, $name, $defn);
			if($sql) {
				$statements[] = $sql;
			}
		}
		return $statements;
	}

	public function insertRowSql($prefix, $table_name, $values) {
		global $wpdb;
		$sql = "INSERT INTO {$prefix}{$table_name} (";
		$sql .= implode(', ', array_keys($values)) . "";
		$sql .= ") VALUES (";
		$sql .= implode(', ', array_fill(0, count($values), '%s'));
		$sql .=");";

		return $wpdb->prepare($sql, array_values($values));
	}

	/**
	 * @version 0.1.23
	 */
    private function colSql( $name, $defn ) {
        $index_sql = '';
        $col_sql = "  $name ";
        switch ( $defn['type'] ) {
            case 'REF':
				$ref_id_style = $this->id_manager->idStyle( $defn['ref_table'] );
				if ( $ref_id_style == NC_DB_ID_PUBID_STYLE ) {
					$col_sql .= 'CHAR(' . NC_DB_PUBID_LENGTH . ')';
				} else {
					$col_sql .= 'BIGINT';
				}
                break;

            case 'MONEY':
                $col_sql .= 'DECIMAL(13,2)';
                break;

            case 'WEIGHT': // min value is 0.001 kg
                $col_sql .= 'DECIMAL(12,3)';
                break;

			case 'PUBID':
				$col_sql .= "CHAR(" . NC_DB_PUBID_LENGTH . ")";
				break;

            default:
                $col_sql .= $defn['type'];
        }

        if ( nc_g( $defn, 'null' ) ) {
            $col_sql .= ' NULL';
        } else {
            $col_sql .= ' NOT NULL';
		}

		if ( $extra = nc_g( $defn, 'extra' ) ) {
			$col_sql .= " $extra";
		}

        $col_sql .= ",\n";

		if ( nc_g( $defn, 'index' ) ) {
            $index_sql = " INDEX($name),\n";
        }

        if ( nc_g( $defn, 'unique' ) ) {
            $index_sql = " UNIQUE($name),\n";
        }

        return $col_sql . $index_sql;
    }

	private function finalizeColSql($prefix, $table_name, $col_name, $defn) {
		if ( 'REF' == $defn['type'] ) {
			return "ALTER TABLE {$prefix}{$table_name}"
				. " ADD FOREIGN KEY($col_name)"
				. " REFERENCES {$prefix}{$defn['ref_table']}(id);"
				. "\n";
		}

		return '';
	}
}
