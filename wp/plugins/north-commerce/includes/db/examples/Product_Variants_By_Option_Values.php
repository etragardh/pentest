<?php
/*
 * A PHP file for demonstrating how we can get product variants by
 * product option values
 */
$inputs = [
	'product_id',
	'options'
];

$example = function(North_Commerce_Db_Entity_Access $ea, $product_id, $options) {
	if($product_id == 'latest') {
		$product = $ea->get('products', true, ['created DESC']);
		$product_id = $product['id'];
	}

	$option_values = array_map(function($option) use($ea, $product_id) {
		[$name, $value] = explode(':', $option);
		if(!$name || !$value) {
			die("[$option] is not formatted properly. Expected: name:value\n");
		}

		$option_value = $ea->get('product_option_values', [
			'value' => $value,
			'product_option.name' => $name,
			'product_option.product_id' => $product_id
		]);
		if(!$option_value) {
			die("No product value found for: $name=$value");
		}

		return ['=', "{$option_value['id']}:product_variant_option_values.product_option_value_id", $option_value['id']];
	}, explode(',', $options));

	return $ea->list('product_variants', [
		'and',
		['=', 'product_id', $product_id],
		['and', $option_values]
	], [
		'expand' => 'product_variant_option_values.product_option_value'
	]);


};
