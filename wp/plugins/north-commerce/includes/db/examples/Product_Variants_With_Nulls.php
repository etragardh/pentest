<?php
/*
 * A PHP file for showing product variants with nulls
 */

$example = function(North_Commerce_Db_Entity_Access $ea) {

	$pvs = $ea->list('product_variants', [
		'or',
		['is', 'price', null],
		['is', 'quantity', null]
	], [
		'expand' => 'product,product_variant_option_values.product_option_value.product_option',
		'limit' => 10,
		'order_by' => 'id desc'
	]);

	$item_page = get_page_by_path('products');
	return array_map(function($pv) use($item_page) {
		$p = $pv['product'];
		$url = get_page_link($item_page) . "/" . $p['slug'];
		$options = array_reduce($pv['product_variant_option_values'],
								function($carry, $pvov) {
									$value = $pvov['product_option_value']['value'];
									$name = $pvov['product_option_value']['product_option']['name'];
									$carry[$name] = $value;
									return $carry;
								}, []);
		return [
			'id' => $pv['id'],
			'url' => $url,
			'price' => $pv['price'],
			'quantity' => $pv['quantity'],
			'product_base_price' => $p['base_price'],
			'product_quantity' => $p['quantity'],
			'options' => $options
		];
	}, $pvs);

};
