<?php
/*
 * A PHP file for respecting `visible_if` meta in our Schema.
 */
namespace NorthCommerce\Db\Automations;

use NorthCommerce\Db\Security\AdministratorPerspective;

class VisibleIfAutomation extends BaseAutomation
{

	public function onEntityAccessCriteria($criteria, $table) {
		$vi  = $this->visibleIfClause($table);

		if ( ! $vi ) {
			return $criteria;
		}

		$pm = $this->agent->perspectiveManager();

		if ($pm->currentPerspective() instanceof AdministratorPerspective) {
			return $criteria;
		}

		return ['and', $vi, $criteria];
	}

	public function visibleIfClause($table) {
		$schema = $this->agent->schema();
		$table = $schema->tableDefn($table);
		$meta  = nc_g($table, 'meta', []);
		return nc_g($meta, 'visible_if');
	}

}
