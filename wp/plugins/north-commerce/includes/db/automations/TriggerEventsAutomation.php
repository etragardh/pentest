<?php
namespace NorthCommerce\Db\Automations;

use NorthCommerce\Db\Events\EventManager;

/**
 * Trigger events automation.
 *
 *
 * @package north-commerce/includes/db/automations
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.23
 * @version 0.1.24
 */
class TriggerEventsAutomation extends BaseAutomation {

	public function onEntityAccessCreated( $created, $table, $inputs ) {
		$this->triggerEvent( $table, null, $created );
		return $created;
	}

	public function onEntityAccessUpdated( $updated, $table, $existing, $changes ) {
		$this->triggerEvent( $table, $existing, $updated );
		return $updated;
	}

	private function triggerEvent( $table, $old, $new ) {
		$events = EventManager::allEvents();
		foreach ( $events as $event ) {
			if ( $event->applies( $table ) && $event->shouldTrigger( $table, $old, $new ) ) {
				$this->processEvent( $event, $table, $old, $new );
			}
		}
	}

	public function processEvent( $event, $table, $old, $new ) {
		$processed = $event->process( $new );

		do_action( "nc_db_event/{$event->key()}", $event, $table, $old, $new, $processed );
		do_action( 'nc_db_event', $event, $table, $old, $new, $processed );
	}

}
