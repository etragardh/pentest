<?php
/*
 * Automatically set order_nubmer and customer_number  on
 * new order and customer records.
 */

namespace NorthCommerce\Db\Automations;

class SequenceNumberAutomation extends BaseAutomation {

	public function onEntityAccessCreateValues($values, $table) {
		$seq_cols = [
			'orders' => 'order_number',
			'customers' => 'customer_number'
		];

		if ( ! isset( $seq_cols[ $table ] ) ) {
			return $values;
		}

		$col = $seq_cols[$table];

		if ( is_numeric( nc_g( $values, $col ) ) ) {
			return $values;
		}

		$mgr = $this->agent->sequenceNumberManager();

		$method = 'next' . str_replace(' ', '', ucwords(str_replace('_', ' ', $col)));
		$value = $this->agent->perspectiveManager()->asAdministrator(function() use($mgr, $method) {
			return $mgr->$method();
		});

		return $values + [$col => $value];
	}

}
