<?php
/*
 * A PHP file for letting a public user look up a stripe
 * order_transaction by identity_token.
 *
 * In general, a public user can only look up objects by `id`.
 * If we're dealing with a stripe `identity_token` this can
 * treated as an alternate ID.
 */

namespace NorthCommerce\Db\Automations;

use NorthCommerce\Db\Collections\PaymentProviders;
use NorthCommerce\Db\Security\PublicPerspective;

class IdentityTokenLookupAutomation extends BaseAutomation {

	public function onEntityAccessCriteria($criteria, $table) {
		if ( ! $this->perspectiveManager->currentPerspective() instanceof PublicPerspective ) {
			return $criteria;
		}

		return $this->perspectiveManager->asAdministrator(
			function () use ( $criteria, $table ) {
				if (
					$table == 'order_transactions'
					&& count( $criteria ) == 1
					&& isset( $criteria['identity_token'] )
					&& $criteria['identity_token']
				) {
					$found = $this->ea->list( 'order_transactions', $criteria );
					if ( count( $found ) != 1 ) {
						return $criteria;
					}

					$cpm = $this->ea->ref( $found[0]['customer_payment_method_id'] );
					if ( in_array( $cpm['payment_provider_id'], $this->validProviderIds() ) ) {
						return [
							'id' => $found[0]['id']
						];
					}
				}

				return $criteria;
			}
		);
	}

	private function validProviderIds() {
		return [
			PaymentProviders::stripe()->id,
			PaymentProviders::paypal()->id
		];
	}

}
