<?php
/**
 * A PHP file for working with site specific permalinks
 *
 * @since   0.1.3
 * @version 0.1.5
 */
class North_Commerce_Permalinks {

	public function on_init() {
		$this->install();

		add_action('save_post',	[$this, 'refresh_on_post_save']);
		add_action('updated_option', [$this, 'refresh_on_option_save']);
		add_action('added_option', [$this, 'refresh_on_option_save']);
	}

	/**
	 * Install our permalink rules for the Product page.
	 * If you set $flush_rewrites to true, a call to WP's flush rewrites will happen.
	 * This can be slow, so only call this when needed.
	 *
	 * @since   0.1.3
	 * @version 0.1.5
	 */
	public function install( $flush_rewrites = false ) {

		$rewrites = new North_Commerce_Rewrites();
		$product_page_id = North_Commerce_Settings::nc_get_page_id( 'product' );
		$collections_page_id = North_Commerce_Settings::nc_get_page_id( 'collections' );


		if ( is_numeric( $product_page_id ) && $product_page_id > 0 ) {
			$rewrites->registerPageWithParams( $product_page_id, [ 'product_slug' ] );
			$rewrites->registerPageWithParams( $product_page_id, [ 'product_slug', 'variant_slug' ] );
		}

		if ( is_numeric( $collections_page_id ) && $collections_page_id > 0 ) {
			$rewrites->registerPageWithParams( $collections_page_id, [ 'collection_slug' ] );
		}

		if ( $flush_rewrites ) {
			flush_rewrite_rules( false );
		}

	}

	/*
	 * Give us an option to refresh our permalinks when a page is changed
	 */
	function refresh_on_post_save($saved_post_id) {
		$product_page_id = North_Commerce_Settings::nc_get_page_id( 'product' );
		$collections_page_id = North_Commerce_Settings::nc_get_page_id( 'collections' );
		if($saved_post_id == $product_page_id || $saved_post_id == $collections_page_id) {
			$this->install(true);
		}
	}

	/*
	 * Let us update our rewrite rules when the option corresponding to our rewrites change
	 */
	function refresh_on_option_save($option) {
		if(preg_match('/^north_commerce_.*_page_id$/', $option)) {
			$this->install(true);
		}
	}
}
