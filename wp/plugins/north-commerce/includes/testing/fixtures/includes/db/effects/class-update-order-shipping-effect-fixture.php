<?php
/*
 * A PHP file for helping to test out the UpdateOrderShippingEffect
 */

namespace NorthCommerce\Testing\Fixtures\Includes\Db\Effects;

use NorthCommerce\Db\Collections\RateTypes;
use NorthCommerce\Db\Collections\ShippingDetailTypes;
use NorthCommerce\Testing\Fixture;

class Update_Order_Shipping_Effect_Fixture extends Fixture
{
	public $order_with_planned;
	public $order_with_actual;
	public $order_with_planned_and_actual;

	public $planned_shipping;
	public $actual_shipping;
	public $planned_and_actual_shipping;

	function setUp()
	{
		parent::setUp();

		$this->order_with_planned = $this->ef->newOrder([]);
		$this->order_with_actual = $this->ef->newOrder([]);
		$this->order_with_planned_and_actual = $this->ef->newOrder([]);

		$this->planned_shipping = $this->makeShippingDetail($this->order_with_planned, ShippingDetailTypes::planned(), 10, 4, 5);

		$this->actual_shipping =
			$this->makeShippingDetail($this->order_with_actual, ShippingDetailTypes::actual(), 10, 3, 5) +
			$this->makeShippingDetail($this->order_with_actual, ShippingDetailTypes::actual(), 2, 0, 9);


		$this->planned_and_actual_shipping =
			$this->makeShippingDetail($this->order_with_planned_and_actual, ShippingDetailTypes::actual(), 17, 3, 0);


		$this->makeShippingDetail($this->order_with_planned_and_actual, ShippingDetailTypes::planned(), 20, 3, 7);
		$this->makeShippingDetail($this->order_with_planned_and_actual, ShippingDetailTypes::planned(), 2, 3, 3);
		$this->makeShippingDetail($this->order_with_planned_and_actual, ShippingDetailTypes::planned(), 1, 3, 10);
	}

	private function makeShippingDetail($order, $detail_type, $shipping_cost, $handling_fee, $handling_percent)
	{
		$this->ea->create('shipping_details', [
			'order_id' => $order['id'],
			'shipping_detail_type_id' => $detail_type->id,
			'shipping_cost' => $shipping_cost,
			'handling_fee' => $handling_fee,
			'handling_percentage' => $handling_percent,
			'rate_type_id' => RateTypes::flatRate()->id
		]);

		return $shipping_cost + $handling_fee + round($shipping_cost * ($handling_percent / 100), 2);
	}


}
