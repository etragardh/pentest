<?php

namespace NorthCommerce\Resources\Order;

use NorthCommerce\Db\Collections\ProductTypes;
use NorthCommerce\Models\OrderModel;
use North_Commerce_Settings as Settings;

/**
 * used for getting order data to display in admin single order view
 */
class OrderSingleAdminResource {

	private array $order;

	public function __construct( $order ) {
		$this->order = $order;
	}

	public function get_line_items() {
		$line_items = [];

		foreach ( $this->order['line_items'] as $line_item ) {
			$line_items[] = $this->get_line_item( $line_item );
		}

		return $line_items;
	}

	public function get_line_item( $line_item ) {
		return [
			'name'            => $this->get_line_item_name( $line_item ),
			'quantity'        => $line_item['quantity'],
			'price'           => $this->get_line_item_price( $line_item ),
			'price_formatted' => Settings::formatted_price( $this->get_line_item_price( $line_item ), false ),
			'image'           => $this->get_line_item_image( $line_item ),
			'variants'        => $this->get_line_item_variants( $line_item ),
		];
	}

	public function get_line_item_name( $line_item ) {
		return sprintf( '%s - %s %s',
			$line_item['product_variant']['product']['name'],
			$line_item['product_variant']['product']['product_type']['name'],
			__( 'Product', 'north-commerce' ),
		);
	}

	public function get_line_item_price( $line_item ) {
		return $line_item['product_variant']['price']
			?: $line_item['product_variant']['product']['base_price'];
	}

	public function get_line_item_image( $line_item ) {
		if ( ! empty( $line_item['product_variant']['image_url'] ) ) {
			return $line_item['product_variant']['image_url'];
		}

		foreach ( OrderModel::getOrderLineItemValuesForHuman( $line_item ) as $option_name => $option_value ) {
			if ( preg_match( '/\.(?:jpg|jpeg|png|webp|gif|svg])$/m', $option_value ) ) {
				return $option_value;
			}
		}

		if(!empty($line_item['product_variant']['product']['product_images'])) {
			return $line_item['product_variant']['product']['product_images'][0]['image_url'];
		}

		if ( ProductTypes::subscription()->slug == $line_item['product']['product_type']['slug'] ?? null ) {
			return self::get_default_image_url();
		}

		return self::get_default_image_url();
	}

	public function get_line_item_variants( $line_item ) {
		$variants = [];

		foreach ( OrderModel::getOrderLineItemValuesForHuman( $line_item ) as $option_name => $option_value ) {
			if ( preg_match( '/\.(?:jpg|jpeg|png|webp|gif|svg])$/m', $option_value ) ) {
				$option_value = sprintf( '<img src="%s" />', $option_value );
			}

			$variants[] = [
				'name'  => $option_name,
				'value' => $option_value,
			];
		}

		return $variants;
	}

	public static function get_default_image_url() {
		return esc_url( NORTH_COMMERCE_PLUGIN_DIR_URL . '/admin/images/product-empty-img.png' );
	}

	public function to_array() {
		return [
			//...
			'line_items' => $this->get_line_items(),
		];
	}

	public function to_json() {}

}
