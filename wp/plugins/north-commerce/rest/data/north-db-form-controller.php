<?php

/**
 * North form db controller class.
 *
 *
 * @package north-commerce/rest
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com/
 * @since   0.1.0
 */
class North_Form_DB_Controller {

    public static function create_table() {
        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';
        $charset_collate = $wpdb->get_charset_collate();

        if ( $wpdb->get_var("SHOW TABLES LIKE '{$table_name}'") != $table_name ) {

            $sql = "CREATE TABLE $table_name (
                    ID mediumint(9) NOT NULL AUTO_INCREMENT,
                    `name` text,
                    `form_data` longtext NOT NULL,
                    PRIMARY KEY  (ID)
            ) $charset_collate;";

            require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
            dbDelta($sql);
        }
    }

    public static function get_form($id = null) {
        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';
        $sql = $wpdb->prepare( "SELECT * FROM $table_name WHERE ID = %s", $id);
        $result = $wpdb->get_row($sql, ARRAY_A);
        return $result;
    }

    public static function get_forms() {
        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';
        $sql = $wpdb->prepare( "SELECT * FROM $table_name ORDER BY id DESC");
        $result = $wpdb->get_results($sql, ARRAY_A);
        return $result;
    }

    public static function get_forms_by_params($name_like = '', $by_order = 'ASC') {
        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';
        $order = ($by_order == 'ASC' || $by_order == 'A-Z') ? 'ASC' : 'DESC';
        $order_by = ($by_order == 'ASC' || $by_order == 'DESC') ? 'id' : 'name';
        $like = '%' . $wpdb->esc_like( $name_like ) . '%';

        $sql = $wpdb->prepare( "SELECT * FROM $table_name WHERE name LIKE %s ORDER BY ", $like);
        $sql .= $order_by . ' ' .  $order;
        $result = $wpdb->get_results($sql, ARRAY_A);
        return $result;
    }

    public static function update_form($id = null, $name = null,  $form = null) {
        if($id == null)
            return false;

        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';

        $result = $wpdb->update($table_name,
            [
                'form_data' => $form ,
                'name' => !empty($name) ? $name : "Checkout form"
            ],
            ['ID' => $id],
            ['%s', '%s' ],
	        ['%d' ]
        );

        return $result;
    }

    public static function insert_form($name = null, $form = null) {
        if($form == null)
            return false;

        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';
        $args = array();

        $args['form_data'] = $form ;
        $args['name'] = !empty( $name ) ? $name : "Checkout form";

        $result = $wpdb->insert(
            $table_name,
            $args
        );

        return  $result !== false ?  $wpdb->insert_id : $result;
    }

    /**
     * @version 0.1.10
     */
    public static function delete_form( $id = null ) {
        if ( $id == null ) {
            return false;
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'north_forms';

        $result = $wpdb->delete(
            $table_name,
            ['ID' => $id]
        );

        return $result;
    }

}
