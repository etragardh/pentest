// Create a Stripe client.

var paymentRequest;

if (stripe_data.public !== '') {

	if (document.querySelector('main.profile-settings .horizontal-nav__item.billing.active')) {

		// Client Account Area
		try {
			var stripe = Stripe(stripe_data.public)
			const elements = stripe.elements()

			var element = document.querySelector("#card-element")
			if (element) {
				var card = elements.create('card')
				card.mount('#card-element')
			}
		} catch(e) {
		}

	} else {

		// Single page checkout form
		try {
			var stripe = Stripe(stripe_data.public);
			const elements = stripe.elements();

			var element = document.querySelector("#card-element");
			var form, buttons_element

			if (element) {
				var card = elements.create('card');
				form = element.closest('form[data-type="form"]');
				buttons_element = form.querySelector("#payment-request-button");
				card.mount('#card-element');
			}

			if (buttons_element) {
				const total = NorthCommerce.singlePageCheckoutManager.getCartTotal(form)
				const product_name = form.querySelector('.ProductRadio:checked').getAttribute('data-product-name')

				paymentRequest = stripe.paymentRequest({
					country: 'US',
					currency: form.getAttribute('data-currency').toLowerCase(),
					total: {
						label: product_name,
						amount: parseFloat(total) * 100,
					},
					requestShipping: true,
					requestPayerName: true,
					requestPayerEmail: true,
					requestPayerPhone: true,
					shippingOptions: [
						{
							id: 'no_shipping',
							label: 'No shipping',
							detail: 'No shipping',
							amount: 0,
						}
					]
				});

				var prButton = elements.create('paymentRequestButton', {
					paymentRequest: paymentRequest,
				});

				// Check the availability of the Payment Request API first.
				paymentRequest.canMakePayment().then(function(result) {
					if (result) {
						prButton.mount('#payment-request-button');
					} else {
						document.getElementById('payment-request-button').style.display = 'none';
					}
				});

				// for apple/google pay
				paymentRequest.on('paymentmethod', async function(ev) {
					clearPaymentError()

					const form = document.querySelector('[data-type="form"]')
					const args = new FormData()

					args.append('action', 'payment_buttons');
					args.append('data', JSON.stringify( NorthCommerce.singlePageCheckoutManager.getCheckoutData(form) ))
					args.append('payment_id',  ev.paymentMethod.id);
					args.append('customer_email', ev.payerEmail);
					args.append('customer_phone', ev.payerPhone);
					args.append('customer_name', ev.payerName);
					args.append('customer_shipping', ev.shippingAddress);
					args.append('card_last_four', ev.paymentMethod.card.last4);
					args.append('card_brand', ev.paymentMethod.card.brand);

					try {
						const response = await fetch(ajax_object.ajaxurl, {
							method: 'post',
							body: args,
							credentials: 'same-origin'
						});
						const result = await response.json();
						if (result['error'] !== undefined) {
							showPaymentError(result['error']);
							return;
						}


						var url;
						if (form.getAttribute('data-redirect') !== null) {
							url = form.getAttribute('data-redirect');
						} else {
							url =  window.location.href;
						}
						ev.complete('success');
						window.location.href = url;

					} catch(error) {
						showPaymentError('Payment Error:' + error);
					}
				});
			}
		} catch(e) {
		}

	}

}
