/*
 * A JS file for implementing a Shortcode javascript - that is an object
 * that helps the general functionality for shortcodes
 */
(function() {
    if(!window.NorthCommerce) {
        window.NorthCommerce = {};
    }
     

    window.NorthCommerce.ShortcodeManager = {
        
        selectCategoryTab: function() {
            var tabLinks = document.querySelectorAll('.nc-gallery-tabs .tab-links a');

            tabLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
            e.preventDefault();

            // Get the href attribute
            var currentAttrValue = this.getAttribute('href'); 

            // Hide all tabs
            var tabs = document.querySelectorAll('.nc-gallery-tabs .tab');
            tabs.forEach(function(tab) {
                tab.style.display = 'none';
            });

        
            document.querySelector('.nc-gallery-tabs ' + currentAttrValue).style.display = 'block';
        

            // Remove the 'active' class from all tab links
            var tabLinks = document.querySelectorAll('.nc-gallery-tabs .tab-links li');
            tabLinks.forEach(function(tabLink) {
                tabLink.classList.remove('active');
            });

            // Add the 'active' class to the clicked tab link
            this.parentNode.classList.add('active');
            });
          });
       },


       customerRegistrationForm: function() {
                /**
                 * Event listeners for signup form
                 *
                 * 
                 */
                window.NorthCommerce.signupForm = {

                    selector: {
                        spc: '[data-nc-selector="nc-signup-form"]',
                    },

                    constructor() {
                        // this.ensureCheckedProduct()
                        // this.maybeApplyCoupon()

                        this.setListeners()
                    },


                    setListeners() {
                        // console.log('HELLO WORLD');
                        // this.setProductChangeListener()
                        // this.setEmailInputListeners()
                    },

                }


                NorthCommerce.signupForm.constructor()

                function validate_signup_form(){

                    var errors = 0;

                    const fields = document.getElementsByClassName('nc-registration-form-container');

                    for (var i = 0; i < fields.length; i++) {

                        const field_item = fields.item(i);
                        const field_name = field_item.getAttribute('data-type');

                        const field_input = field_item.querySelector('.nc-registration-form-input');
                        const field_error = field_item.querySelector('.textFieldError');

                        // console.log(field_name);


                        //remove all existing warnings
                        const errorText = field_error.querySelector('span.error-text')
                        if (errorText) { 
                            errorText.textContent = '' 
                        }
                        

                        //do special testing of password
                        if(field_name == 'password'){
                            if(field_input.value.length < 6){
                                errors++;
                                field_error.style.display = 'flex';
                                field_error.classList.add = 'input-error';
                                const errorText = 'Please ensure the password is at least 6 characters long';
                                field_error.querySelector('span[data-type="error-icon"').insertAdjacentHTML('afterend', '<span class="error-text">' + errorText + '</span>');
                            } else {
                                field_error.style.display = 'none';
                                field_error.classList.remove = 'input-error';	
                            }
                        } else {
                            if(field_input.value.length < 1){
                                errors++;
                                field_error.style.display = 'flex';
                                field_error.classList.add = 'input-error';

                                const errorText = 'Required';
                                field_error.querySelector('span[data-type="error-icon"').insertAdjacentHTML('afterend', '<span class="error-text">' + errorText + '</span>');

                            } else {
                                field_error.style.display = 'none';
                                field_error.classList.remove = 'input-error';	
                            }
                        }



                    }

                    return errors;

                }

                /**
                 * Submit Sign up Form
                 *
                 * 
                 */
                const submitSignUp = document.querySelectorAll('.nc-registration-form-button')
                submitSignUp.forEach((item) => {
                    item.addEventListener('click', async function(e) {
                        e.preventDefault()

                        const errors = validate_signup_form();
                        if(errors == 0){

                            const btn = e.target
                            const spc = btn.closest('[data-type="form"]')

                            const firstName = spc.querySelector('[data-type="firstName-signup-input"] input').value;

                            const lastName = spc.querySelector('[data-type="lastName-signup-input"] input').value;

                            const email = spc.querySelector('[data-type="email-signup-input"] input').value;

                            const password = spc.querySelector('[data-type="password-signup-input"] input').value;

                            const formNonce = spc.querySelector('#form_nonce').value;

                            const redirect = spc.getAttribute('data-redirect');

                            const responseErrorText = spc.querySelector('.nc-registration-form-error-container p')
                            const headers = {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'nc-initiator': 'spc',
                                'X-WP-Nonce': ajax_data.rest_nonce,
                                'nc-form-nonce': formNonce,
                            }

                            fetch(`${ajax_data.rest_url}/create-user`, {
                                method: 'POST',
                                headers,
                                body: JSON.stringify({
                                    firstName: firstName,	
                                    lastName: lastName,	
                                    email: email,	
                                    password: password,	
                                })
                            })
                            .then((response) => response.json())
                            .then((response) => {
                                if (!response.success) {
                                    console.log(response);
                                    responseErrorText.innerText = response.error;
                                } else {
                                    //so some success
                                    if(redirect.length > 0){
                                        window.location.href = redirect;
                                    } else {
                                        //show some message?
                                        console.log('Show some message?');
                                    }
                                    
                                }

                            })
                        }

                    })
                })

       }


    }

    
})();
