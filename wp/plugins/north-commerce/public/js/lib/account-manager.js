/**
 * Customer account area helper
 */
;(function() {

    window.NorthCommerce = window.NorthCommerce ?? {}

    window.NorthCommerce.CustomerAccount = {

        listOrders: function(orders) {
            this.getOrderId(orders);
        },

        getOrderId: function(orders) {
            const params = new URLSearchParams(window.location.search);
            const tabValue = params.get('tab');
            if (tabValue && tabValue.startsWith('order-')) {
                let orderNumber = tabValue.split('order-')[1];
                this.getOrderByNumber(orders, orderNumber);

            }
            return null;
        },

        getOrderByNumber: function(orders, orderNumber) {
            const matchingOrder = orders.find(order => order.order_number === orderNumber);
            if (matchingOrder) {
                this.renderSummaryDetails(matchingOrder);
                this.renderProducts(matchingOrder);
            }
        },

        renderSummaryDetails: function(orderDetails) {
            const date = new Date(orderDetails.created);
            const formattedDate = date.toLocaleDateString("en-US", {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const currencySymbol = northCommerceSettings.currencySymbol;
            const taxPercentage = northCommerceSettings.taxPercentage;
            const isVatEnabled = northCommerceSettings.vatEnabled

            // Build the HTML for the order summary
            const summaryHtml = `
                <div id="tabs-order-container" class="nc-account-order-summary">
                    <h2 class="nc-account-order-summary-title nc-font-h2">Order Summary</h2>
                    <div class="nc-account-order-summary-block">
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Order Status:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${orderDetails.order_status.name}</p>
                        </div>
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Order Number:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${orderDetails.order_number}</p>
                        </div>
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Order Placed:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${formattedDate}</p>
                        </div>
                    </div>
                    <div class="nc-account-order-summary-block">
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Total Products:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${orderDetails.line_items.length}</p>
                        </div>
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Subtotal:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${currencySymbol}${orderDetails.subtotal}</p>
                        </div>
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">Shipping & Handling:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${currencySymbol}${orderDetails.shipping}</p>
                        </div>
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-title">${isVatEnabled === 'enabled' ? 'VAT' : 'Tax:'}</p>
                            <div class="nc-tax-meta-container">
                                <p class="nc-account-order-summary-row-value nc-color-order-shipped">${currencySymbol}${orderDetails.tax}</p>
                                <p class="nc-account-order-summary-row-value nc-color-order-shipped">${taxPercentage}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="nc-account-order-summary-block">
                        <div class="nc-account-order-summary-row">
                            <p class="nc-account-order-summary-row-total">Total:</p>
                            <p class="nc-account-order-summary-row-value nc-color-order-shipped">${currencySymbol}${orderDetails.total}</p>
                        </div>
                    </div>
                </div>
            `;

            // Insert the summary HTML into the .nc-single-order-tab-summary div
            const container = document.querySelector('.nc-single-order-tab-summary');
            if (container) {
                container.innerHTML = summaryHtml;
            }

        },

        renderProducts: function(orderDetails) {
            const date = new Date(orderDetails.created);
            const formattedDate = date.toLocaleDateString("en-US", {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const currencySymbol = northCommerceSettings.currencySymbol
            const lineItems = this.renderLineItems(orderDetails.line_items)

            const line_items = `
            <div class="nc-account-order">
                <div class="nc-account-order-header nc-account-order-header-if-single">
                    <div class="nc-font-h2">Ordered Items (${orderDetails.line_items.length})</div>
                    <div style="color: var(--color-text-gray)">Order #: <strong style="color: var(--color-text)">${orderDetails.order_number}</strong></div>
                </div>
                <div class="nc-account-order-header nc-account-order-header-if-in-list">
                    <div class="nc-account-order-header-info">
                        <div class="nc-account-order-header-info-date">
                            <span>Order Date</span>
                            <div>${formattedDate}</div>
                        </div>
                        <div class="nc-account-order-header-info-status" data-status="placed">
                            <span>Status</span>
                            <div class="nc-color-order-placed">${orderDetails.order_status.name} & ${orderDetails.payment_status.name}</div>
                        </div>
                        <div class="nc-account-order-header-info-total">
                            <span>Total</span>
                            <div>${currencySymbol}${orderDetails.total}</div>
                        </div>
                        <div class="nc-account-order-header-info-number">
                            <span>Order #</span>
                            <div class="nc-color-order-placed" data-my-account-open-view="order-${orderDetails.order_number}">${orderDetails.order_number}</div>
                        </div>
                    </div>
                    <div class="nc-account-order-header-actions">
                        <!-- <button class="nc-account-button nc-account-button--filled">Order Again</button> -->
                        <button class="nc-account-button" data-my-account-open-view="order-${orderDetails.order_number}">View Order</button>
                    </div>
                </div>
                <div class="nc-account-order-items">
                   ${lineItems}
                </div>
            </div>
            `

             // Insert the summary HTML into the .nc-single-order-tab-summary div
             const container = document.querySelector('.nc-single-order-tab-content');
             if (container) {
                 container.innerHTML = line_items;
             }
        },


        renderLineItems: function(lineItems) {
            return lineItems.map((item) =>  {
                const productName = item.product_variant.product.name
                const productQuantity = item.quantity
                const productAmount = item.amount
                const currencySymbol = northCommerceSettings.currencySymbol
                let imageToDisplay = item.product_variant.product.product_images[0].image_url
                let optionsHtml = ''

                if (item.product_variant && item.product_variant.product_variant_option_values?.length) {
                    item.product_variant.product_variant_option_values.forEach(option_value => {
                        if(/\.(?:jpg|jpeg|png|webp|gif|svg])$/m.test(option_value.product_option_value.display_value)) {
                            imageToDisplay = option_value.product_option_value.display_value;
                            return;
                        }

                        if((new RegExp('^#.{3,6}$')).test(option_value.product_option_value.display_value)) {
                            option_value.product_option_value.display_value = `<span class="nc-cart-option-color" style="background-color: ${option_value.product_option_value.display_value}"></span>`
                        }

                        optionsHtml += `<div>
                            ${option_value.product_option_value.product_option.name}
                            : <strong>
                                ${option_value.product_option_value.display_value}
                            </strong>
                            </div>`
                    })
                }

                return `
                    <div class="nc-account-order-item">
                        <div class="nc-account-order-item-image">
                            <img src="${imageToDisplay}" alt="${productName}">
                        </div>
                        <div class="nc-account-order-item-content">
                            <div class="nc-account-order-item-title nc-font-h2">${productName}</div>
                            <div class="nc-account-order-item-specs">
                                ${optionsHtml}
                                <div>Quantity: <strong>${productQuantity}</strong></div>
                                <!-- Add more specs if needed -->
                            </div>
                        </div>
                        <div class="nc-account-order-item-additional">
                            <div class="nc-account-order-item-price nc-font-h2">${currencySymbol}${productAmount}</div>
                            <!-- Additional content -->
                        </div>
                    </div>
                `;
            }).join(''); // Join all the HTML strings into one
        }
    }
})()
