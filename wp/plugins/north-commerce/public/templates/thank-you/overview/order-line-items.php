<?php
$agent = North_Commerce_Db_Agent::instance();
$ae = $agent->entityAccess();

foreach ( $line_items as $item ) {
    $product_variant_id = $item['product_variant_id'];
    $product_variant = $ae->get('product_variants', ['id' => $product_variant_id]);
    $product_id = $product_variant['product_id'];
    $image = $ae->get( 'product_images', [ 'product_id' => $product_id ] );
	$option_values_human_map = \NorthCommerce\Models\OrderModel ::getOrderLineItemValuesForHuman($item);

    $main_image = $image['image_url'] ?? NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';

    foreach ($option_values_human_map as $option_name => $option_value) {
	    if( preg_match( '/\.(?:jpg|jpeg|png|webp|gif|svg])$/m', $option_value )) {
	    $main_image = $option_value;
        }
    }
    ?>

    <tbody data-order-summary-section="line-items">
        <tr
            class="nc-thankyou-product"
            data-product-id=""
            data-variant-id="<?php echo $item['product_variant_id'] ?>"
            data-product-type=""
            data-customer-ready-visible=""
        >
            <td class="nc-product__image">
                <div class="nc-product-thumbnail">
                <div class="nc-product-thumbnail__wrapper">
                    <img
                        src="<?php echo esc_url( $main_image ); ?>"
                        class="nc-product-thumbnail__image"
                        alt="<?php echo esc_attr( $item['description'] ); ?>"
                    >
                </div>
                <span class="nc-product-thumbnail__quantity" aria-hidden="true">
                    <?php echo esc_html( $item['quantity'] ); ?>
                </span>
                </div>
            </td>
            <th class="nc-product__description" scope="row">
                <span class="nc-product__description__name nc-order-summary__emphasis">
                    <?php echo esc_html( $item['description'] ); ?>
                </span>
                <span class="nc-product__description__variant nc-order-summary__small-text">
                    <?php
                    if ( $option_values_human_map ) {
                        ?>
                        <div class="nc-thankyou-variants">
                            <?php
                            foreach ( $option_values_human_map as $option_name => $option_value ) {
                                if ( preg_match( '/\.(?:jpg|jpeg|png|webp|gif|svg])$/m', $option_value ) ) {
                                    continue;
                                }

                                if( preg_match('/^#.{3,6}$/', $option_value)) {
                                    $option_value = '<span class="nc-cart-option-color" style="background-color: ' . $option_value . '"></span>';
                                } else {
                                    $option_value = esc_html( wp_unslash($option_value));
                                }
                                ?>
                                <p>
                                    <?php
                                    printf(
                                        '<strong>%s: </strong>%s',
                                        esc_html( wp_unslash( $option_name ) ),
	                                    $option_value
                                    );
                                    ?>
                                </p>
                                <?php
                            }
                            ?>
                        </div>
                        <?php
                    }
                    // TODO: ADD variations
                    ?>
                </span>
            </th>
            <td class="nc-product__quantity">
                <span class="nc-visually-hidden">
                    <?php echo esc_html( $item['quantity'] ); ?>
                </span>
            </td>
            <td class="nc-product__price">
                <span class="nc-order-summary__emphasis nc-skeleton-while-loading">
                    <?php echo North_Commerce_Settings::get_currency_symbol() . $item['amount']; ?>
                </span>
            </td>
        </tr>
    </tbody>
    <?php
}
?>
