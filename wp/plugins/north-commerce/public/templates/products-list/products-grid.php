<?php

/**
 * @since   0.1.8
 * @version 0.1.13
 */

if ( ! $products ) {
    // Bailout.
    return;
}

$template = new NorthCommerce\Template_Manager( 'public' );

foreach ( $products as $product ) {

    $product_permalink = North_Commerce_Product::get_permalink_base() . $product['slug'];

    $product_categries = '';
    if ( $product['product_categories'] ) {
        $categries = [];
        foreach ( $product['product_categories'] as $cat ) {
            $categries[] = $cat['category']['name'];
        }
        $product_categries = '<span class="description__categories">' . implode( ', ', $categries ) . '</span>';
    }

    $more_options_label = $product_options_section = '';
    if ( (bool) $product['has_product_variants'] ) {
        $product_options_count = count( $product['product_options'] );

        if ( 1 === $product_options_count ) {

            ob_start();

			$template->use( 'products-list/products-grid-options', [ 'product' => $product ] );

            $options_section = ob_get_contents();
            ob_end_clean();

            if ( $options_section ) {
                $product_options_section = '<div class="product__options">' . $options_section . '</div>';
            }

        }

        if ( 1 < $product_options_count ) {
            $more_options_label = '<span class="variants_amount">'
                . esc_html__( 'More options available', 'north-commerce' )
            . '</span>';
        }

    }

    if ( $more_options_label ) {
        $cta_button = '<a class="cta-button select-options" href="' . $product_permalink . '">'
                . '<span>'
                    . esc_html__( 'Select options', 'north-commerce' )
                . '</span>'
            . '</a>';
    } else {

        $disabled = false;
        $cta_button_label = '<span>' . esc_html__( 'Add to cart', 'north-commerce' ) . '</span>';

        if ( 1 === ( $product_options_count ?? null ) ) {

            $disabled = true;
            $cta_button_label = '<span'
                . ' data-type="cta-button-label"'
                . ' data-enabled-label="' . esc_attr__( 'Add to cart', 'north-commerce' ) . '"'
                . ' data-disabled-label="' . esc_attr__( 'Select your options', 'north-commerce' ) . '"'
                . '>'
                    . esc_html__( 'Select options', 'north-commerce' )
                . '</span>';
        }

        $cta_button = '<button class="cta-button add-to-cart" data-add-to-cart-action' . ( $disabled ? ' disabled' : '' ) . '>'
                . '<img'
                    . ' class="icon-cart"'
                    . ' src="' . NORTH_COMMERCE_PLUGIN_DIR_URL . 'public/images/products-list/icon-cart-white.png"'
                    . ' alt="cart icon"'
                    . '>'
                . $cta_button_label
            . '</button>';
    }

	?>
	<div class="product-wrapper" data-product-collection-item>
		<div
			class="product-item"
			data-type="nc-product"
			data-id="<?php echo esc_attr( $product['id'] ); ?>"
			data-timestamp="<?php echo strtotime( $product['created'] ); ?>"
        >
			<a href="<?php echo $product_permalink; ?>">
				<img
					class="product__image"
					src="<?php echo $product['product_images'][0]['image_url'] ?? NORTH_COMMERCE_PLUGIN_DIR_URL . 'public/images/product-placeholder.jpg'; ?>"
					alt="<?php echo esc_attr( $product['name'] ); ?>"
                >
			</a>
			<div class="product-inner">
				<?php echo $cta_button; ?>
			</div>
			<?php echo $product_options_section; ?>
		</div>
		<div class="product__description">
			<p class="description__name">
				<a href="<?php echo $product_permalink; ?>">
					<?php echo esc_html( $product['name'] ); ?>
				</a>
			</p>
			<h6 class="description__variants">
				<?php
				echo $product_categries;
				echo $more_options_label;
				?>
			</h6>
			<div class="description__price">
				<?php echo North_Commerce_Settings::formatted_price( $product['base_price'], false ); ?>
			</div>
		</div>
	</div>
	<?php
}