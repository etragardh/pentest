<?php
/**
 * A PHP file for rendering the Thank You page for our checkout
 */

use NorthCommerce\Db\Collections\{
	ShippingDetailTypes,
	PaymentStatuses
};
use NorthCommerce\Models\CouponModel;

$agent = North_Commerce_Db_Agent::instance();
$ae = $agent->entityAccess();

$expand = [
	'line_items.product_variant.product_variant_option_values',
	'line_items.product_variant.product_variant_option_values.product_option_value',
	'line_items.product_variant.product_variant_option_values.product_option_value.product_option',
	'shipping_details',
];

$order_id = nc_g( $_GET, 'order' );

try {
	$order = $order_id ? $ae->ref( $order_id, compact( 'expand' ) ) : false;
} catch ( Exception $e ) {
	$order = null;
}

if (
	! $order
	|| $order['payment_status_id'] !== PaymentStatuses::paid()->id
) {
	$this->use( 'thank-you/no-order' );

	// Bailout.
	return;
}

$order_total = $order
	? $order['tax'] + $order['shipping'] + $order['subtotal']
	: '';

$billing_addr = $order['billing_address_id'] ? $ae->ref( $order['billing_address_id'] ) : false;
$shipping_address = $order['shipping_address_id'] ? $ae->ref( $order['shipping_address_id'] ) : false;
$customer = $order['customer_id'] ? $ae->ref( $order['customer_id'] ) : false;
$country = $ae->get( 'countries', [ 'id' => ( $shipping_address['country_id' ] ?? null ) ] );
$payment_info = $ae->ref( $order['customer_payment_method_id'] );


$actual_shipping_details = null;
$planned_shipping_details = null;

foreach ( $order['shipping_details'] as $detail ) {
    if ( $detail['shipping_detail_type_id'] === ShippingDetailTypes::actual()->id ) {
        $actual_shipping_details = $detail;
        break;
    }
}

if ( ! $actual_shipping_details ) {
    foreach ( $order['shipping_details'] as $detail ) {
        if ( $detail['shipping_detail_type_id'] === ShippingDetailTypes::planned()->id ) {
            $planned_shipping_details = $detail;
        }
    }
}


$coupon_model = new CouponModel;
$order_coupon = $coupon_model->get_coupon_by_order_id($order_id);
$discount_val = 0;
if($order_coupon){
	switch ( $order_coupon['coupon_discount_type']['slug'] ) {
		case 'percent':
			if( empty(round($order['discount'])) && !empty($order_coupon['discount_amount'])){
				$order['discount'] = ($order['subtotal'] / 100) * $order_coupon['discount_amount'];
			}
			$discount_val = '-' . North_Commerce_Settings::formatted_price($order['discount']) . ' (' . $order_coupon['discount_amount'] . '%)';
			break;
		case 'fixed':
			$discount_val = '-' . North_Commerce_Settings::formatted_price($order['discount']) ;
			break;
		case 'free-shipping':
			$discount_val = esc_html__( 'Free shipping', 'north-commerce' );
			break;
	}
}
?>
<div class="nc-thankyou-wrapper nc-global-styles">
	<div class="nc-thankyou-main">
		<main class="nc-main__content" role="main">
			<?php $this->use( 'thank-you/overview/header' ); ?>
			<div class="nc-step">
				<div class="nc-step__sections">
					<div class="nc-section" data-order-update-optionss="[&quot;arrive&quot;]">
						<?php
						$this->use( 'thank-you/overview/order-header', compact(
							'order',
							'shipping_address'
						) );
						?>
					</div>

					<div class="nc-section">
						<div class="nc-section__content">
							<div class="nc-content-box">
								<!-- <?php $this->use( 'thank-you/overview/customer-order-map' ); ?> -->
								<?php $this->use( 'thank-you/overview/order-help-messaging' ); ?>
							</div>

							<div class="nc-content-box">
								<?php $this->use( 'thank-you/overview/customer-info-header' ); ?>
								<div class="nc-content-box__row">
									<div class="nc-section__content">
										<?php
										$this->use( 'thank-you/overview/order-shipping-address', [
											'shipping_address' => $shipping_address,
											'country_code' => $country['abbreviation'] ?? null,
											'customer_email' => $customer['email'],
											'planned_shipping_details' => $planned_shipping_details,
											'actual_shipping_details' => $actual_shipping_details
										] );
										?>
										<div class="nc-section__content__column nc-section__content__column--half">
											<?php
											$this->use( 'thank-you/overview/order-payment-info', [
												'payment_info' => $payment_info,
												'order_total' => $order['total'],
											] );

											$this->use( 'thank-you/overview/order-billing-address', [
												'billing_address' => $billing_addr,
												'country_code' => $country['abbreviation'] ?? null,
											] );
											?>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="nc-step__footer">
					<?php
					$this->use( 'thank-you/overview/footer-continue-shopping' );
					// $this->use( 'thank-you/overview/footer-store-info' )
					?>
				</div>
			</div>
		</main>
	</div>

	<aside class="nc-sidebar" role="complementary">
		<?php $this->use( 'thank-you/overview/sidebar-header' ); ?>
		<div class="nc-sidebar__content">
			<div class="nc-order-summary nc-order-summary--is-collapsed" data-order-summary="">
				<h2 class="nc-visually-hidden">
					<?php esc_html_e( 'Order summary', 'north-commerce' ); ?>
				</h2>
				<div class="nc-order-summary__sections">
					<div class="nc-order-summary__section nc-order-summary__section--product-list">
						<div class="nc-order-summary__section__content">
							<table class="nc-product-table">
								<?php $this->use( 'thank-you/overview/order-line-items', [ 'line_items' => $order['line_items'] ] ); ?>
							</table>
							<div
								class="nc-order-summary__section nc-order-summary__section--total-lines"
								data-order-summary-section="payment-lines"
							>
								<table class="nc-total-line-table">
									<tbody class="nc-total-line-table__tbody">
										<?php
										$this->use( 'thank-you/overview/order-subtotal', [ 'order_subtotal' => $order['subtotal'] ] );
										$this->use( 'thank-you/overview/order-shipping', [ 'order_shipping' => $order['shipping'] ] );
										$this->use( 'thank-you/overview/order-taxes', [ 'order_tax' => $order['tax'] ] );
										$this->use( 'thank-you/overview/order-discount', [ 'order_discount' => $discount_val ] );
										?>
									</tbody>
									<tfoot class="nc-total-line-table__footer">
										<?php $this->use( 'thank-you/overview/order-total', compact( 'order_total' ) ); ?>
									</tfoot>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</aside>
</div>
