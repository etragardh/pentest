<?php

use NorthCommerce\Db\Collections\PaymentStatuses;
use NorthCommerce\Db\PerspectiveManager;

$templates_path = NORTH_COMMERCE_PLUGIN_DIR_PATH . 'public/templates/';
$template       = new NorthCommerce\Template_Manager( 'public' );
$agent          = North_Commerce_Db_Agent::instance();
$ea             = $agent->entityAccess();
$pm             = PerspectiveManager::instance();

// Get Current Logged in User ID
$current_user_id = get_current_user_id();

// Get Customer ID from user meta when user registers with [commerce-signup] shortcode
$customer_id = get_user_meta( $current_user_id, 'north_commerce_customer_id', true );

if ( $current_user_id > 0 && ! empty( $customer_id ) ) {
	$filter = [ 'id' => $customer_id ];
	$expand = [
		'expand' => [
			'orders.order_status',
			'orders.payment_status',
			'orders.line_items.product_variant.product.product_images',
			'orders.line_items.product_variant.product_variant_option_values',
			'orders.line_items.product_variant.product_variant_option_values.product_option_value',
			'orders.line_items.product_variant.product_variant_option_values.product_option_value.product_option',
			'addresses.country'
		]
	];

	$customer;
	$customer_details;
	$customer_orders = [];
	// Retrieve customer data using administrator perspective
	$pm->asAdministrator( function () use ( $ea, $filter, $expand, &$customer, &$customer_details, &$customer_orders ) {
		$customer = $ea->get( 'customers', $filter, $expand );

		if ( isset( $customer['orders'] ) ) {
			$customer_orders = $customer['orders'];
		}

        $order_paid_id = PaymentStatuses::paid()->id;

        $customer_orders = array_filter($customer_orders, function($item) use ($order_paid_id){
            return $item['payment_status_id'] == $order_paid_id;
        });

		// Remove 'orders' key from the customer array
		$customer_details = array_diff_key( $customer, array_flip( [ 'orders' ] ) );
	} );
}

?>


<?php
if ( $customer_id ) { ?>

    <div class="nc-account nc-global-styles">
        <?php $this->use('my-account/aside') ?>
        <div class="nc-account-content">
            <?php $this->use('my-account/tabs/orders', ['orders' => $customer_orders]); ?>
            <?php $this->use('my-account/tabs/order', ['orders' => $customer_orders]); ?>
            <?php $this->use('my-account/tabs/personal-information', ['details' => $customer_details]); ?>
            <!-- <?php $this->use('my-account/tabs/change-password'); ?> -->
            <div class="nc-account-tab" data-tab="logout" style="display: none;"><?php esc_html_e( 'Logout', 'north-commerce' ); ?></div>
        </div>
    </div>
<?php } ?>

