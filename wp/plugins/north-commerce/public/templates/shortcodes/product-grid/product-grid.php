<?php

use NorthCommerce\Db\Collections\ProductStatuses;

$agent = North_Commerce_Db_Agent::instance();
$ea = $agent->entityAccess();
$filter = [ 'product_categories.category.name' => $atts['category'], 'product_status_id' => ProductStatuses::published()->id ];

$desktop_columns = $atts['desktop_columns'] ?? '3';
$mobile_columns = $atts['mobile_columns'] ?? '2';

$products = $ea->list(
    'products',
    $atts['category'] ? $filter : ['product_status_id' => ProductStatuses::published()->id],
    [ 'expand' => 'product_tags,product_images,product_options' ]
);

// presort by price DESC
usort( $products, function ( $p1, $p2 ) {
    $p1_price = floatval( $p1['base_price'] );
    $p2_price = floatval( $p2['base_price'] );

    return $p1_price === $p2_price
        ? 0
        : intval( $p1_price < $p2_price );
} );

?>
<section class="nc-grid-wrapper nc-global-styles" data-nc-product-collection-grid>

    <div class="nc-wrapper_upper">
        <?php
        $this->use(
            'shortcodes/product-grid/grid-items/product-filters',
            [ 'product_count' => count( $products ) ]
        );
        ?>
        <!-- TODO: Add product sort -->
        <?php
        $this->use( 'shortcodes/product-grid/grid-items/product-sort' );
        ?>
    </div>

    <div class="nc-wrapper-row">
        <?php
        $this->use( 'shortcodes/product-grid/grid-items/product-items', [
            'products' => $products,
            'desktop_columns' => $desktop_columns,
            'mobile_columns' => $mobile_columns,
            'badge' => $atts['badge']
        ] );
        ?>
    </div>

</section>