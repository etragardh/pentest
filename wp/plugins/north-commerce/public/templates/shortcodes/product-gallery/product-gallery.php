<?php

$agent = North_Commerce_Db_Agent::instance();
$ea = $agent->entityAccess();
$filter = [ 'product_tags.tag.slug' => $data->category ];
$products = $ea->list(
    'products',
    $data->category ? $filter : true,
    [ 'expand' => 'product_tags,product_images,product_options' ]
);

$image_placeholder = NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';

?>
<section class="nc-product-gallery-area nc-global-styles">
    <div class="nc-shoe-container">
        <div class="nc-row">
            <?php
            foreach ( $products as $p ) {
                $image_url = $p['product_images'][0]['image_url'] ?? $image_placeholder;
                ?>
                <a href="<?php echo North_Commerce_Product::get_permalink_base() .  $p['slug']; ?>">
                    <div class="nc-col-md-4 nc-col-sm-6">
                        <div class="nc-product-gallery-item">
                            <img
                                class="nc-product-gallery-thumbnail"
                                src="<?php echo esc_url( $image_url ); ?>"
                                alt=""
                            >
                </a>
                            <div class="nc-product-gallery-meta">
                                <a
                                    href="<?php echo North_Commerce_Product::get_permalink_base() . $p['slug'] ?>"
                                    class="nc-product-gallery-title"
                                >
                                    <?php echo esc_html( $p['name'] ); ?>
                                </a>
                                <h2 class="nc-product-gallery-price">
                                    <?php echo North_Commerce_Settings::get_currency_symbol() . esc_html( $p['base_price'] ); ?>
                                </h2>
                            </div>
                        </div>
                    </div>
                <?php
            }
            ?>
        </div>
    </div>
</section>
