<?php

$agent = North_Commerce_Db_Agent::instance();
$ea = $agent->entityAccess();
$filter = [ 'product_categories.category.slug' =>  $data->category ];
$products = $ea->list(
    'products',
    $data->category ? $filter : true,
    [ 'expand' => 'product_tags,product_images,product_options' ]
);

$image_placeholder = NORTH_COMMERCE_PLUGIN_DIR_URL . 'admin/images/product-empty-img.png';

?>
<section class="nc-product-slider-area">
    <div class="nc-product-slider-main">
        <div class="nc-main-carousel">
            <?php
            foreach ( $products as $p ) {
                $image_url = $p['product_images'][0]['image_url'] ?? $image_placeholder;
                ?>
                <div class="carousel-cell">
                    <a
                        href="<?php echo North_Commerce_Product::get_permalink_base() . esc_url( $p['slug'] ); ?>"
                        class="nc-product-slider-title nc-product-slider-link"
                    >
                        <div class="nc-product-slider-item">
                            <img
                                class="nc-product-carousel-item-thumbnail"
                                src="<?php echo esc_url( $image_url ); ?>"
                                alt=""
                            >
                        </div>
                    </a>

                    <div class="nc-product-slider-meta">
                        <a
                            href="<?php echo North_Commerce_Product::get_permalink_base() . $p['slug'] ?>"
                            class="nc-product-slider-title"
                        >
                            <?php echo esc_html( $p['name'] ); ?>
                        </a>
                        <p class="nc-product-slider-price">
                            <?php echo North_Commerce_Settings::get_currency_symbol() . esc_html( $p['base_price'] ); ?>
                        </p>
                    </div>
                </div>
                <?php
            }
            ?>
        </div>
    </div>
</section>
