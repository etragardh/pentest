<?php

$template = new NorthCommerce\Template_Manager( 'public' );

$settings = new North_Commerce_Settings();
$easyPostIntegration = new North_Commerce_Easypost();

$warehouse_country       = $settings->get_warehouse_country();
$shipping_service_status = true;
$countries_list          = ( new \NorthCommerce\Models\CountryModel() )->get_formated_list();
$int_phones              = get_int_phone();
$countries_subunits_map  = nc_get_countries_subunits_map();

$warehouse_country_subunits = null;
$subunits_input_type = 'select';

if ( isset( $countries_subunits_map[ $warehouse_country ] ) ) {
	$warehouse_country_subunits = $countries_subunits_map[ $warehouse_country ]['subunits'];
	$warehouse_country_name = $countries_subunits_map[ $warehouse_country ]['name']['single'];
	$subunits_input_type = 'select';
}

$phone_dial_code = '';
if ( isset( $int_phones[ $warehouse_country ] ) ) {
	$phone_dial_code = $int_phones[ $warehouse_country ]['dial_code'];
}

if ( ! function_exists( 'nc_checkout_display_shipping_rate_item' ) ) {
	function nc_checkout_display_shipping_rate_item() {
		$nc_template_loader = new North_Commerce_Template_Loader();
		$nc_template_loader->get_template_part( 'checkout/shipment-rate-item' );
	}
}

add_action( 'nc_checkout_display_shipping_rate_item', 'nc_checkout_display_shipping_rate_item', 10 );

?>
<div class="nc-checkout-step-container" data-type="address-info">
    <input
        class="nc-checkout-set-edit-input"
        id="nc-2"
        name="nc-accordion"
        type="radio"
    >
    <input
        type="hidden"
        id="list_states_by_countries"
        value="<?php echo htmlspecialchars( json_encode( $countries_subunits_map ), ENT_QUOTES, 'UTF-8' ); ?>"
    >
    <input type="hidden" id="sell_to_user_location" value="true">
    <input type="hidden" id="ship_to_user_location" value="true">

    <div class="nc-checkout-step-header">
        <p class="nc-checkout-step">02</p>
        <p class="nc-accordion-title">Shipping</p>
    </div>
    <form class="nc-checkout-step-edit">
        <div class="nc-shipping-address-edit">
            <input
                type="hidden"
                name="shipping_address_state_field_source"
                value="<?php echo is_null( $warehouse_country_subunits ) ? 'text' : 'select' ?>"
            >
            <ul class="nc-checkout-errors"></ul>
            <div class="nc-input-field__group">
                <div class="nc-input-field nc-input-field--half-m">
                    <?php
                    $template->use( 'checkout/shipping-address/country', [
                        'countries_list' => $countries_list,
                        'warehouse_country' => $warehouse_country,
                        'country_label_types' => $countries_subunits_map,
                    ] );
                    ?>
                </div>
                <div class="nc-input-field nc-input-field--half">
                    <?php $template->use( 'checkout/shipping-address/first-name' ); ?>
                </div>
                <div class="nc-input-field nc-input-field--half">
                    <?php $template->use( 'checkout/shipping-address/last-name' ); ?>
                </div>
                <div class="nc-input-field">
                    <?php
                    $template->use( 'checkout/shipping-address/phone', compact(
                        'int_phones',
                        'warehouse_country',
                        'phone_dial_code',
                    ) );
                    ?>
                </div>
            </div>
            <div class="nc-input-field nc-input-field nc-input-field--address-auto-complete">
                <?php $template->use( 'checkout/shipping-address/shipping-address-line-1' ); ?>
            </div>
            <div class="nc-input-field__group">
                <div class="nc-input-field nc-input-field--third" data-shipping-zip-code-container-selector>
                    <?php $template->use( 'checkout/shipping-address/zipcode', [] ); ?>
                </div>
                <div class="nc-input-field nc-input-field--third" data-shipping-city-container-selector>
                    <?php $template->use( 'checkout/shipping-address/city', [] ); ?>
                </div>
                <div class="nc-input-field nc-input-field--third" data-shipping-state-container-selector>
                    <?php
                    $template->use( 'checkout/shipping-address/state', compact(
                        'warehouse_country_name',
                        'warehouse_country_subunits',
                        'subunits_input_type',
                    ) );
                    ?>
                </div>
            </div>
        </div>
        <div class="nc-shipping-rates<?php echo ! $shipping_service_status ? ' nc-shipping-rates--not-active' : '' ?>">
            <input
                type="hidden"
                name="shipping_service_enabled"
                value="<?php echo $shipping_service_status ? 'enabled' : 'not_enabled'; ?>"
            >

            <div class="nc-shipping-rate-preloaders loaded">
                <div class="nc-shipping-rate-preloader">
                    <div class="nc-shipping-rate-preloader-image">
                    </div>
                    <div class="nc-shipping-rate-preloader-content">
                        <div class="nc-shipping-rate-preloader-name"></div>
                        <div class="nc-shipping-rate-preloader-price"></div>
                    </div>
                    <div class="nc-shipping-rate-preloader-select">
                        <span></span>
                    </div>
                </div>
                <div class="nc-shipping-rate-preloader">
                    <div class="nc-shipping-rate-preloader-image">
                    </div>
                    <div class="nc-shipping-rate-preloader-content">
                        <div class="nc-shipping-rate-preloader-name"></div>
                        <div class="nc-shipping-rate-preloader-price"></div>
                    </div>
                    <div class="nc-shipping-rate-preloader-select">
                        <span></span>
                    </div>
                </div>
            </div>
            <div class="nc-shipping-rates-list"></div>
        </div>

        <input
            type="checkbox"
            name="billing_address_same_as_shipping"
            id="billing-address-source-handler"
            class="billing-address-source-handler"
            value="same"
            checked
        >

        <label for="billing-address-source-handler" class="nc-add-billing-container" tabindex="0">
            <svg class="nc-add-billing-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path fill="#FF5500" d="M18 11H13V6H11V11H6L6 13H11V18H13V13H18V11Z"/>
            </svg>
            <svg class="nc-remove-billing-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path fill="#FF5500" d="M16.9497 15.5356L13.4142 12.0001L16.9497 8.46452L15.5355 7.0503L12 10.5858L8.46447 7.0503L7.05025 8.46452L10.5858 12.0001L7.05025 15.5356L8.46447 16.9498L12 13.4143L15.5355 16.9498L16.9497 15.5356Z"/>
            </svg>
            <span class="nc-add-billing-cta">
                <?php esc_html_e( 'Add different billing address', 'north-commerce' ); ?>
            </span>
            <span class="nc-remove-billing-cta">
                <?php esc_html_e( 'Remove billing address', 'north-commerce' ); ?>
            </span>
        </label>

        <div class="nc-billing-address-edit">
            <input
                type="hidden"
                name="billing_address_state_field_source"
                value="<?php echo is_null( $warehouse_country_subunits ) ? 'text' : 'select' ?>"
            >
            <div class="nc-input-field__group">
                <div class="nc-input-field nc-input-field--half-m">
                    <?php
                    $template->use( 'checkout/billing-address/country', [
                        'countries_list' => $countries_list,
                        'warehouse_country' => $warehouse_country,
                        'country_label_types' => $countries_subunits_map,
                    ] );
                    ?>
                </div>

                <div class="nc-input-field nc-input-field--half">
                    <?php $template->use( 'checkout/billing-address/first-name' ); ?>
                </div>

                <div class="nc-input-field nc-input-field--half">
                    <?php $template->use( 'checkout/billing-address/last-name' ); ?>
                </div>

                <div class="nc-input-field">
                    <?php
                    $template->use( 'checkout/billing-address/phone', compact(
                        'int_phones',
                        'warehouse_country',
                        'phone_dial_code',
                    ) );
                    ?>
                </div>
            </div>

            <div class="nc-input-field nc-input-field nc-input-field--address-auto-complete">
               <?php $template->use('checkout/billing-address/billing-address-line-1' ) ?>
            </div>
            <div class="nc-input-field__group">
                <div class="nc-input-field nc-input-field--third" data-billing-zip-code-container-selector>
                   <?php $template->use( 'checkout/billing-address/zipcode' ); ?>
                </div>

                <div class="nc-input-field nc-input-field--third" data-billing-city-container-selector>
                   <?php $template->use( 'checkout/billing-address/city' ); ?>
                </div>

                <div class="nc-input-field nc-input-field--third" data-billing-state-container-selector>
                    <?php
                    $template->use('checkout/billing-address/state', compact(
                        'warehouse_country_name',
                        'warehouse_country_subunits',
                        'subunits_input_type',
                    ) );
                    ?>
                </div>
            </div>

        </div>
        <div class="nc-customer-btn-container">
            <button type="submit" class="nc-customer-checkout-btn nc-address-info-btn">
                <?php esc_html_e( 'Save and continue', 'north-commerce' ); ?>
            </button>
        </div>
    </form>
    <div class="nc-checkout-step-view hide">
        <div class="checkout-view-field" data-type="shipping_full_name">
            <div class="checkout-view-field-icon">
                <?php $template->use( 'ui/svg/person' ); ?>
            </div>
            <div class="checkout-view-field-value">
            </div>
        </div>
        <div class="checkout-view-field" data-type="shipping_address">
            <div class="checkout-view-field-icon">
                <?php $template->use( 'ui/svg/pin' ); ?>
            </div>
            <div class="checkout-view-field-value">
            </div>
        </div>
        <div class="checkout-view-field" data-type="shipping_phone_number">
            <div class="checkout-view-field-icon">
                <?php $template->use( 'ui/svg/phone' ); ?>
            </div>
            <div class="checkout-view-field-value">
            </div>
        </div>
        <div class="checkout-view-field" data-type="rate">
            <div class="checkout-view-field-icon">
                <img src="" alt="">
            </div>
            <div class="checkout-view-field-value">
            </div>
        </div>
    </div>
    <div class="nc-checkout-set-edit-handler">
        <?php $template->use( 'ui/svg/pencil' ); ?>
    </div>
</div>

<script type="text/template" id="tmpl-checkout-state-input-text">
    <?php renderStateInput( 'text' ) ?>
</script>

<script type="text/template" id="tmpl-checkout-state-input-select">
	<?php renderStateInput( 'select' ) ?>
</script>

<script type="text/template" id="tmpl-address-autocomplete-suggestion">
    <div class="address-suggestion">
        <div class="address-suggestion-header">Suggestion</div>
        <div class="address-suggestion-body">
            <ul role="listbox" class="address-suggestion-list">
                <li id="0" class="address-suggestion-item" role="option">
                    <div data-index="0" class="address-suggestion-item__content"><span class="emphasis">23</span>315
                        Calvert Street, Woodland Hills, CA, USA
                    </div>
                </li>
            </ul>
        </div>
        <div class="address-suggestion-footer">
            <svg aria-label="Powered by Google" role="img" focusable="false" viewBox="0 0 116 15" width="116" height="15">
                <path fill="#737373" d="M4.025 3.572c1.612 0 2.655 1.283 2.655 3.27 0 1.974-1.05 3.27-2.655 3.27-.902 0-1.63-.393-1.974-1.06h-.09v3.057H.95V3.68h.96v1.054h.094c.404-.726 1.16-1.166 2.02-1.166zm-.24 5.63c1.16 0 1.852-.884 1.852-2.36 0-1.477-.692-2.362-1.846-2.362-1.14 0-1.86.91-1.86 2.362 0 1.447.72 2.36 1.857 2.36zm7.072.91c-1.798 0-2.912-1.243-2.912-3.27 0-2.033 1.114-3.27 2.912-3.27 1.8 0 2.913 1.237 2.913 3.27 0 2.027-1.114 3.27-2.913 3.27zm0-.91c1.196 0 1.87-.866 1.87-2.36 0-1.5-.674-2.362-1.87-2.362-1.195 0-1.87.862-1.87 2.362 0 1.494.675 2.36 1.87 2.36zm12.206-5.518H22.05l-1.244 5.05h-.094L19.3 3.684h-.966l-1.412 5.05h-.094l-1.242-5.05h-1.02L16.336 10h1.02l1.406-4.887h.093L20.268 10h1.025l1.77-6.316zm3.632.78c-1.008 0-1.71.737-1.787 1.856h3.48c-.023-1.12-.69-1.857-1.693-1.857zm1.664 3.9h1.005c-.305 1.085-1.277 1.747-2.66 1.747-1.752 0-2.848-1.262-2.848-3.26 0-1.987 1.113-3.276 2.847-3.276 1.705 0 2.742 1.213 2.742 3.176v.386h-4.542v.047c.053 1.248.75 2.04 1.822 2.04.815 0 1.366-.3 1.63-.857zM31.03 10h1.01V6.086c0-.89.696-1.535 1.657-1.535.2 0 .563.038.645.06V3.6c-.13-.018-.34-.03-.504-.03-.838 0-1.565.434-1.752 1.05h-.094v-.938h-.96V10zm6.915-5.537c-1.008 0-1.71.738-1.787 1.857h3.48c-.023-1.12-.69-1.857-1.693-1.857zm1.664 3.902h1.005c-.304 1.084-1.277 1.746-2.66 1.746-1.752 0-2.848-1.262-2.848-3.26 0-1.987 1.113-3.276 2.847-3.276 1.705 0 2.742 1.213 2.742 3.176v.386h-4.542v.047c.053 1.248.75 2.04 1.822 2.04.815 0 1.366-.3 1.63-.857zm5.01 1.746c-1.62 0-2.657-1.28-2.657-3.266 0-1.98 1.05-3.27 2.654-3.27.878 0 1.622.416 1.98 1.108h.087V1.177h1.008V10h-.96V8.992h-.094c-.4.703-1.15 1.12-2.02 1.12zm.232-5.63c-1.15 0-1.846.89-1.846 2.364 0 1.476.69 2.36 1.846 2.36 1.148 0 1.857-.9 1.857-2.36 0-1.447-.715-2.362-1.857-2.362zm7.875-3.115h1.024v3.123c.23-.3.507-.53.827-.688.32-.16.668-.238 1.043-.238.78 0 1.416.27 1.9.806.49.537.73 1.33.73 2.376 0 .992-.24 1.817-.72 2.473-.48.656-1.145.984-1.997.984-.476 0-.88-.114-1.207-.344-.195-.137-.404-.356-.627-.657v.8h-.97V1.363zm4.02 7.225c.284-.454.426-1.05.426-1.794 0-.66-.142-1.207-.425-1.64-.283-.434-.7-.65-1.25-.65-.48 0-.9.177-1.264.532-.36.356-.542.942-.542 1.758 0 .59.075 1.068.223 1.435.277.694.795 1.04 1.553 1.04.57 0 .998-.227 1.28-.68zM63.4 3.726h1.167c-.148.402-.478 1.32-.99 2.754-.383 1.077-.703 1.956-.96 2.635-.61 1.602-1.04 2.578-1.29 2.93-.25.35-.68.527-1.29.527-.147 0-.262-.006-.342-.017-.08-.012-.178-.034-.296-.065v-.96c.183.05.316.08.4.093.08.012.152.018.215.018.195 0 .338-.03.43-.094.092-.065.17-.144.232-.237.02-.033.09-.193.21-.48.122-.29.21-.506.264-.646l-2.32-6.457h1.196l1.68 5.11 1.694-5.11zM73.994 5.282V6.87h3.814c-.117.89-.416 1.54-.87 1.998-.557.555-1.427 1.16-2.944 1.16-2.35 0-4.184-1.882-4.184-4.217 0-2.332 1.835-4.215 4.184-4.215 1.264 0 2.192.497 2.873 1.135l1.122-1.117C77.04.697 75.77 0 73.99 0c-3.218 0-5.923 2.606-5.923 5.805 0 3.2 2.705 5.804 5.923 5.804 1.738 0 3.048-.57 4.073-1.628 1.05-1.045 1.382-2.522 1.382-3.71 0-.366-.028-.708-.087-.992h-5.37zm10.222-1.29c-2.082 0-3.78 1.574-3.78 3.748 0 2.154 1.698 3.747 3.78 3.747S87.998 9.9 87.998 7.74c0-2.174-1.7-3.748-3.782-3.748zm0 6.018c-1.14 0-2.127-.935-2.127-2.27 0-1.348.983-2.27 2.124-2.27 1.142 0 2.128.922 2.128 2.27 0 1.335-.986 2.27-2.128 2.27zm18.54-5.18h-.06c-.37-.438-1.083-.838-1.985-.838-1.88 0-3.52 1.632-3.52 3.748 0 2.102 1.64 3.747 3.52 3.747.905 0 1.618-.4 1.988-.852h.06v.523c0 1.432-.773 2.2-2.012 2.2-1.012 0-1.64-.723-1.9-1.336l-1.44.593c.414.994 1.51 2.213 3.34 2.213 1.94 0 3.58-1.135 3.58-3.902v-6.74h-1.57v.645zm-1.9 5.18c-1.144 0-2.013-.968-2.013-2.27 0-1.323.87-2.27 2.01-2.27 1.13 0 2.012.967 2.012 2.282.006 1.31-.882 2.258-2.01 2.258zM92.65 3.992c-2.084 0-3.783 1.574-3.783 3.748 0 2.154 1.7 3.747 3.782 3.747 2.08 0 3.78-1.587 3.78-3.747 0-2.174-1.7-3.748-3.78-3.748zm0 6.018c-1.143 0-2.13-.935-2.13-2.27 0-1.348.987-2.27 2.13-2.27 1.14 0 2.126.922 2.126 2.27 0 1.335-.986 2.27-2.127 2.27zM105.622.155h1.628v11.332h-1.628m6.655-1.477c-.843 0-1.44-.38-1.83-1.135l5.04-2.07-.168-.426c-.314-.84-1.274-2.39-3.227-2.39-1.94 0-3.554 1.516-3.554 3.75 0 2.1 1.595 3.745 3.736 3.745 1.725 0 2.724-1.05 3.14-1.658l-1.285-.852c-.427.62-1.01 1.032-1.854 1.032zm-.117-4.612c.668 0 1.24.342 1.427.826l-3.405 1.4c0-1.574 1.122-2.226 1.978-2.226z"></path>
            </svg>
        </div>
    </div>
</script>
<?php

do_action( 'nc_checkout_display_shipping_rate_item' );
