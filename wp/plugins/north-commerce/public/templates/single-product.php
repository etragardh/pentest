<?php
/**
 * Product Single template.
 *
 * Defines the default view for the single product and registers
 * action hooks related to product display.
 *
 * @package north-commerce/public/templates
 * @author  North Commerce <hello@northplugins.com>
 * @link    https://northcommerce.com
 * @since   0.1.3
 * @version 0.1.25
 */

global $single_product;

$product_model =  new \NorthCommerce\Models\ProductModel();
$single_product = $product_model->get_by_slug( $product_slug, [
	'expand' => [
		'product_type',
		'product_status',
		'payment_detail.payment_frequency',
		'payment_detail.free_trial_type',
		'product_images',
		'customs_detail',
		'product_options',
		'product_options.product_option_type',
		'product_options.product_option_values',
		'product_categories.category',
		'product_tags',
		'product_attribute_values',
	]
]);

if ( ! $single_product ) {
	// Bailout.
	return;
}

$solo_product_variant = $product_model->get_solo_product_variant_by_product_id( $single_product['id'] );

$sections = array_filter([
	'title', 'meta', 'price', 'quantity',
	$single_product['has_product_variants'] ? 'options' : '',
	'add-to-cart', 'description'
]);

?>
<div class="nc-container nc-global-styles"
	data-type="product-overview"
	data-product-id="<?php echo $single_product['id']; ?>"
	data-product-type="<?php echo $single_product['product_type']['slug']; ?>"
	data-product-quantity-max="<?php echo is_null( $single_product['quantity'] ) ? 'null' : $single_product['quantity']; ?>"
	data-product-price="<?php echo $single_product['base_price']; ?>"
	data-product-variant-id="<?php echo $solo_product_variant ? $solo_product_variant['id'] : '' ?>"
	data-product-variant-quantity-max="<?php echo $solo_product_variant ? $solo_product_variant['quantity'] : ''; ?>"
	data-product-variant-price="<?php echo $solo_product_variant ? $solo_product_variant['price'] : ''; ?>"
	data-quantity-max="<?php echo is_null( $single_product['quantity'] ) ? 'null' : $single_product['quantity']; ?>"
	data-price="<?php echo $single_product['base_price']; ?>"
	data-product-form-type="product-overview"
>
    <?php $this->use( 'product/gallery', [ 'data' => $single_product ] ); ?>

    <div class="nc-main">
        <div class="nc-meta-container">
            <?php
			foreach ( $sections as $s ) {
				$this->use( "product/$s", [ 'product' => $single_product ] );
			}
			?>
        </div>
    </div>
</div>
